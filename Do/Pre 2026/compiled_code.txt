================================================================================
 FILE: H2A Analysis Figs and Tables.R
================================================================================

## H2A: Analysis Figures and Tables
## Phil Hoxie
## 1/31/24

library(sf)
library(tidyverse)
library(USAboundaries)
library(ggspatial)
library(scales)
library(cowplot)
library(ggthemes)
library(fixest)

Sys.sleep(1)

set.seed(12345)

date <- paste0(substr(Sys.Date(), 1, 4), substr(Sys.Date(), 6, 7),  substr(Sys.Date(), 9, 10))

## County DDD Design -----------------------------------------------------------

county_df <- readRDS(paste0(folder_data, "county_df_analysis_year.rds"))

names(county_df)
# DiffinDiff by group 

# count 75

# high

fixest_model_dd_high <- feols(nbr_workers_requested_start_year ~ aewr_ppi * postdummy | county_fe + year_fe, 
                              data = subset(county_df, high_h2a_count_75 == 1), vcov = ~countyfips)

fixest_model_dd_high$coeftable # matches stata
fixest_model_dd_high$nobs

# low

fixest_model_dd_low <- feols(nbr_workers_requested_start_year ~ aewr_ppi * postdummy | county_fe + year_fe, 
                              data = subset(county_df, high_h2a_count_75 == 0), vcov = ~countyfips)

fixest_model_dd_low$coeftable # matches stata
fixest_model_dd_low$nobs

# count 66

# high

fixest_model_dd_high <- feols(nbr_workers_requested_start_year ~ aewr_ppi * postdummy | county_fe + year_fe, 
                              data = subset(county_df, high_h2a_count_66 == 1), vcov = ~countyfips)

fixest_model_dd_high$coeftable # matches stata
fixest_model_dd_high$nobs

# low

fixest_model_dd_low <- feols(nbr_workers_requested_start_year ~ aewr_ppi * postdummy | county_fe + year_fe, 
                             data = subset(county_df, high_h2a_count_66 == 0), vcov = ~countyfips)

fixest_model_dd_low$coeftable # matches stata
fixest_model_dd_low$nobs

# count 50

# high

fixest_model_dd_high <- feols(nbr_workers_requested_start_year ~ aewr_ppi_l1 * postdummy | county_fe + year_fe, 
                              data = subset(county_df, high_h2a_count_50 == 1), vcov = ~countyfips)

fixest_model_dd_high$coeftable # matches stata
fixest_model_dd_high$nobs

# low

fixest_model_dd_low <- feols(nbr_workers_requested_start_year ~ aewr_ppi_l1 * postdummy | county_fe + year_fe, 
                             data = subset(county_df, high_h2a_count_50 == 0), vcov = ~countyfips)

fixest_model_dd_low$coeftable # matches stata
fixest_model_dd_low$nobs


# DDD (simple)

fixest_model_ddd_simple <- feols(nbr_workers_requested_start_year ~ aewr * postdummy * high_h2a_share_75 + ln_pop_census + emp_pop_ratio | county_fe + year_fe, 
                             data = subset(county_df, any_cropland_2007 == 1), vcov = ~countyfips)

fixest_model_ddd_simple$coeftable # matches stata
fixest_model_ddd_simple$nobs

fixest_model_ddd_simple <- feols(nbr_workers_requested_start_year ~ 
                                   aewr * yeardummy_2008 * high_h2a_share_75 + 
                                   aewr * yeardummy_2009 * high_h2a_share_75 + 
                                   aewr * yeardummy_2010 * high_h2a_share_75 + 
                                   aewr * yeardummy_2011 * high_h2a_share_75 + 
                                   aewr * yeardummy_2013 * high_h2a_share_75 +
                                   aewr * yeardummy_2014 * high_h2a_share_75 + 
                                   aewr * yeardummy_2015 * high_h2a_share_75 +
                                   aewr * yeardummy_2016 * high_h2a_share_75 +
                                   aewr * yeardummy_2017 * high_h2a_share_75 +
                                   aewr * yeardummy_2018 * high_h2a_share_75 +
                                   aewr * yeardummy_2019 * high_h2a_share_75 +
                                   aewr * yeardummy_2020 * high_h2a_share_75 +
                                   aewr * yeardummy_2021 * high_h2a_share_75 +
                                   aewr * yeardummy_2022 * high_h2a_share_75 + 
                                   ln_pop_census + emp_pop_ratio | county_fe + year_fe, 
                                 data = subset(county_df, any_cropland_2007 == 1), vcov = ~countyfips)

fixest_model_ddd_simple$coeftable # matches stata
fixest_model_ddd_simple$nobs

wald(fixest_model_ddd_simple, keep = c("aewr:high_h2a_share_75:yeardummy_2013",
                                       "aewr:high_h2a_share_75:yeardummy_2014",
                                       "aewr:high_h2a_share_75:yeardummy_2015",
                                       "aewr:high_h2a_share_75:yeardummy_2016",
                                       "aewr:high_h2a_share_75:yeardummy_2017",
                                       "aewr:high_h2a_share_75:yeardummy_2018",
                                       "aewr:high_h2a_share_75:yeardummy_2019",
                                       "aewr:high_h2a_share_75:yeardummy_2020",
                                       "aewr:high_h2a_share_75:yeardummy_2021",
                                       "aewr:high_h2a_share_75:yeardummy_2022"), vcov = ~countyfips)

# graph it 

coeff_df <- data.frame(year = c(2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022),
                       beta = c(fixest_model_ddd_simple$coeftable[33, 1], 
                                fixest_model_ddd_simple$coeftable[34, 1], 
                                fixest_model_ddd_simple$coeftable[35, 1], 
                                fixest_model_ddd_simple$coeftable[36, 1],
                                0,
                                fixest_model_ddd_simple$coeftable[37, 1],
                                fixest_model_ddd_simple$coeftable[38, 1],
                                fixest_model_ddd_simple$coeftable[39, 1],
                                fixest_model_ddd_simple$coeftable[40, 1],
                                fixest_model_ddd_simple$coeftable[41, 1],
                                fixest_model_ddd_simple$coeftable[42, 1],
                                fixest_model_ddd_simple$coeftable[43, 1],
                                fixest_model_ddd_simple$coeftable[44, 1],
                                fixest_model_ddd_simple$coeftable[45, 1],
                                fixest_model_ddd_simple$coeftable[46, 1]),
                       se = c(fixest_model_ddd_simple$coeftable[33, 2], 
                              fixest_model_ddd_simple$coeftable[34, 2], 
                              fixest_model_ddd_simple$coeftable[35, 2], 
                              fixest_model_ddd_simple$coeftable[36, 2],
                              0,
                              fixest_model_ddd_simple$coeftable[37, 2],
                              fixest_model_ddd_simple$coeftable[38, 2],
                              fixest_model_ddd_simple$coeftable[39, 2],
                              fixest_model_ddd_simple$coeftable[40, 2],
                              fixest_model_ddd_simple$coeftable[41, 2],
                              fixest_model_ddd_simple$coeftable[42, 2],
                              fixest_model_ddd_simple$coeftable[43, 2],
                              fixest_model_ddd_simple$coeftable[44, 2],
                              fixest_model_ddd_simple$coeftable[45, 2],
                              fixest_model_ddd_simple$coeftable[46, 2])) 


coeff_df <- coeff_df %>% 
  mutate(upper_ci = beta + se * 1.96,
         lower_ci = beta - se * 1.96)

coefplot <- ggplot(data = coeff_df, aes(x = year))+
  geom_line(aes(y = beta), lwd = 1.5)+
  geom_line(aes(y = upper_ci), linetype = "dashed")+
  geom_line(aes(y = lower_ci), linetype = "dashed")+
  geom_vline(xintercept = 2012)+
  geom_hline(yintercept = 0)+
  theme_classic()
coefplot

ggsave(coefplot, filename = paste0(folder_output, "coefplot_ddd_high_h2a_share_75.png"), device = "png")

## within CZ design ------------------------------------------------------------

fixest_model_czdesign  <- feols(nbr_workers_requested_start_year ~ aewr_ppi_l2 + emp_farm | county_fe + cztime_fe,
                                   data = subset(county_df, border_cz == 1))

fixest_model_czdesign$coeftable # matches stata
fixest_model_czdesign$nobs

county_df %>% group_by(border_cz) %>% tally()

fixest_model_czdesign  <- feols(nbr_workers_requested_start_year ~ aewr_ppi_l2 * yeardummy_2008 + aewr_ppi_l2 * yeardummy_2009 + aewr_ppi_l2 * yeardummy_2010 + aewr_ppi_l2 * yeardummy_2011 + aewr_ppi_l2 * yeardummy_2013 + aewr_ppi_l2 * yeardummy_2014 + aewr_ppi_l2 * yeardummy_2015 + aewr_ppi_l2 * yeardummy_2016 + aewr_ppi_l2 * yeardummy_2017 + aewr_ppi_l2 * yeardummy_2018 + aewr_ppi_l2 * yeardummy_2019 + aewr_ppi_l2 * yeardummy_2020 + aewr_ppi_l2 * yeardummy_2021 + aewr_ppi_l2 * yeardummy_2022 + emp_farm | county_fe + cztime_fe,
                                data = subset(county_df, border_cz == 1))

fixest_model_czdesign$coeftable # matches stata
fixest_model_czdesign$nobs

fixest_model_czdesign  <- feols(nbr_workers_requested_start_year ~ aewr_ppi_l1 * yeardummy_2008 + aewr_ppi_l1 * yeardummy_2009 + aewr_ppi_l1 * yeardummy_2010 + aewr_ppi_l1 * yeardummy_2011 + aewr_ppi_l1 * yeardummy_2013 + aewr_ppi_l1 * yeardummy_2014 + aewr_ppi_l1 * yeardummy_2015 + aewr_ppi_l1 * yeardummy_2016 + aewr_ppi_l1 * yeardummy_2017 + aewr_ppi_l1 * yeardummy_2018 + aewr_ppi_l1 * yeardummy_2019 + aewr_ppi_l1 * yeardummy_2020 + aewr_ppi_l1 * yeardummy_2021 + aewr_ppi_l1 * yeardummy_2022 + emp_farm | county_fe + cztime_fe,
                                data = subset(county_df, border_cz == 1))

fixest_model_czdesign$coeftable # matches stata
fixest_model_czdesign$nobs

county_df %>% group_by(border_cz) %>% tally()

## border pair design ----------------------------------------------------------

border_df <- readRDS(paste0(folder_data, "border_df_analysis.rds"))
aewr_data <- readRDS(paste0(folder_data, "aewr_data.rds"))
h2a_data_ts <- readRDS(paste0(folder_data, "h2a_data_ts.rds"))
h2a_data <- readRDS(paste0(folder_data, "h2a_data.rds"))

border_df_yearly <- readRDS(paste0(folder_data, "border_df_analysis_year.rds"))
aewr_data_full <- readRDS(paste0(folder_data, "aewr_data_full.rds"))
# colors: https://colorbrewer2.org/?type=diverging&scheme=RdBu&n=8
# ['#b2182b','#d6604d','#f4a582','#fddbc7','#d1e5f0','#92c5de','#4393c3','#2166ac']  

# "#b2182b", "#d6604d", "#f4a582", "#fddbc7", "#d1e5f0", "#92c5de", "#4393c3", "#2166ac", "#b2182b", "#d6604d", "#f4a582", "#fddbc7", "#d1e5f0", "#92c5de", "#4393c3", "#2166ac", "#d1e5f0" 


aewr_data_full_ts <- aewr_data_full %>% 
  group_by(year) %>% 
  summarise(aewr = mean(aewr, na.rm = T), 
            aewr_ppi = mean(aewr_ppi, na.rm = T))

aewr_ts <- ggplot(data = aewr_data_full_ts, aes(x = year, y = aewr_ppi))+
  geom_line(linewidth = 1.25, color = "#2166ac")+
  theme_clean()+
  xlab("Year")+
  ylab("Real AEWR")+
  geom_vline(xintercept = 2012, linetype = "dashed")
aewr_ts
ggsave(filename = paste0(folder_output, "ts_national_aewr_real.png"), aewr_ts, device = "png")

## Sample Map ------------------------------------------------------------------

county_map <- us_counties(map_date = NULL, resolution = "low")
class(county_map)

head(county_map$statefp)

county_map$state_fip <- as.numeric(county_map$statefp)

head(county_map$state_fip)

county_map <- county_map %>% 
  filter(state_fip <= 56 & state_fip != 2 & state_fip != 15)

ggplot(county_map) +
  geom_sf()

county_map$countyfips <- as.numeric(str_c(county_map$statefp, county_map$countyfp))

head(county_map$countyfips)

border_df_merge <- border_df %>% 
  filter(census_period == 2012 & aewr_border_sample == 1) %>% 
  select(countyfips, aewr_region_num, aewr_border_side, border_side)

county_map_data <- merge(x = county_map, y = border_df_merge, by = "countyfips", all.x = T, all.y = F)

rm(border_df_merge)

samp_map <- ggplot(county_map_data) +
  geom_sf(aes(fill = as.factor(aewr_region_num)))+
  theme(panel.grid.major = element_line(color = gray(0.5), linetype = "dashed", 
                                        size = 0.5), panel.background = element_rect(fill = "aliceblue"))+
  theme_bw()+
  scale_fill_manual(values = c("#b2182b", "#d6604d", "#f4a582", "#fddbc7", "#d1e5f0", "#92c5de", "#4393c3", "#2166ac", "#b2182b", "#d6604d", "#f4a582", "#fddbc7", "#d1e5f0", "#92c5de", "#4393c3", "#2166ac", "#d1e5f0" ),
                    na.value = "#E5E4E2")+
  annotation_north_arrow(location = "bl", which_north = "true", 
                         pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
                         style = north_arrow_fancy_orienteering)+
  annotation_scale(location = "bl", width_hint = 0.4) +
  theme(legend.position = "none")
samp_map

ggsave(filename = paste0(folder_output, "map_aewr_sample.png"), samp_map, device = "png")


border_df_merge <- border_df %>% 
  filter(census_period == 2012 & aewr_border_sample == 1 & no_cropland_2007_pair != 1) %>% 
  select(countyfips, aewr_region_num, aewr_border_side)

county_map_data_drop <- merge(x = county_map, y = border_df_merge, by = "countyfips", all.x = T, all.y = F)

samp_map_drop <- ggplot(county_map_data_drop) +
  geom_sf(aes(fill = as.factor(aewr_region_num)))+
  theme(panel.grid.major = element_line(color = gray(0.5), linetype = "dashed", 
                                        size = 0.5), panel.background = element_rect(fill = "aliceblue"))+
  theme_bw()+
  scale_fill_manual(values = c("#b2182b", "#d6604d", "#f4a582", "#fddbc7", "#d1e5f0", "#92c5de", "#4393c3", "#2166ac", "#b2182b", "#d6604d", "#f4a582", "#fddbc7", "#d1e5f0", "#92c5de", "#4393c3", "#2166ac", "#d1e5f0" ),
                    na.value = "#E5E4E2")+
  annotation_north_arrow(location = "bl", which_north = "true", 
                         pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
                         style = north_arrow_fancy_orienteering)+
  annotation_scale(location = "bl", width_hint = 0.4) +
  theme(legend.position = "none")
samp_map_drop

ggsave(filename = paste0(folder_output, "map_aewr_sample_dropnocropland.png"), samp_map, device = "png")

## H2A Use Map ---------------------------------------------------------------


head(county_map)

h2a_map_data <- NULL

h2a_map_data_2012 <- h2a_data %>% 
  filter(census_period == 2012) %>% 
  mutate(ln_h2a_workers_req_2012 = log(nbr_workers_requested_start_year)) %>% 
  select(countyfips, ln_h2a_workers_req_2012)

h2a_map_data_2017 <- h2a_data %>% 
  filter(census_period == 2017) %>% 
  mutate(ln_h2a_workers_req_2017 = log(nbr_workers_requested_start_year)) %>% 
  select(countyfips, ln_h2a_workers_req_2017)

h2a_map_data_2022 <- h2a_data %>% 
  filter(census_period == 2022) %>% 
  mutate(ln_h2a_workers_req_2022 = log(nbr_workers_requested_start_year)) %>% 
  select(countyfips, ln_h2a_workers_req_2022)

h2a_map_data <- merge(x = h2a_map_data_2012, y = h2a_map_data_2017, by = "countyfips")
h2a_map_data <- merge(x = h2a_map_data, y = h2a_map_data_2022, by = "countyfips")

county_map_fips <- county_map %>% 
  mutate(countyfips = as.numeric(geoid))

h2a_map_data <- merge(x = county_map_fips, y = h2a_map_data, by = "countyfips", all.x = T, all.y = F)

# 2012

h2a_map_data_2012 <- ggplot(h2a_map_data) +
  geom_sf(aes(fill = ln_h2a_workers_req_2012), color=alpha("grey",0.5))+
  theme(panel.grid.major = element_line(color = gray(0.5), linetype = "dashed", 
                                        size = 0.5), panel.background = element_rect(fill = "aliceblue"))+
  theme_bw()+
  annotation_north_arrow(location = "bl", which_north = "true", 
                         pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
                         style = north_arrow_fancy_orienteering)+
  annotation_scale(location = "bl", width_hint = 0.4) +
  scale_fill_gradient2(
    low = muted("#2166ac"),
    mid = "white",
    midpoint = 5, 
    high = muted("#b2182b"),
    name = "H-2A Workers\nRequested (log)"
  )
h2a_map_data_2012

ggsave(filename = paste0(folder_output, "map_H2A_workers_2012.png"), h2a_map_data_2012, device = "png")


# 2017


h2a_map_data_2017 <- ggplot(h2a_map_data) +
  geom_sf(aes(fill = ln_h2a_workers_req_2017), color=alpha("grey",0.5))+
  theme(panel.grid.major = element_line(color = gray(0.5), linetype = "dashed", 
                                        size = 0.5), panel.background = element_rect(fill = "aliceblue"))+
  theme_bw()+
  annotation_north_arrow(location = "bl", which_north = "true", 
                         pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
                         style = north_arrow_fancy_orienteering)+
  annotation_scale(location = "bl", width_hint = 0.4) +
  scale_fill_gradient2(
    low = muted("#2166ac"),
    mid = "white",
    midpoint = 5, 
    high = muted("#b2182b"),
    name = "H-2A Workers\nRequested (log)"
  )
h2a_map_data_2017

ggsave(filename = paste0(folder_output, "map_H2A_workers_2017.png"), h2a_map_data_2017, device = "png")


# 2022


h2a_map_data_2022 <- ggplot(h2a_map_data) +
  geom_sf(aes(fill = ln_h2a_workers_req_2022), color=alpha("grey",0.5))+
  theme(panel.grid.major = element_line(color = gray(0.5), linetype = "dashed", 
                                        size = 0.5), panel.background = element_rect(fill = "aliceblue"))+
  theme_bw()+
  annotation_north_arrow(location = "bl", which_north = "true", 
                         pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
                         style = north_arrow_fancy_orienteering)+
  annotation_scale(location = "bl", width_hint = 0.4) +
  scale_fill_gradient2(
    low = muted("#2166ac"),
    mid = "white",
    midpoint = 5, 
    high = muted("#b2182b"),
    name = "H-2A Workers\nRequested (log)"
  )
h2a_map_data_2022

ggsave(filename = paste0(folder_output, "map_H2A_workers_2022.png"), h2a_map_data_2022, device = "png")



## AEWR Heat Map ---------------------------------------------------------------

head(county_map)

aewr_map_data <- NULL

aewr_map_data_2007 <- aewr_data %>% 
    filter(census_period == 2007) %>% 
    rename(aewr_2007 = aewr, 
           aewr_ppi_2007 = aewr_ppi) %>% 
    select(-census_period)

aewr_map_data_2012 <- aewr_data %>% 
  filter(census_period == 2012) %>% 
  rename(aewr_2012 = aewr, 
         aewr_ppi_2012 = aewr_ppi) %>% 
  select(-census_period)

aewr_map_data_2017 <- aewr_data %>% 
  filter(census_period == 2017) %>% 
  rename(aewr_2017 = aewr, 
         aewr_ppi_2017 = aewr_ppi) %>% 
  select(-census_period)

aewr_map_data_2022 <- aewr_data %>% 
  filter(census_period == 2022) %>% 
  rename(aewr_2022 = aewr, 
         aewr_ppi_2022 = aewr_ppi) %>% 
  select(-census_period)

aewr_map_data <- merge(x = aewr_map_data_2007, y = aewr_map_data_2012, by = "state_abbrev")
aewr_map_data <- merge(x = aewr_map_data, y = aewr_map_data_2017, by = "state_abbrev")
aewr_map_data <- merge(x = aewr_map_data, y = aewr_map_data_2022, by = "state_abbrev")

aewr_map_data <- merge(x = county_map, y = aewr_map_data, by.x = "state_abbr", by.y = "state_abbrev", all.x = T, all.y = F)

hist(aewr_data$aewr_ppi)

min(aewr_data$aewr_ppi)
max(aewr_data$aewr_ppi)

hist(aewr_map_data$aewr_ppi_2007)

midpnt <- 13.5

aewr_map_2007 <- ggplot(aewr_map_data) +
  geom_sf(aes(fill = aewr_ppi_2007), color=alpha("grey",0.5))+
  theme(panel.grid.major = element_line(color = gray(0.5), linetype = "dashed", 
                                        size = 0.5), panel.background = element_rect(fill = "aliceblue"))+
  theme_bw()+
  annotation_north_arrow(location = "bl", which_north = "true", 
                         pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
                         style = north_arrow_fancy_orienteering)+
  annotation_scale(location = "bl", width_hint = 0.4) +
  scale_fill_gradient2(
    low = muted("#2166ac"),
    mid = "white",
    high = muted("#b2182b"),
    midpoint = midpnt,
    name = "Real\nAEWR",
    limits = c(min(aewr_data$aewr_ppi), max(aewr_data$aewr_ppi))
  )
aewr_map_2007

ggsave(filename = paste0(folder_output, "map_aewr_values_ppi_2007.png"), aewr_map_2007, device = "png")

hist(aewr_map_data$aewr_ppi_2012)

aewr_map_2012 <- ggplot(aewr_map_data) +
  geom_sf(aes(fill = aewr_ppi_2012), color=alpha("grey",0.5))+
  theme(panel.grid.major = element_line(color = gray(0.5), linetype = "dashed", 
                                        size = 0.5), panel.background = element_rect(fill = "aliceblue"))+
  theme_bw()+
  annotation_north_arrow(location = "bl", which_north = "true", 
                         pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
                         style = north_arrow_fancy_orienteering)+
  annotation_scale(location = "bl", width_hint = 0.4) +
  scale_fill_gradient2(
    low = muted("#2166ac"),
    mid = "white",
    high = muted("#b2182b"),
    midpoint = midpnt,
    name = "Real\nAEWR",
    limits = c(min(aewr_data$aewr_ppi), max(aewr_data$aewr_ppi))
  )
aewr_map_2012

ggsave(filename = paste0(folder_output, "map_aewr_values_ppi_2012.png"), aewr_map_2012, device = "png")

hist(aewr_map_data$aewr_ppi_2017)

aewr_map_2017 <- ggplot(aewr_map_data) +
  geom_sf(aes(fill = aewr_ppi_2017), color=alpha("grey",0.5))+
  theme(panel.grid.major = element_line(color = gray(0.5), linetype = "dashed", 
                                        size = 0.5), panel.background = element_rect(fill = "aliceblue"))+
  theme_bw()+
  annotation_north_arrow(location = "bl", which_north = "true", 
                         pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
                         style = north_arrow_fancy_orienteering)+
  annotation_scale(location = "bl", width_hint = 0.4) +
  scale_fill_gradient2(
    low = muted("#2166ac"),
    mid = "white",
    high = muted("#b2182b"),
    midpoint = midpnt,
    name = "Real\nAEWR",
    limits = c(min(aewr_data$aewr_ppi), max(aewr_data$aewr_ppi))
  )
aewr_map_2017

ggsave(filename = paste0(folder_output, "map_aewr_values_ppi_2017.png"), aewr_map_2017, device = "png")

hist(aewr_map_data$aewr_ppi_2022)

aewr_map_2022 <- ggplot(aewr_map_data) +
  geom_sf(aes(fill = aewr_ppi_2022), color=alpha("grey",0.5))+
  theme(panel.grid.major = element_line(color = gray(0.5), linetype = "dashed", 
                                        size = 0.5), panel.background = element_rect(fill = "aliceblue"))+
  theme_bw()+
  annotation_north_arrow(location = "bl", which_north = "true", 
                         pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
                         style = north_arrow_fancy_orienteering)+
  annotation_scale(location = "bl", width_hint = 0.4) +
  scale_fill_gradient2(
    low = muted("#2166ac"),
    mid = "white",
    high = muted("#b2182b"),
    midpoint = midpnt,
    name = "Real\nAEWR",
    limits = c(min(aewr_data$aewr_ppi), max(aewr_data$aewr_ppi))
  )
aewr_map_2022

ggsave(filename = paste0(folder_output, "map_aewr_values_ppi_2022.png"), aewr_map_2022, device = "png")

## Ag Emp Share Fig ------------------------------------------------------------

# later

## H2A Use over time fig -------------------------------------------------------

# levels 


h2a_ts <- ggplot(data = subset(h2a_data_ts, case_year > 2007 & case_year <= 2022), aes(x = case_year))+
  geom_line(aes(y = h2a_nbr_workers_certified), color = "#4393c3", linewidth = 1.5)+
  theme_clean()+
  xlab("Year")+
  ylab("H-2A Workers Certified (Thousands)")+
  scale_y_continuous(breaks = c(100000, 1500000, 200000, 250000, 300000, 350000), labels = c("100", "150", "200", "250", "300", "350"))
h2a_ts

# indexed 

base_workers <- h2a_data_ts$h2a_nbr_workers_certified[ h2a_data_ts$case_year == 2012]
base_hours <- h2a_data_ts$h2a_man_hours_certified[ h2a_data_ts$case_year == 2012]
base_aps <- h2a_data_ts$n_applications[ h2a_data_ts$case_year == 2012]

h2a_data_ts_index <- h2a_data_ts %>% 
  mutate(indx_workers_certified = (h2a_nbr_workers_certified / base_workers[1]) * 100,
        indx_man_hours_certified = (h2a_man_hours_certified / base_hours[1]) * 100,
        indx_applications = (n_applications / base_aps[1]) * 100)

h2a_data_ts_index <- h2a_data_ts_index %>% 
  select(case_year, indx_workers_certified, indx_man_hours_certified, indx_applications)

h2a_data_ts_index <- h2a_data_ts_index %>% 
  pivot_longer(cols = starts_with("indx_"), names_to = "series", names_prefix = "indx_", values_to = "indx", values_drop_na = F)
head(h2a_data_ts_index)

h2a_indx_ts <- ggplot(data = subset(h2a_data_ts_index, case_year > 2007 & case_year <= 2022), aes(x = case_year, y = indx, group = series, color = series, linetype = series))+
  geom_line(linewidth = 1.25)+
  theme_clean()+
  scale_color_manual(values = c("#b2182b", "#2166ac", "#4393c3"), labels = c("Applications", "Man Hours Certified", "Workers Certified"))+
  scale_linetype_manual(values = c("solid", "longdash", "dotted"), labels = c("Applications", "Man Hours Certified", "Workers Certified"))+
  theme(legend.title = element_blank(), legend.position = "bottom")+
  xlab("Year")+
  ylab("Indexed Values (2012 = 100)")+
  geom_hline(yintercept = 100, linetype = "dashed")
h2a_indx_ts

ggsave(filename = paste0(folder_output, "fig_line_ts_h2a_workers_certified.png"), h2a_ts, device = "png")
ggsave(filename = paste0(folder_output, "fig_line_ts_h2a_indexes.png"), h2a_indx_ts, device = "png")


## Balance ---------------------------------------------------------------------

## First Stage Regression ------------------------------------------------------

## TSCB First Stage Regression -------------------------------------------------

# try with fixest 

aewr_border_df_drop <- border_df %>%
  filter(aewr_border_sample == 1 & no_cropland_2007_pair != 1 & census_period > 2007)

aewr_border_df <- border_df %>%
  filter(aewr_border_sample == 1 & census_period > 2007) # can't use 2007 data for h2A

dim(aewr_border_df_drop)
dim(aewr_border_df)

aewr_border_df %>% group_by(aewr_border_side) %>% tally()

aewr_border_df %>% group_by(census_period) %>% tally()

aewr_border_df %>% filter(is.na(emp_pop_ratio)) %>% select(countyfips, census_period)
# 51520, bristol city virginia, all urban, so drop it. 

pairs <- str_detect(unique(aewr_border_df$pair_id), "51520") 

which(pairs == T)

unique(aewr_border_df$pair_id)[which(pairs == T)]

dim(aewr_border_df)

aewr_border_df <- aewr_border_df %>% 
  filter(pair_id != unique(aewr_border_df$pair_id)[which(pairs == T)])


# 
# aewr_border_df %>% 
#   group_by(census_period) %>% 
#   tally()

# aewr_border_df_diagnose <- aewr_border_df %>% 
#   select( countyname, census_period, countyfips, fipsneighbor, neighbor_abbrev, state_abbrev, pair_id,  aewr_region_num, aewr_region_num_neighbor, aewr_region_border_id, pair_fe, pairtime_fe, county_fe, county_unique_fe, border_pair, aewr_ppi, ln_pop_census , h2a_nbr_workers_requested)

# out vars: h2a_man_hours_requested, h2a_nbr_workers_requested, n_applications

names(aewr_border_df)

aewr_border_df %>% 
  group_by(census_period) %>% 
  tally()

fixest_model_v2_cluster  <- feols(ln1_nbr_workers_requested_all_years ~ ln_aewr_ppi,
                                  vcov = ~aewr_region_border_id, data = aewr_border_df)

fixest_model_v2_cluster$coeftable # matches stata
fixest_model_v2_cluster$nobs

fixest_model_v2_cluster  <- feols(ln1_nbr_workers_requested_all_years ~ ln_aewr  | county_unique_fe + pairtime_fe,
                          vcov = ~aewr_region_border_id, data = aewr_border_df)

fixest_model_v2_cluster$coeftable # matches stata
fixest_model_v2_cluster$nobs

fixest_model_v2_cluster  <- feols(h2a_req_share_farm_workers_start_year ~ ln_aewr_ppi + share_undoc_prime + emp_pop_ratio  ,
                                  vcov = ~aewr_region_border_id, data = aewr_border_df)

fixest_model_v2_cluster$coeftable # matches stata
fixest_model_v2_cluster$nobs



fixest_model_v2_cluster  <- feols(ln1_nbr_workers_requested_all_years ~ ln_aewr  + share_undoc_prime + emp_pop_ratio  | county_unique_fe + census_period_fe,
                                  vcov = ~aewr_region_border_id, data = aewr_border_df)

fixest_model_v2_cluster$coeftable # matches stata
fixest_model_v2_cluster$nobs

fixest_model_v2_cluster  <- feols(ln1_nbr_workers_requested_all_years ~ ln_aewr_ppi  | county_unique_fe + pairtime_fe + state_fe,
                                  vcov = ~aewr_region_border_id, data = aewr_border_df)

fixest_model_v2_cluster$coeftable # matches stata
fixest_model_v2_cluster$nobs

## Yearly Regression ----------------------------------------------------------

# try with fixest 

aewr_border_df_drop_yearly <- border_df_yearly %>%
  filter(aewr_border_sample == 1 & no_cropland_2007_pair != 1)

aewr_border_df_yearly <- border_df_yearly %>%
  filter(aewr_border_sample == 1) # can't use 2007 data for h2A

dim(aewr_border_df_drop_yearly)
dim(aewr_border_df_yearly)

pairs <- str_detect(unique(aewr_border_df_yearly$pair_id), "51520") 

which(pairs == T)

unique(aewr_border_df_yearly$pair_id)[which(pairs == T)]

dim(aewr_border_df_yearly)

aewr_border_df_yearly <- aewr_border_df_yearly %>% 
  filter(pair_id != unique(aewr_border_df_yearly$pair_id)[which(pairs == T)])

fixest_model_v2_cluster  <- feols(ln1_nbr_workers_requested_start_years ~   ln_aewr_l2  | county_unique_fe + pairtime_fe,
                                  vcov = twoway ~ aewr_region_border_id + aewr_region_num , data = aewr_border_df_yearly)

fixest_model_v2_cluster$coeftable # matches stata
fixest_model_v2_cluster$nobs

fixest_model_v2_cluster  <- feols(ln1_nbr_workers_requested_start_years ~   ln_aewr_l2  | county_unique_fe + pairtime_fe,
                                  vcov =  ~ aewr_region_border_id  , data = aewr_border_df_yearly)

fixest_model_v2_cluster$coeftable # matches stata
fixest_model_v2_cluster$nobs


fixest_model_v2_cluster  <- feols(ln1_nbr_workers_requested_start_years ~   ln_aewr_l2  | county_unique_fe + pairtime_fe,
                                  vcov = twoway ~ aewr_region_border_id + aewr_region_num , data = subset(aewr_border_df_yearly, cz_same == 1))

fixest_model_v2_cluster$coeftable # matches stata
fixest_model_v2_cluster$nobs

## Bootstrap -------------------------------------------------------

# clustdfyear, this is our base datafram
# bootreps, this is our number of reps

bootreps <- 9999

input_data <- aewr_border_df_yearly %>% 
  filter(cz_same == 1) # limits sample to only pairs in the same CZ

dim(input_data) # 750 pairs

length(unique(input_data$pair_id))


pairs_df <- input_data %>%
  group_by(pair_id) %>%
  tally() %>%
  arrange(-n)

head(pairs_df)
summary(pairs_df$n)


# duplicate_pairs <- input_data %>%
#   filter(pair_id == "34017_36047" | pair_id == "34017_36061" | pair_id == "34017_36085" )
#
# duplicate_pairs
#
# 1 34017_36047    12
# 2 34017_36061    12
# 3 34017_36085    12

# rename

names(input_data)
names(input_data)[which(names(input_data) == "aewr_region_border_id")] <- "cluster" # aewr_region_border_id
names(input_data)[which(names(input_data) == "year")] <- "time" # census_period
names(input_data)[which(names(input_data) == "pair_id")] <- "pair" # pair_id
names(input_data)[which(names(input_data) == "aewr_border_side")] <- "side" # aewr_border_side w/in {0,1}
names(input_data)

dim(input_data)

periods <- unique(input_data$time) # grab the period variable

boot_treat_ests <- NULL # this is our storage vector

# from main DF, get clusters and number of pairs per cluster

cluster_list <- unique(input_data$cluster) # string

for (b in 1:bootreps) { # main boot loop starts


  # for each cluster, sample pairs with replacement

  boot_clust_samp <- NULL # store the clustered sample here

  cnt <- 1 # counter for boot sample id

  for (i in 1:length(cluster_list)) {

    # get the unique list of pairs

    temp_clust_df <- subset(input_data, cluster == cluster_list[i]) # iterate
    temp_pair_vec <- unique(temp_clust_df$pair)
    temp_clustpairsamp <- sample(temp_pair_vec, size = length(temp_pair_vec), replace = TRUE)
    temp_bootclustid <- seq(cnt, cnt + (length(temp_pair_vec)-1)) # this is a new ID for this boot sample

    temp_clust_df <- data.frame(pair = temp_clustpairsamp, cluster = cluster_list[i], boot_id = temp_bootclustid) # iterate

    boot_clust_samp <- rbind(boot_clust_samp, temp_clust_df)

    rm(temp_clust_df, temp_pair_vec, temp_clustpairsamp)

    cnt <- max(temp_bootclustid) + 1

    rm(temp_bootclustid)

    # print(i/length(cluster_list))
  }

  # use to make dataset for this bootstrap iteration

  # match years

  temp <- boot_clust_samp

  boot_clust_samp <- NULL

  for (i in 1:length(periods)) {
    temp$time <- periods[i]
    boot_clust_samp <- rbind(boot_clust_samp, temp)
    temp <- subset(temp, select = -c(time)) # remove the column we added
    # print(i)
  }

  dim(boot_clust_samp)

  # double and add treat / control indicator (or border side indicator, both would work)

  # match w/ 1 and 2 designating the side

#  order_vec <- sort(rep(seq(1,2), dim(boot_clust_samp)[1]))
  order_vec <- sort(rep(seq(0,1), dim(boot_clust_samp)[1]))

  boot_samp_int <- rbind(boot_clust_samp, boot_clust_samp)

  boot_samp_int$side <- order_vec

  rm(boot_clust_samp)

  # merge with data

  dim(boot_samp_int)
  dim(input_data)

  # make bootpair id (handles replacements) #

  boot_samp_final <- merge(x = boot_samp_int, y = input_data, by = c("pair", "cluster", "time", "side"), all.x = T, all.y = F)
  dim(boot_samp_final)

  rm(boot_samp_int)

  # fix the FEs #

  # units will be given by boot id and side

  boot_samp_final$boot_unit_fe <- with(boot_samp_final, interaction(as.factor(boot_id),  side))

  # then pairs are marked by boot id, and we will use time for the year dimension

  boot_samp_final$boot_pairtime_fe <- with(boot_samp_final, interaction(as.factor(boot_id),  time))

  levels(boot_samp_final$boot_pairtime_fe) <- c(levels(boot_samp_final$boot_pairtime_fe),"0.0")

  boot_samp_final$boot_pairtime_fe[boot_samp_final$time == periods[1]] <- "0.0" # first period is 0

  #################
  # run the model #
  #################

  # fixest_model  <- feols(outcome ~ treatcnts | factor(boot_unit_fe) + factor(boot_pairtime_fe), data = boot_samp_final)
  #
  # boot_est <- fixest_model$coeftable[1,1]
  #
  # boot_treat_ests <- c(boot_treat_ests, boot_est)
  #
  # rm(boot_samp_final)

  # make a table, 4 models, 3 outcome vars

  # outvars: ln1_nbr_workers_requested_start_years, ln1_nbr_workers_requested_all_years, nbr_workers_requested_start_year, nbr_workers_requested_all_years
  # models: aewr alone, add pop, add share, full
  m1_o1 <- feols(ln1_nbr_workers_requested_start_years ~ ln_aewr_ppi_l1 | boot_unit_fe + boot_pairtime_fe,
                 data = boot_samp_final)
  m2_o1 <- feols(ln1_nbr_workers_requested_start_years ~ ln_aewr_ppi_l1 + ln_pop_census + emp_pop_ratio | boot_unit_fe + boot_pairtime_fe,
                 data = boot_samp_final)
  m3_o1 <- feols(ln1_nbr_workers_requested_start_years ~ ln_aewr_ppi_l2 | boot_unit_fe + boot_pairtime_fe,
                 data = boot_samp_final)
  m4_o1 <- feols(ln1_nbr_workers_requested_start_years ~ ln_aewr_ppi_l2 + ln_pop_census + emp_pop_ratio | boot_unit_fe + boot_pairtime_fe,
                 data = boot_samp_final)

  out1bootres <- data.frame(outvar = c("ln1_nbr_workers_requested_start_years", "ln1_nbr_workers_requested_start_years", "ln1_nbr_workers_requested_start_years", "ln1_nbr_workers_requested_start_years"),
                            model = c(1, 2, 3, 4),
                            aewr_ppi_coef = c(m1_o1$coefficients[1], m2_o1$coefficients[1], m3_o1$coefficients[1], m4_o1$coefficients[1]),
                            lags = c(1, 1, 2, 2),
                            logs = c("Y", "Y", "Y", "Y"),
                            controls = c("N", "ln_pop_census and emp_pop_ratio", "N", "ln_pop_census and emp_pop_ratio"),
                            bootrep = c(b, b, b, b), 
                            obs = c( m1_o1$nobs , m2_o1$nobs , m3_o1$nobs , m4_o1$nobs))

  m1_o2 <- feols(ln1_nbr_workers_requested_all_years ~ ln_aewr_ppi_l1 | boot_unit_fe + boot_pairtime_fe,
                 data = boot_samp_final)
  m2_o2 <- feols(ln1_nbr_workers_requested_all_years ~ ln_aewr_ppi_l1 + ln_pop_census + emp_pop_ratio | boot_unit_fe + boot_pairtime_fe,
                 data = boot_samp_final)
  m3_o2 <- feols(ln1_nbr_workers_requested_all_years ~ ln_aewr_ppi_l2 | boot_unit_fe + boot_pairtime_fe,
                 data = boot_samp_final)
  m4_o2 <- feols(ln1_nbr_workers_requested_all_years ~ ln_aewr_ppi_l2 + ln_pop_census + emp_pop_ratio | boot_unit_fe + boot_pairtime_fe,
                 data = boot_samp_final)
  
  out2bootres <- data.frame(outvar = c("ln1_nbr_workers_requested_all_years", "ln1_nbr_workers_requested_all_years", "ln1_nbr_workers_requested_all_years", "ln1_nbr_workers_requested_all_years"),
                            model = c(1, 2, 3, 4),
                            aewr_ppi_coef = c(m1_o2$coefficients[1], m2_o2$coefficients[1], m3_o2$coefficients[1], m4_o2$coefficients[1]),
                            lags = c(1, 1, 2, 2),
                            logs = c("Y", "Y", "Y", "Y"),
                            controls = c("N", "ln_pop_census and emp_pop_ratio", "N", "ln_pop_census and emp_pop_ratio"),
                            bootrep = c(b, b, b, b), 
                            obs = c( m1_o2$nobs , m2_o2$nobs , m3_o2$nobs , m4_o2$nobs))
  
  m1_o3 <- feols(nbr_workers_requested_start_year ~ aewr_ppi_l1 | boot_unit_fe + boot_pairtime_fe,
                 data = boot_samp_final)
  m2_o3 <- feols(nbr_workers_requested_start_year ~ aewr_ppi_l1 + ln_pop_census + emp_pop_ratio | boot_unit_fe + boot_pairtime_fe,
                 data = boot_samp_final)
  m3_o3 <- feols(nbr_workers_requested_start_year ~ aewr_ppi_l2 | boot_unit_fe + boot_pairtime_fe,
                 data = boot_samp_final)
  m4_o3 <- feols(nbr_workers_requested_start_year ~ aewr_ppi_l2 + ln_pop_census + emp_pop_ratio | boot_unit_fe + boot_pairtime_fe,
                 data = boot_samp_final)
  
  out3bootres <- data.frame(outvar = c("nbr_workers_requested_start_year", "nbr_workers_requested_start_year", "nbr_workers_requested_start_year", "nbr_workers_requested_start_year"),
                            model = c(1, 2, 3, 4),
                            aewr_ppi_coef = c(m1_o3$coefficients[1], m2_o3$coefficients[1], m3_o3$coefficients[1], m4_o3$coefficients[1]),
                            lags = c(1, 1, 2, 2),
                            logs = c("N", "N", "N", "N"),
                            controls = c("N", "ln_pop_census and emp_pop_ratio", "N", "ln_pop_census and emp_pop_ratio"),
                            bootrep = c(b, b, b, b), 
                            obs = c( m1_o3$nobs , m2_o3$nobs , m3_o3$nobs , m4_o3$nobs))
  
  m1_o4 <- feols(nbr_workers_requested_all_years ~ aewr_ppi_l1 | boot_unit_fe + boot_pairtime_fe,
                 data = boot_samp_final)
  m2_o4 <- feols(nbr_workers_requested_all_years ~ aewr_ppi_l1 + ln_pop_census + emp_pop_ratio | boot_unit_fe + boot_pairtime_fe,
                 data = boot_samp_final)
  m3_o4 <- feols(nbr_workers_requested_all_years ~ aewr_ppi_l2 | boot_unit_fe + boot_pairtime_fe,
                 data = boot_samp_final)
  m4_o4 <- feols(nbr_workers_requested_all_years ~ aewr_ppi_l2 + ln_pop_census + emp_pop_ratio | boot_unit_fe + boot_pairtime_fe,
                 data = boot_samp_final)
  
  out4bootres <- data.frame(outvar = c("nbr_workers_requested_all_years", "nbr_workers_requested_all_years", "nbr_workers_requested_all_years", "nbr_workers_requested_all_years"),
                            model = c(1, 2, 3, 4),
                            aewr_ppi_coef = c(m1_o4$coefficients[1], m2_o4$coefficients[1], m3_o4$coefficients[1], m4_o4$coefficients[1]),
                            lags = c(1, 1, 2, 2),
                            logs = c("N", "N", "N", "N"),
                            controls = c("N", "ln_pop_census and emp_pop_ratio", "N", "ln_pop_census and emp_pop_ratio"),
                            bootrep = c(b, b, b, b), 
                            obs = c( m1_o4$nobs , m2_o4$nobs , m3_o4$nobs , m4_o4$nobs))


  boot_treat_ests <- rbind(boot_treat_ests, out1bootres)
  boot_treat_ests <- rbind(boot_treat_ests, out2bootres)
  boot_treat_ests <- rbind(boot_treat_ests, out3bootres)
  boot_treat_ests <- rbind(boot_treat_ests, out4bootres)

  print("### Boot Percent Complete ###")
  print(b / bootreps)

} # end boot loop

boot_treat_ests <- boot_treat_ests %>% 
  mutate(note = "CZ Pair Smaple")

write.csv(boot_treat_ests, file = paste0(folder_output, "boot_tscb_paired_first_stage_r", bootreps, "_", date, ".csv"))

# put it in a nice table #

head(boot_treat_ests)

# cols: out vars, models
# rows: controls

hist(boot_treat_ests$obs)
summary(boot_treat_ests$obs)

boot_treat_sum_test <- boot_treat_ests %>%
  filter(outvar == "h2a_nbr_workers_requested" & model == 4)

sd(boot_treat_sum_test$aewr_ppi_coef)

boot_treat_sum <- boot_treat_ests %>%
  group_by(outvar, model, lags, logs, controls) %>%
  summarise(aewr_ppi = mean(aewr_ppi_coef, na.rm = T),
            aewr_ppi_bootse = sd(aewr_ppi_coef, na.rm = T),
            aewr_ppi_confinf_l = quantile(aewr_ppi_coef, prob = 0.025, na.rm = T),
            aewr_ppi_confinf_u = quantile(aewr_ppi_coef, prob = 0.975, na.rm = T),
            obs = mean(obs, na.rm = T)) %>% 
  mutate(note = "CZ Pair Smaple")

boot_treat_sum <- boot_treat_sum %>% 
  mutate(est_fstat = (aewr_ppi / aewr_ppi_bootse)^2,
         est_tstat = (aewr_ppi / aewr_ppi_bootse))
 
write.csv(boot_treat_sum, file = paste0(folder_output, "boot_tscb_paired_table_summary_first_stage_r", bootreps, "_", date, ".csv"))

names(boot_treat_sum)

aewr_est_fig <- ggplot(data = boot_treat_sum, aes(x = model))+
  geom_point(aes(y = aewr_ppi))+
  geom_errorbar(aes(ymin = aewr_ppi_confinf_l, ymax = aewr_ppi_confinf_u))+
  facet_wrap(~outvar, scales = "free")+
  geom_hline(yintercept = 0)
aewr_est_fig

ggsave(filename = paste0(folder_output, "fig_crude_coefplot_boot_r", bootreps, "_", date, ".png"), aewr_est_fig, device = "png")

aewr_est_fig <- ggplot(data = subset(boot_treat_sum, outvar == "ln1_nbr_workers_requested_start_years"), aes(x = model))+
  geom_point(aes(y = aewr_ppi))+
  geom_errorbar(aes(ymin = aewr_ppi_confinf_l, ymax = aewr_ppi_confinf_u))+
  geom_hline(yintercept = 0)+
  ylab("Log Real AEWR")
aewr_est_fig

ggsave(filename = paste0(folder_output, "fig_crude_coefplot_boot_ln1_nbr_workers_requested_start_years_r", bootreps, "_", date, ".png"), aewr_est_fig, device = "png")


--------------------------------------------------------------------------------

================================================================================
 FILE: H2A Build Dataset.R
================================================================================

## H2A Build Dataset
## Phil Hoxie 
## 1/31/24

## Run Master File First ##

## Load Data -------------------------------------------------------------------

# census period version #
acs_immigrant_imputed <- readRDS(paste0(folder_data, "acs_immigrant_imputed.rds"))
acs_qcew_data <- readRDS(paste0(folder_data, "acs_qcew_data.rds"))
aewr_data <- readRDS(paste0(folder_data, "aewr_data.rds"))
aewr_regions <- read.csv(file = paste0(folder_data, "aewr_regions.csv"), stringsAsFactors = F)
bea_caemp25n_data <- readRDS(paste0(folder_data, "bea_caemp25n_data.rds"))
bea_cainc45_data <- readRDS(paste0(folder_data, "bea_cainc45_data.rds"))
border_df <- readRDS(paste0(folder_data, "border_df.rds"))
fips_codes <- read.csv(file = paste0(folder_data, "fips_codes.csv"), stringsAsFactors = F)
h2a_data <- readRDS(paste0(folder_data, "h2a_data.rds"))
# nawspad_data
# oews_data
ppi_data <- read.csv(file = paste0(folder_data, "WPU01.csv"), stringsAsFactors = F)
state_border_pairs <- read.csv(file = paste0(folder_data, "state_border_pairs.csv"), stringsAsFactors = F)
border_counties_allmatches <- read.csv(file = paste0(folder_data, "border_counties_allmatches.csv"), stringsAsFactors = F)
census_of_agriculture_cropland <- readRDS(file = paste0(folder_data, "census_ag_cropland.rds"))

census_pop_ests <- readRDS(paste0(folder_data, "census_pop_ests.rds"))

census_of_agriculture_cropland_base <- readRDS(file = paste0(folder_data, "census_ag_cropland_2007.rds"))

## Build Main Paired Border County Dataset -------------------------------------

head(border_df) # this is the base, we will attache everything here. 
head(state_border_pairs) # this is the base, we will attache everything here. 
head(border_counties_allmatches) # this is the base, we will attache everything here. 

border_df %>% group_by(census_period) %>% tally()

# merge in for each side: 

# by state and year
head(aewr_data)

# by state
head(aewr_regions)

# merge for only one side 

# by 
# loop ? 

# by county and census_period
head(acs_immigrant_imputed)
head(acs_qcew_data) # year
head(bea_caemp25n_data)
head(bea_cainc45_data)
head(h2a_data)
head(census_pop_ests)

## a tad of prep ---------------------------------------------------------------

border_df <- border_df %>% 
  transform(state_abbrev = str_trim(state), 
            neighbor_abbrev = str_trim(neighbor_state))

head(border_df)

## both sides merge ----------------------------------------------------------

# first side

names(aewr_data)

dim(border_df)

border_df <- merge(x = border_df, y = aewr_data, by = c("census_period", "state_abbrev"), all.x = T, all.y = F)

dim(border_df) # DC missing

# no need to rename these

names(aewr_regions)
dim(border_df)

border_df <- merge(x = border_df, y = aewr_regions, by = c("state_abbrev"), all.x = T, all.y = F)

dim(border_df)

# second side (neighbr)

names(aewr_data)
names(border_df)
dim(border_df)

aewr_data_m <- aewr_data %>% 
  rename(aewr_neighbor = aewr, 
         aewr_ppi_neighbor = aewr_ppi,
         neighbor_abbrev =  state_abbrev)

border_df <- merge(x = border_df, y = aewr_data_m, 
                   by = c("census_period", "neighbor_abbrev"), 
                   all.x = T, all.y = F)
rm(aewr_data_m)

dim(border_df)

# no need to rename these

names(aewr_regions)
dim(border_df)

aewr_regions_m <- aewr_regions %>% 
  rename(aewr_region_num_neighbor = aewr_region_num,
         neighbor_abbrev =  state_abbrev)

border_df <- merge(x = border_df, y = aewr_regions_m, 
                   by = c("neighbor_abbrev"),
                   all.x = T, all.y = F)
rm(aewr_regions_m)

dim(border_df)
head(border_df)

# ID Pair "side" 
# This is arbitrary, but necessary

border_df %>% group_by(border_pair, orderpair) %>% tally()

border_df <- border_df %>% 
  mutate(border_side = ifelse(orderpair == "state first", 1, 0))

head(border_df)

# can we loop these 
# # by county and census_period
# head(acs_immigrant_imputed)
# head(acs_qcew_data) # year
# head(bea_caemp25n_data)
# head(bea_cainc45_data)
# head(h2a_data)

border_df <- border_df %>% 
  mutate(cz_same = ifelse(cz_out10 == cz_out10_neighbor, 1, 0))

border_df <- border_df %>% 
  rename(countyfips = fipscounty)

datasets <- c("acs_immigrant_imputed", "acs_qcew_data", "bea_caemp25n_data", "bea_cainc45_data", "h2a_data", "census_pop_ests", "census_of_agriculture_cropland")

for (i in 1:length(datasets)) {
  print(paste0("Rep ", i))
  temp <- get(datasets[i])
  print(dim(border_df))
  print(dim(temp))
  border_df <- merge(x = border_df, y = temp, 
                     by = c("census_period", "countyfips"),
                     all.x = T, all.y = F)
  rm(temp)
}
dim(border_df)
head(border_df)

# county only #

dim(census_of_agriculture_cropland_base)

border_df <- merge(x = border_df, y = census_of_agriculture_cropland_base, by = "countyfips", all.x = T, all.y = F) 

border_df %>% 
  group_by(census_period) %>% 
  tally()

border_df %>% 
  filter(census_period == 2007 & !is.na(cropland_acr_2007)) %>% 
  count()

## Variable cleaning ## -----------------

# H2A NAs to zero

border_df$nbr_workers_requested_all_years[is.na(border_df$nbr_workers_requested_all_years)] <- 0 
border_df$nbr_workers_certified_all_years[is.na(border_df$nbr_workers_certified_all_years)] <- 0 
border_df$man_hours_requested_all_years[is.na(border_df$man_hours_requested_all_years)] <- 0 
border_df$man_hours_certified_all_years[is.na(border_df$man_hours_certified_all_years)] <- 0 
border_df$nbr_applications_all_years[is.na(border_df$nbr_applications_all_years)] <- 0 

border_df$nbr_workers_requested_start_year[is.na(border_df$nbr_workers_requested_start_year)] <- 0 
border_df$nbr_workers_certified_start_year[is.na(border_df$nbr_workers_certified_start_year)] <- 0 
border_df$man_hours_requested_start_year[is.na(border_df$man_hours_requested_start_year)] <- 0 
border_df$man_hours_certified_start_year[is.na(border_df$man_hours_certified_start_year)] <- 0 
border_df$nbr_applications_start_year[is.na(border_df$nbr_applications_start_year)] <- 0 

border_df$nbr_workers_requested_fiscal_year[is.na(border_df$nbr_workers_requested_fiscal_year)] <- 0 
border_df$nbr_workers_certified_fiscal_year[is.na(border_df$nbr_workers_certified_fiscal_year)] <- 0 
border_df$man_hours_requested_fiscal_year[is.na(border_df$man_hours_requested_fiscal_year)] <- 0 
border_df$man_hours_certified_fiscal_year[is.na(border_df$man_hours_certified_fiscal_year)] <- 0 
border_df$nbr_applications_fiscal_year[is.na(border_df$nbr_applications_fiscal_year)] <- 0 

head(border_df)

# cropland zeros 

border_df$cropland_acr[is.na(border_df$cropland_acr)] <- 0 
border_df$cropland_acr_2007[is.na(border_df$cropland_acr_2007)] <- 0

# AEWR Diff 

border_df <- border_df %>% 
  mutate(aewr_diff = aewr - aewr_neighbor,
         aewr_ppi_diff = aewr_ppi - aewr_ppi_neighbor,
         aewr_diff_pct = (aewr - aewr_neighbor) / aewr_neighbor,
         aewr_ppi_diff_pct = (aewr_ppi - aewr_ppi_neighbor) / aewr_ppi_neighbor)

hist(border_df$aewr_diff)

# logs of some vars

border_df <- border_df %>% 
  mutate(ln_aewr = log(aewr), 
         ln_aewr_ppi = log(aewr_ppi), 
         ln_pop_total = log(pop_total), 
         ln_pop_prime = log(pop_prime), 
         ln_pop_undoc = log(pop_undoc), 
         ln_pop_prime_undoc = log(pop_prime_undoc), 
         ln_emp_farm_propr = log(emp_farm_propr), 
         ln_emp_farm = log(emp_farm), 
         ln_emp_nonfarm = log(emp_nonfarm), 
         ln_emp_privatenonfarm = log(emp_privatenonfarm),
         ln_pop_census = log(pop_census),
         ln_cropland_acr = log(cropland_acr),
         ln_cropland_acr_2007 = log(cropland_acr_2007),
         ln_nbr_workers_requested_start_years = log(nbr_workers_requested_start_year),
         ln_nbr_workers_requested_all_years = log(nbr_workers_requested_all_years),
         ln_nbr_applications_fiscal_year = log(nbr_applications_fiscal_year),
         ln1_nbr_workers_requested_start_years = log(nbr_workers_requested_start_year + 1),
         ln1_nbr_workers_requested_all_years = log(nbr_workers_requested_all_years + 1),
         ln1_nbr_applications_fiscal_year = log(nbr_applications_fiscal_year + 1))

# budget shares 

border_df <- border_df %>% 
  mutate(share_farm_laborexp_prodexp = farm_laborexpense / farm_prodexp,
        share_farm_crop_cashandinc = farm_cashcrops / farm_cashandinc,
        share_farm_animal_cashandinc = farm_cashanimal / farm_cashandinc,
        share_farm_govt_cashandinc = farm_govpayments / farm_cashandinc)

# emp-pop ratio 

border_df <- border_df %>% 
  mutate(emp_pop_ratio = emp_tot / pop_total,
         emp_farm_share = emp_farm / emp_tot)

# H2A outcome variables 

border_df <- border_df %>% 
  mutate(emp_pop_ratio = emp_tot / pop_total,
         emp_farm_share = emp_farm / emp_tot,
         h2a_req_share_farm_workers_start_year = nbr_workers_requested_start_year / emp_farm,
         h2a_cert_share_farm_workers_start_year = nbr_workers_certified_start_year / emp_farm) # add h2a apps per farm later

border_df$h2a_req_share_farm_workers_start_year[is.infinite(border_df$h2a_req_share_farm_workers_start_year)] <- NA
border_df$h2a_cert_share_farm_workers_start_year[is.infinite(border_df$h2a_cert_share_farm_workers_start_year)] <- NA

# AEWR border sample # 

border_df <- border_df %>% 
  mutate(aewr_border_sample = ifelse(aewr_region_num == aewr_region_num_neighbor, 0 , 1))

border_df %>% group_by(aewr_border_sample) %>% tally()

head(border_df)

border_df %>% 
  filter(is.na(aewr_border_sample)) %>% 
  group_by(state_abbrev) %>% 
  tally()

# identify lower of AEWR regions
border_df <- border_df %>% 
  mutate(lower_aewr_reg_num = ifelse(aewr_region_num < aewr_region_num_neighbor, aewr_region_num, 
                                     ifelse(aewr_region_num > aewr_region_num_neighbor, aewr_region_num_neighbor, NA)))

# make region border ID

border_df <- border_df %>% 
  mutate(aewr_region_border_id = ifelse(aewr_region_num == lower_aewr_reg_num, paste0(aewr_region_num,"_", aewr_region_num_neighbor),
                                        ifelse(aewr_region_num > lower_aewr_reg_num, paste0(aewr_region_num_neighbor,"_", aewr_region_num), NA)))

border_df %>% group_by(aewr_region_border_id) %>% tally()

unique(border_df$aewr_region_border_id) # 32 groups

# make pair ID

# identify lower of AEWR regions
border_df <- border_df %>% 
  mutate(lower_cnty_fips = ifelse(countyfips < fipsneighbor, countyfips, 
                                     ifelse(countyfips > fipsneighbor, fipsneighbor, NA)))

# make region border ID

border_df <- border_df %>% 
  mutate(pair_id = ifelse(countyfips == lower_cnty_fips, paste0(countyfips,"_", fipsneighbor),
                                        ifelse(countyfips > lower_cnty_fips, paste0(fipsneighbor,"_", countyfips), NA)))

border_df %>% group_by(pair_id) %>% tally()
border_df %>% group_by(aewr_region_border_id) %>% tally()

length(unique(border_df$pair_id))

# fixed effects

# period 

border_df$census_period_fe <- with(border_df, as.factor(census_period)) # treats counties in separate clusters as separate

# county 

border_df$county_unique_fe <- with(border_df, interaction(as.factor(countyfips),  aewr_region_border_id)) # treats counties in separate clusters as separate

border_df$county_fe <- with(border_df, as.factor(countyfips)) # treats counties in separate clusters as separate

# state

border_df$state_fe <- with(border_df, as.factor(state_abbrev)) # treats counties in separate clusters as separate

# AEWR Region

border_df$aewr_region_fe <- with(border_df, as.factor(aewr_region_num)) # treats counties in separate clusters as separate

# pair

border_df$pair_fe <- with(border_df, as.factor(pair_id)) # treats counties in separate clusters as separate

# pair x time

border_df$pairtime_fe <- with(border_df, interaction(as.factor(pair_id),  census_period))

levels(border_df$pairtime_fe) <- c(levels(border_df$pairtime_fe),"0.0") 

unique(border_df$census_period)

border_df$pairtime_fe[border_df$census_period == 2007] <- "0.0" # first period is 0

# aewr region pair x time

border_df$aewrbordertime_fe <- with(border_df, interaction(as.factor(aewr_region_border_id),  census_period))

levels(border_df$aewrbordertime_fe) <- c(levels(border_df$aewrbordertime_fe),"0.0") 

unique(border_df$census_period)

border_df$aewrbordertime_fe[border_df$census_period == 2007] <- "0.0" # first period is 0


# AEWR border side -------------------------------------------------------------

border_df <- border_df %>% 
  mutate(aewr_border_side = ifelse(aewr_region_num == lower_aewr_reg_num & aewr_border_sample == 1, 0, 
                                   ifelse(aewr_region_num != lower_aewr_reg_num & aewr_border_sample == 1, 1, NA)))

# sample restriction to counties with cropland ------------------------------------

# we want to drop counties with no cropland in 2007

border_df <- border_df %>% 
  mutate(any_cropland_2007 = ifelse(cropland_acr_2007 != 0 & !is.na(cropland_acr_2007), 1, 0))

border_df %>% 
  group_by(any_cropland_2007, census_period) %>% 
  tally()

# need to make sure both sides of the pair drop out #

no_crop_pairs <- border_df %>% 
  filter(any_cropland_2007 == 0 & census_period == 2007) %>% 
  select(pair_id)

no_crop_pairs <- no_crop_pairs %>% 
  mutate(no_cropland_2007_pair = 1)

dim(no_crop_pairs)

no_crop_pairs <- unique(no_crop_pairs)
dim(no_crop_pairs)

border_df <- merge(x = border_df, y = no_crop_pairs, by = "pair_id", all.x = T)

border_df$no_cropland_2007_pair[is.na(border_df$no_cropland_2007_pair)] <- 0


# check for NAs in key vars ------------------------------------

# use sum(is.na(x))

NA_df <- NULL 

dim(border_df)

border_df_samp <- border_df %>% 
  filter(!is.na(aewr_region_border_id))

for (i in 1:length(names(border_df))) {
  temp_na_cnt <- sum(is.na(border_df[,i]))
  temp_varname <- paste0(names(border_df)[i])
  temp_na_cnt_samp <- sum(is.na(border_df_samp[,i]))

  temp <- data.frame(var = temp_varname, 
                     full_na_cnt = temp_na_cnt, 
                     border_samp_na_cnt = temp_na_cnt_samp)
  
  NA_df <- bind_rows(NA_df, temp)
  rm(temp, temp_na_cnt, temp_varname, temp_na_cnt_samp)
}

# easiest / most important to fix
fixcounty <- border_df %>% 
  filter(is.na(emp_tot) & !is.na(aewr_region_border_id))

fixcounty %>% 
  group_by(state_abbrev) %>% 
  tally() # BEA issue for VA counties. We need to drop bristol city. It will be ok. 

saveRDS(border_df, file = paste0(folder_data, "border_df_analysis.rds"))

## Remove files ## -------------------------------------------------------------

str_detect(ls(), "folder_")

objects <- data.frame(name = ls(), keep = str_detect(ls(), "folder_")) %>% 
  filter(keep == F)

rm(list = objects[,1])
gc()

rm(objects)

## -----------------------------------------------------------------------------
## Yearly Dataset ## -----------------------------------------------------------
## -----------------------------------------------------------------------------

## Load Data -------------------------------------------------------------------

# yearly versions #
aewr_data <- readRDS(paste0(folder_data, "aewr_data_year.rds"))
aewr_regions <- read.csv(file = paste0(folder_data, "aewr_regions.csv"), stringsAsFactors = F)
bea_caemp25n_data <- readRDS(paste0(folder_data, "bea_caemp25n_data_year.rds"))
bea_cainc45_data <- readRDS(paste0(folder_data, "bea_cainc45_data_year.rds"))
border_df <- readRDS(paste0(folder_data, "border_df_year.rds"))
fips_codes <- read.csv(file = paste0(folder_data, "fips_codes.csv"), stringsAsFactors = F)
h2a_data <- readRDS(paste0(folder_data, "h2a_data_year.rds"))
# nawspad_data
# oews_data
ppi_data <- read.csv(file = paste0(folder_data, "WPU01.csv"), stringsAsFactors = F)
state_border_pairs <- read.csv(file = paste0(folder_data, "state_border_pairs.csv"), stringsAsFactors = F)
border_counties_allmatches <- read.csv(file = paste0(folder_data, "border_counties_allmatches.csv"), stringsAsFactors = F)
census_of_agriculture_cropland <- readRDS(file = paste0(folder_data, "census_ag_cropland_year.rds"))

census_pop_ests <- readRDS(paste0(folder_data, "census_pop_ests_year.rds"))

census_of_agriculture_cropland_base <- readRDS(file = paste0(folder_data, "census_ag_cropland_2007_year.rds"))

## Build Main Paired Border County Dataset -------------------------------------

head(border_df) # this is the base, we will attache everything here. 
head(state_border_pairs) # this is the base, we will attache everything here. 
head(border_counties_allmatches) # this is the base, we will attache everything here. 

border_df %>% group_by(year) %>% tally()

# merge in for each side: 

# by state and year
head(aewr_data)

# by state
head(aewr_regions)

# merge for only one side 

# by 
# loop ? 

# by county and census_period

head(bea_caemp25n_data)
head(bea_cainc45_data)
head(h2a_data)
head(census_pop_ests)

## a tad of prep ---------------------------------------------------------------

border_df <- border_df %>% 
  transform(state_abbrev = str_trim(state), 
            neighbor_abbrev = str_trim(neighbor_state))

head(border_df)

## both sides merge ----------------------------------------------------------

# first side

names(aewr_data)

dim(border_df)

border_df <- merge(x = border_df, y = aewr_data, by = c("year", "state_abbrev"), all.x = T, all.y = F)

dim(border_df) # DC missing

head(border_df)
# no need to rename these

names(aewr_regions)
dim(border_df)

border_df <- merge(x = border_df, y = aewr_regions, by = c("state_abbrev"), all.x = T, all.y = F)

dim(border_df)

# second side (neighbr)

names(aewr_data)
names(border_df)
dim(border_df)

aewr_data_m <- aewr_data %>% 
  rename(aewr_neighbor = aewr, 
         aewr_ppi_neighbor = aewr_ppi,
         aewr_neighbor_l1 = aewr_l1, 
         aewr_ppi_neighbor_l1 = aewr_ppi_l1,
         aewr_neighbor_l2 = aewr_l2, 
         aewr_ppi_neighbor_l2 = aewr_ppi_l2,
         neighbor_abbrev =  state_abbrev)

border_df <- merge(x = border_df, y = aewr_data_m, 
                   by = c("year", "neighbor_abbrev"), 
                   all.x = T, all.y = F)
rm(aewr_data_m)

dim(border_df)

# no need to rename these

names(aewr_regions)
dim(border_df)

aewr_regions_m <- aewr_regions %>% 
  rename(aewr_region_num_neighbor = aewr_region_num,
         neighbor_abbrev =  state_abbrev)

border_df <- merge(x = border_df, y = aewr_regions_m, 
                   by = c("neighbor_abbrev"),
                   all.x = T, all.y = F)
rm(aewr_regions_m)

dim(border_df)
head(border_df)

# ID Pair "side" 
# This is arbitrary, but necessary

border_df %>% group_by(border_pair, orderpair) %>% tally()

border_df <- border_df %>% 
  mutate(border_side = ifelse(orderpair == "state first", 1, 0))

head(border_df)

# can we loop these 
# # by county and census_period
# head(acs_immigrant_imputed)
# head(acs_qcew_data) # year
# head(bea_caemp25n_data)
# head(bea_cainc45_data)
# head(h2a_data)

border_df <- border_df %>% 
  mutate(cz_same = ifelse(cz_out10 == cz_out10_neighbor, 1, 0))

border_df <- border_df %>% 
  rename(countyfips = fipscounty)

datasets <- c( "bea_caemp25n_data", "bea_cainc45_data", "h2a_data", "census_pop_ests", "census_of_agriculture_cropland")

for (i in 1:length(datasets)) {
  print(paste0("Rep ", i))
  temp <- get(datasets[i])
  print(dim(border_df))
  print(dim(temp))
  border_df <- merge(x = border_df, y = temp, 
                     by = c("year", "countyfips"),
                     all.x = T, all.y = F)
  rm(temp)
}
dim(border_df)
head(border_df)

# county only #

dim(census_of_agriculture_cropland_base)

border_df <- merge(x = border_df, y = census_of_agriculture_cropland_base, by = "countyfips", all.x = T, all.y = F) 

border_df %>% 
  group_by(year) %>% 
  tally()

border_df %>% 
  filter(year == 2008 & !is.na(cropland_acr_2007)) %>% 
  count()

## Variable cleaning ## -----------------

# H2A NAs to zero

border_df$nbr_workers_requested_all_years[is.na(border_df$nbr_workers_requested_all_years)] <- 0 
border_df$nbr_workers_certified_all_years[is.na(border_df$nbr_workers_certified_all_years)] <- 0 
border_df$man_hours_requested_all_years[is.na(border_df$man_hours_requested_all_years)] <- 0 
border_df$man_hours_certified_all_years[is.na(border_df$man_hours_certified_all_years)] <- 0 
border_df$nbr_applications_all_years[is.na(border_df$nbr_applications_all_years)] <- 0 

border_df$nbr_workers_requested_start_year[is.na(border_df$nbr_workers_requested_start_year)] <- 0 
border_df$nbr_workers_certified_start_year[is.na(border_df$nbr_workers_certified_start_year)] <- 0 
border_df$man_hours_requested_start_year[is.na(border_df$man_hours_requested_start_year)] <- 0 
border_df$man_hours_certified_start_year[is.na(border_df$man_hours_certified_start_year)] <- 0 
border_df$nbr_applications_start_year[is.na(border_df$nbr_applications_start_year)] <- 0 

border_df$nbr_workers_requested_fiscal_year[is.na(border_df$nbr_workers_requested_fiscal_year)] <- 0 
border_df$nbr_workers_certified_fiscal_year[is.na(border_df$nbr_workers_certified_fiscal_year)] <- 0 
border_df$man_hours_requested_fiscal_year[is.na(border_df$man_hours_requested_fiscal_year)] <- 0 
border_df$man_hours_certified_fiscal_year[is.na(border_df$man_hours_certified_fiscal_year)] <- 0 
border_df$nbr_applications_fiscal_year[is.na(border_df$nbr_applications_fiscal_year)] <- 0 

head(border_df)

# cropland zeros 

border_df$cropland_acr[is.na(border_df$cropland_acr)] <- 0 
border_df$cropland_acr_2007[is.na(border_df$cropland_acr_2007)] <- 0

# AEWR Diff 

border_df <- border_df %>% 
  mutate(aewr_diff = aewr - aewr_neighbor,
         aewr_ppi_diff = aewr_ppi - aewr_ppi_neighbor,
         aewr_diff_pct = (aewr - aewr_neighbor) / aewr_neighbor,
         aewr_ppi_diff_pct = (aewr_ppi - aewr_ppi_neighbor) / aewr_ppi_neighbor,
         aewr_diff_l1 = aewr_l1 - aewr_neighbor_l1,
         aewr_ppi_diff_l1 = aewr_ppi_l1 - aewr_ppi_neighbor_l1,
         aewr_diff_pct_l1 = (aewr_l1 - aewr_neighbor_l1) / aewr_neighbor_l1,
         aewr_ppi_diff_pct_l1 = (aewr_ppi_l1 - aewr_ppi_neighbor_l1) / aewr_ppi_neighbor_l1,
         aewr_diff_l2 = aewr_l2 - aewr_neighbor_l2,
         aewr_ppi_diff_l2 = aewr_ppi_l2 - aewr_ppi_neighbor_l2,
         aewr_diff_pct_l2 = (aewr_l2 - aewr_neighbor_l2) / aewr_neighbor_l2,
         aewr_ppi_diff_pct_l2 = (aewr_ppi_l2 - aewr_ppi_neighbor_l2) / aewr_ppi_neighbor_l2)

hist(border_df$aewr_diff)

border_df <- border_df %>% 
  mutate(emp_pop_ratio = emp_tot / pop_census)

# logs of some vars

border_df <- border_df %>% 
  mutate(ln_aewr = log(aewr), 
         ln_aewr_ppi = log(aewr_ppi), 
         ln_aewr_l1 = log(aewr_l1), 
         ln_aewr_ppi_l1 = log(aewr_ppi_l1), 
         ln_aewr_l2 = log(aewr_l2), 
         ln_aewr_ppi_l2 = log(aewr_ppi_l2), 
         ln_emp_farm_propr = log(emp_farm_propr), 
         ln_emp_farm = log(emp_farm), 
         ln_emp_nonfarm = log(emp_nonfarm), 
         ln_emp_privatenonfarm = log(emp_privatenonfarm),
         ln_pop_census = log(pop_census),
         ln_cropland_acr = log(cropland_acr),
         ln_cropland_acr_2007 = log(cropland_acr_2007),
         ln_nbr_workers_requested_start_years = log(nbr_workers_requested_start_year),
         ln_nbr_workers_requested_all_years = log(nbr_workers_requested_all_years),
         ln_nbr_applications_fiscal_year = log(nbr_applications_fiscal_year),
         ln1_nbr_workers_requested_start_years = log(nbr_workers_requested_start_year + 1),
         ln1_nbr_workers_requested_all_years = log(nbr_workers_requested_all_years + 1),
         ln1_nbr_applications_fiscal_year = log(nbr_applications_fiscal_year + 1))

# budget shares 

border_df <- border_df %>% 
  mutate(share_farm_laborexp_prodexp = farm_laborexpense / farm_prodexp,
         share_farm_crop_cashandinc = farm_cashcrops / farm_cashandinc,
         share_farm_animal_cashandinc = farm_cashanimal / farm_cashandinc,
         share_farm_govt_cashandinc = farm_govpayments / farm_cashandinc)

# H2A outcome variables 

border_df <- border_df %>% 
  mutate(h2a_req_share_farm_workers_start_year = nbr_workers_requested_start_year / emp_farm,
         h2a_cert_share_farm_workers_start_year = nbr_workers_certified_start_year / emp_farm) # add h2a apps per farm later

border_df$h2a_req_share_farm_workers_start_year[is.infinite(border_df$h2a_req_share_farm_workers_start_year)] <- NA
border_df$h2a_cert_share_farm_workers_start_year[is.infinite(border_df$h2a_cert_share_farm_workers_start_year)] <- NA

# AEWR border sample # 

border_df <- border_df %>% 
  mutate(aewr_border_sample = ifelse(aewr_region_num == aewr_region_num_neighbor, 0 , 1))

border_df %>% group_by(aewr_border_sample) %>% tally()

head(border_df)

border_df %>% 
  filter(is.na(aewr_border_sample)) %>% 
  group_by(state_abbrev) %>% 
  tally()

# identify lower of AEWR regions
border_df <- border_df %>% 
  mutate(lower_aewr_reg_num = ifelse(aewr_region_num < aewr_region_num_neighbor, aewr_region_num, 
                                     ifelse(aewr_region_num > aewr_region_num_neighbor, aewr_region_num_neighbor, NA)))

# make region border ID

border_df <- border_df %>% 
  mutate(aewr_region_border_id = ifelse(aewr_region_num == lower_aewr_reg_num, paste0(aewr_region_num,"_", aewr_region_num_neighbor),
                                        ifelse(aewr_region_num > lower_aewr_reg_num, paste0(aewr_region_num_neighbor,"_", aewr_region_num), NA)))

border_df %>% group_by(aewr_region_border_id) %>% tally()

unique(border_df$aewr_region_border_id) # 32 groups

# make pair ID

# identify lower of AEWR regions
border_df <- border_df %>% 
  mutate(lower_cnty_fips = ifelse(countyfips < fipsneighbor, countyfips, 
                                  ifelse(countyfips > fipsneighbor, fipsneighbor, NA)))

# make region border ID

border_df <- border_df %>% 
  mutate(pair_id = ifelse(countyfips == lower_cnty_fips, paste0(countyfips,"_", fipsneighbor),
                          ifelse(countyfips > lower_cnty_fips, paste0(fipsneighbor,"_", countyfips), NA)))

border_df %>% group_by(pair_id) %>% tally()
border_df %>% group_by(aewr_region_border_id) %>% tally()

length(unique(border_df$pair_id))

# fixed effects

# period 

border_df$year_fe <- with(border_df, as.factor(year)) # treats counties in separate clusters as separate

# county 

border_df$county_unique_fe <- with(border_df, interaction(as.factor(countyfips),  aewr_region_border_id)) # treats counties in separate clusters as separate

border_df$county_fe <- with(border_df, as.factor(countyfips)) # treats counties in separate clusters as separate

# state

border_df$state_fe <- with(border_df, as.factor(state_abbrev)) # treats counties in separate clusters as separate

# AEWR Region

border_df$aewr_region_fe <- with(border_df, as.factor(aewr_region_num)) # treats counties in separate clusters as separate

# pair

border_df$pair_fe <- with(border_df, as.factor(pair_id)) # treats counties in separate clusters as separate

# pair x time

border_df$pairtime_fe <- with(border_df, interaction(as.factor(pair_id),  year))

levels(border_df$pairtime_fe) <- c(levels(border_df$pairtime_fe),"0.0") 

unique(border_df$year)

border_df$pairtime_fe[border_df$year == 2008] <- "0.0" # first period is 0

# aewr region pair x time

border_df$aewrbordertime_fe <- with(border_df, interaction(as.factor(aewr_region_border_id),  year))

levels(border_df$aewrbordertime_fe) <- c(levels(border_df$aewrbordertime_fe),"0.0") 

unique(border_df$year)

border_df$aewrbordertime_fe[border_df$year == 2008] <- "0.0" # first period is 0


# AEWR border side -------------------------------------------------------------

border_df <- border_df %>% 
  mutate(aewr_border_side = ifelse(aewr_region_num == lower_aewr_reg_num & aewr_border_sample == 1, 0, 
                                   ifelse(aewr_region_num != lower_aewr_reg_num & aewr_border_sample == 1, 1, NA)))

# sample restriction to counties with cropland ------------------------------------

# we want to drop counties with no cropland in 2007

border_df <- border_df %>% 
  mutate(any_cropland_2007 = ifelse(cropland_acr_2007 != 0 & !is.na(cropland_acr_2007), 1, 0))

border_df %>% 
  group_by(any_cropland_2007, year) %>% 
  tally()

# need to make sure both sides of the pair drop out #

no_crop_pairs <- border_df %>% 
  filter(any_cropland_2007 == 0 & year == 2008) %>% 
  select(pair_id)

no_crop_pairs <- no_crop_pairs %>% 
  mutate(no_cropland_2007_pair = 1)

dim(no_crop_pairs)

no_crop_pairs <- unique(no_crop_pairs)
dim(no_crop_pairs)

border_df <- merge(x = border_df, y = no_crop_pairs, by = "pair_id", all.x = T)

border_df$no_cropland_2007_pair[is.na(border_df$no_cropland_2007_pair)] <- 0


# check for NAs in key vars ------------------------------------

# use sum(is.na(x))

NA_df <- NULL 

dim(border_df)

border_df_samp <- border_df %>% 
  filter(!is.na(aewr_region_border_id))

for (i in 1:length(names(border_df))) {
  temp_na_cnt <- sum(is.na(border_df[,i]))
  temp_varname <- paste0(names(border_df)[i])
  temp_na_cnt_samp <- sum(is.na(border_df_samp[,i]))
  
  temp <- data.frame(var = temp_varname, 
                     full_na_cnt = temp_na_cnt, 
                     border_samp_na_cnt = temp_na_cnt_samp)
  
  NA_df <- bind_rows(NA_df, temp)
  rm(temp, temp_na_cnt, temp_varname, temp_na_cnt_samp)
}

# easiest / most important to fix
fixcounty <- border_df %>% 
  filter(is.na(emp_tot) & !is.na(aewr_region_border_id))

fixcounty %>% 
  group_by(state_abbrev) %>% 
  tally() # BEA issue for VA counties. We need to drop bristol city. It will be ok. 

## lags of h2a variables


border_df <- border_df %>%
  arrange(county_unique_fe, year) %>%
  group_by(county_unique_fe) %>%
  mutate(nbr_workers_requested_all_years_l1  = lag( nbr_workers_requested_all_years, n = 1, order_by = county_unique_fe),
         nbr_workers_requested_all_years_l2   = lag( nbr_workers_requested_all_years, n = 2, order_by = county_unique_fe),
         nbr_workers_certified_all_years_l1  = lag(nbr_workers_certified_all_years , n = 1, order_by = county_unique_fe),
         nbr_workers_certified_all_years_l2  = lag(nbr_workers_certified_all_years , n = 2, order_by = county_unique_fe),
         man_hours_requested_all_years_l1  = lag(man_hours_requested_all_years , n = 1, order_by = county_unique_fe),
         man_hours_requested_all_years_l2  = lag(man_hours_requested_all_years , n = 2, order_by = county_unique_fe),
         man_hours_certified_all_years_l1  = lag(man_hours_certified_all_years , n = 1, order_by = county_unique_fe),
         man_hours_certified_all_years_l2  = lag(man_hours_certified_all_years , n = 2, order_by = county_unique_fe),
         nbr_applications_all_years_l1 = lag(nbr_applications_all_years , n = 1, order_by = county_unique_fe),
         nbr_applications_all_years_l2 = lag(nbr_applications_all_years , n = 2, order_by = county_unique_fe),
         nbr_workers_requested_start_year_l1  = lag(nbr_workers_requested_start_year , n = 1, order_by = county_unique_fe),
         nbr_workers_requested_start_year_l2  = lag(nbr_workers_requested_start_year , n = 2, order_by = county_unique_fe),
         nbr_workers_certified_start_year_l1  = lag(nbr_workers_certified_start_year , n = 1, order_by = county_unique_fe),
         nbr_workers_certified_start_year_l2  = lag(nbr_workers_certified_start_year , n = 2, order_by = county_unique_fe),
         man_hours_requested_start_year_l1  = lag(man_hours_requested_start_year , n = 1, order_by = county_unique_fe),
         man_hours_requested_start_year_l2  = lag(man_hours_requested_start_year , n = 2, order_by = county_unique_fe),
         man_hours_certified_start_year_l1  = lag(man_hours_certified_start_year , n = 1, order_by = county_unique_fe),
         man_hours_certified_start_year_l2  = lag(man_hours_certified_start_year , n = 2, order_by = county_unique_fe),
         nbr_applications_start_year_l1 = lag(nbr_applications_start_year , n = 1, order_by = county_unique_fe),
         nbr_applications_start_year_l2 = lag(nbr_applications_start_year , n = 2, order_by = county_unique_fe),
         nbr_workers_requested_fiscal_year_l1  = lag(nbr_workers_requested_fiscal_year , n = 1, order_by = county_unique_fe),
         nbr_workers_requested_fiscal_year_l2  = lag(nbr_workers_requested_fiscal_year , n = 2, order_by = county_unique_fe),
         nbr_workers_certified_fiscal_year_l1  = lag(nbr_workers_certified_fiscal_year , n = 1, order_by = county_unique_fe),
         nbr_workers_certified_fiscal_year_l2  = lag(nbr_workers_certified_fiscal_year , n = 2, order_by = county_unique_fe),
         man_hours_requested_fiscal_year_l1  = lag(man_hours_requested_fiscal_year , n = 1, order_by = county_unique_fe),
         man_hours_requested_fiscal_year_l2  = lag(man_hours_requested_fiscal_year , n = 2, order_by = county_unique_fe),
         man_hours_certified_fiscal_year_l1  = lag(man_hours_certified_fiscal_year , n = 1, order_by = county_unique_fe),
         man_hours_certified_fiscal_year_l2  = lag(man_hours_certified_fiscal_year , n = 2, order_by = county_unique_fe),
         nbr_applications_fiscal_year_l1 = lag(nbr_applications_fiscal_year , n = 1, order_by = county_unique_fe),
         nbr_applications_fiscal_year_l2 = lag(nbr_applications_fiscal_year , n = 2, order_by = county_unique_fe))


saveRDS(border_df, file = paste0(folder_data, "border_df_analysis_year.rds"))

## Remove files ## -------------------------------------------------------------

str_detect(ls(), "folder_")

objects <- data.frame(name = ls(), keep = str_detect(ls(), "folder_")) %>% 
  filter(keep == F)

rm(list = objects[,1])
gc()
rm(objects)

## Yearly Full County Dataset ------------------------------------------------

## ------- Full County ----------------------------------------------------------------------
## Yearly Dataset ## -----------------------------------------------------------
## -------- Full County -----------------------------------------------------------

## Load Data -------------------------------------------------------------------

# yearly versions #
aewr_data <- readRDS(paste0(folder_data, "aewr_data_year.rds"))
aewr_regions <- read.csv(file = paste0(folder_data, "aewr_regions.csv"), stringsAsFactors = F)
bea_caemp25n_data <- readRDS(paste0(folder_data, "bea_caemp25n_data_year.rds"))
bea_cainc45_data <- readRDS(paste0(folder_data, "bea_cainc45_data_year.rds"))
border_df <- readRDS(paste0(folder_data, "border_df_year.rds"))
fips_codes <- read.csv(file = paste0(folder_data, "fips_codes.csv"), stringsAsFactors = F)
h2a_data <- readRDS(paste0(folder_data, "h2a_data_year.rds"))
# nawspad_data
# oews_data
ppi_data <- read.csv(file = paste0(folder_data, "WPU01.csv"), stringsAsFactors = F)
state_border_pairs <- read.csv(file = paste0(folder_data, "state_border_pairs.csv"), stringsAsFactors = F)
border_counties_allmatches <- read.csv(file = paste0(folder_data, "border_counties_allmatches.csv"), stringsAsFactors = F)
census_of_agriculture_cropland <- readRDS(file = paste0(folder_data, "census_ag_cropland_year.rds"))

census_pop_ests <- readRDS(paste0(folder_data, "census_pop_ests_year.rds"))

census_of_agriculture_cropland_base <- readRDS(file = paste0(folder_data, "census_ag_cropland_2007_year.rds"))

# base for full county dataset 

county_df <- readRDS(paste0(folder_data, "county_df_year.rds"))

# CZ

cz_file_small <- readRDS(file = paste0(folder_data, "cz_file_2010_small.rds"))

head(county_df)
head(border_df) # this is the base, we will attache everything here.
head(state_border_pairs) # this is the base, we will attache everything here.
head(border_counties_allmatches) # this is the base, we will attache everything here.

county_df %>% group_by(year) %>% tally()

# merge in for each side:

# by state and year
head(aewr_data)

# by state
head(aewr_regions)

# merge for only one side

# by
# loop ?

# by county and census_period

head(bea_caemp25n_data)
head(bea_cainc45_data)
head(h2a_data)
head(census_pop_ests)

## a tad of prep ---------------------------------------------------------------

class(county_df$fipscounty) 

# make state fips 

county_df <- county_df %>% 
  mutate(statefips = floor(fipscounty/1000))

hist(county_df$statefips) # it worked! 

## both sides merge ----------------------------------------------------------

# fips first 

county_df <- merge(x = county_df, y = fips_codes, by.x = "statefips", by.y = "fips", all.x = T, all.y = F)

county_df <- county_df %>% 
  filter(statefips <= 56) # only states

# first side

names(aewr_data)

dim(county_df)

county_df <- merge(x = county_df, y = aewr_data, by = c("year", "state_abbrev"), all.x = T, all.y = F)

dim(county_df) # DC missing

head(county_df)
# no need to rename these

names(aewr_regions)
dim(county_df)

county_df <- merge(x = county_df, y = aewr_regions, by = c("state_abbrev"), all.x = T, all.y = F)

dim(county_df)

county_df <- county_df %>% 
  rename(countyfips = fipscounty)

datasets <- c( "bea_caemp25n_data", "bea_cainc45_data", "h2a_data", "census_pop_ests", "census_of_agriculture_cropland")

for (i in 1:length(datasets)) {
  print(paste0("Rep ", i))
  temp <- get(datasets[i])
  print(dim(county_df))
  print(dim(temp))
  county_df <- merge(x = county_df, y = temp,
                     by = c("year", "countyfips"),
                     all.x = T, all.y = F)
  rm(temp)
}
dim(county_df)
head(county_df)

# county only #

dim(census_of_agriculture_cropland_base)

county_df <- merge(x = county_df, y = census_of_agriculture_cropland_base, by = "countyfips", all.x = T, all.y = F)

county_df %>%
  group_by(year) %>%
  tally()

county_df %>%
  filter(year == 2008 & !is.na(cropland_acr_2007)) %>%
  count()

## Variable cleaning ## -----------------

# H2A NAs to zero

county_df$nbr_workers_requested_all_years[is.na(county_df$nbr_workers_requested_all_years)] <- 0
county_df$nbr_workers_certified_all_years[is.na(county_df$nbr_workers_certified_all_years)] <- 0
county_df$man_hours_requested_all_years[is.na(county_df$man_hours_requested_all_years)] <- 0
county_df$man_hours_certified_all_years[is.na(county_df$man_hours_certified_all_years)] <- 0
county_df$nbr_applications_all_years[is.na(county_df$nbr_applications_all_years)] <- 0

county_df$nbr_workers_requested_start_year[is.na(county_df$nbr_workers_requested_start_year)] <- 0
county_df$nbr_workers_certified_start_year[is.na(county_df$nbr_workers_certified_start_year)] <- 0
county_df$man_hours_requested_start_year[is.na(county_df$man_hours_requested_start_year)] <- 0
county_df$man_hours_certified_start_year[is.na(county_df$man_hours_certified_start_year)] <- 0
county_df$nbr_applications_start_year[is.na(county_df$nbr_applications_start_year)] <- 0

county_df$nbr_workers_requested_fiscal_year[is.na(county_df$nbr_workers_requested_fiscal_year)] <- 0
county_df$nbr_workers_certified_fiscal_year[is.na(county_df$nbr_workers_certified_fiscal_year)] <- 0
county_df$man_hours_requested_fiscal_year[is.na(county_df$man_hours_requested_fiscal_year)] <- 0
county_df$man_hours_certified_fiscal_year[is.na(county_df$man_hours_certified_fiscal_year)] <- 0
county_df$nbr_applications_fiscal_year[is.na(county_df$nbr_applications_fiscal_year)] <- 0

head(county_df)

# cropland zeros

county_df$cropland_acr[is.na(county_df$cropland_acr)] <- 0
county_df$cropland_acr_2007[is.na(county_df$cropland_acr_2007)] <- 0

# emp pop ratio

county_df <- county_df %>%
  mutate(emp_pop_ratio = emp_tot / pop_census)

# logs of some vars

county_df <- county_df %>%
  mutate(ln_aewr = log(aewr),
         ln_aewr_ppi = log(aewr_ppi),
         ln_aewr_l1 = log(aewr_l1),
         ln_aewr_ppi_l1 = log(aewr_ppi_l1),
         ln_aewr_l2 = log(aewr_l2),
         ln_aewr_ppi_l2 = log(aewr_ppi_l2),
         ln_emp_farm_propr = log(emp_farm_propr),
         ln_emp_farm = log(emp_farm),
         ln_emp_nonfarm = log(emp_nonfarm),
         ln_emp_privatenonfarm = log(emp_privatenonfarm),
         ln_pop_census = log(pop_census),
         ln_cropland_acr = log(cropland_acr),
         ln_cropland_acr_2007 = log(cropland_acr_2007),
         ln_nbr_workers_requested_start_years = log(nbr_workers_requested_start_year),
         ln_nbr_workers_requested_all_years = log(nbr_workers_requested_all_years),
         ln_nbr_applications_fiscal_year = log(nbr_applications_fiscal_year),
         ln1_nbr_workers_requested_start_years = log(nbr_workers_requested_start_year + 1),
         ln1_nbr_workers_requested_all_years = log(nbr_workers_requested_all_years + 1),
         ln1_nbr_applications_fiscal_year = log(nbr_applications_fiscal_year + 1))

# budget shares

county_df <- county_df %>%
  mutate(share_farm_laborexp_prodexp = farm_laborexpense / farm_prodexp,
         share_farm_crop_cashandinc = farm_cashcrops / farm_cashandinc,
         share_farm_animal_cashandinc = farm_cashanimal / farm_cashandinc,
         share_farm_govt_cashandinc = farm_govpayments / farm_cashandinc)

# H2A outcome variables

county_df <- county_df %>%
  mutate(h2a_req_share_farm_workers_start_year = nbr_workers_requested_start_year / emp_farm,
         h2a_cert_share_farm_workers_start_year = nbr_workers_certified_start_year / emp_farm) # add h2a apps per farm later

county_df$h2a_req_share_farm_workers_start_year[is.infinite(county_df$h2a_req_share_farm_workers_start_year)] <- NA
county_df$h2a_cert_share_farm_workers_start_year[is.infinite(county_df$h2a_cert_share_farm_workers_start_year)] <- NA

# add in CZs 

county_df <- merge(x = county_df, y = cz_file_small, by = "countyfips", all.x = T, all.y = F)

# fixed effects

# period

county_df$year_fe <- with(county_df, as.factor(year)) # treats counties in separate clusters as separate

# county

county_df$county_fe <- with(county_df, as.factor(countyfips)) # treats counties in separate clusters as separate

# state

county_df$state_fe <- with(county_df, as.factor(state_abbrev)) # treats counties in separate clusters as separate

# AEWR Region

county_df$aewr_region_fe <- with(county_df, as.factor(aewr_region_num)) # treats counties in separate clusters as separate

# cZ 
county_df$cz_fe <- with(county_df, as.factor(cz_out10)) # treats counties in separate clusters as separate


# CZ x time

county_df$cztime_fe <- with(county_df, interaction(as.factor(cz_out10),  year))

levels(county_df$cztime_fe) <- c(levels(county_df$cztime_fe),"0.0")

unique(county_df$year)

county_df$cztime_fe[county_df$year == 2008] <- "0.0" # first period is 0

# aewr region  x time

county_df$aewrregtime_fe <- with(county_df, interaction(as.factor(aewr_region_num),  year))

levels(county_df$aewrregtime_fe) <- c(levels(county_df$aewrregtime_fe),"0.0")

unique(county_df$year)

county_df$aewrregtime_fe[county_df$year == 2008] <- "0.0" # first period is 0


# sample restriction to counties with cropland ------------------------------------

# we want to drop counties with no cropland in 2007

county_df <- county_df %>%
  mutate(any_cropland_2007 = ifelse(cropland_acr_2007 != 0 & !is.na(cropland_acr_2007), 1, 0))

county_df %>%
  group_by(any_cropland_2007, year) %>%
  tally()

# remove HI, AK, and DC 

county_df <- county_df %>% 
  filter(!is.na(aewr) & !is.na(aewr_region_num))

# check for NAs in key vars ------------------------------------

# use sum(is.na(x))

NA_df <- NULL

dim(county_df)

for (i in 1:length(names(county_df))) {
  temp_na_cnt <- sum(is.na(county_df[,i]))
  temp_varname <- paste0(names(county_df)[i])


  temp <- data.frame(var = temp_varname,
                     full_na_cnt = temp_na_cnt)

  NA_df <- bind_rows(NA_df, temp)
  rm(temp, temp_na_cnt, temp_varname)
}

# easiest / most important to fix
fixcounty <- county_df %>%
  filter(is.na(pop_census))

fixcounty %>%
  group_by(state_abbrev) %>%
  tally() # BEA issue for VA counties. We need to drop bristol city. It will be ok.

## lags of h2a variables


county_df <- county_df %>%
  arrange(county_fe, year) %>%
  group_by(county_fe) %>%
  mutate(nbr_workers_requested_all_years_l1  = lag( nbr_workers_requested_all_years, n = 1, order_by = county_fe),
         nbr_workers_requested_all_years_l2   = lag( nbr_workers_requested_all_years, n = 2, order_by = county_fe),
         nbr_workers_certified_all_years_l1  = lag(nbr_workers_certified_all_years , n = 1, order_by = county_fe),
         nbr_workers_certified_all_years_l2  = lag(nbr_workers_certified_all_years , n = 2, order_by = county_fe),
         man_hours_requested_all_years_l1  = lag(man_hours_requested_all_years , n = 1, order_by = county_fe),
         man_hours_requested_all_years_l2  = lag(man_hours_requested_all_years , n = 2, order_by = county_fe),
         man_hours_certified_all_years_l1  = lag(man_hours_certified_all_years , n = 1, order_by = county_fe),
         man_hours_certified_all_years_l2  = lag(man_hours_certified_all_years , n = 2, order_by = county_fe),
         nbr_applications_all_years_l1 = lag(nbr_applications_all_years , n = 1, order_by = county_fe),
         nbr_applications_all_years_l2 = lag(nbr_applications_all_years , n = 2, order_by = county_fe),
         nbr_workers_requested_start_year_l1  = lag(nbr_workers_requested_start_year , n = 1, order_by = county_fe),
         nbr_workers_requested_start_year_l2  = lag(nbr_workers_requested_start_year , n = 2, order_by = county_fe),
         nbr_workers_certified_start_year_l1  = lag(nbr_workers_certified_start_year , n = 1, order_by = county_fe),
         nbr_workers_certified_start_year_l2  = lag(nbr_workers_certified_start_year , n = 2, order_by = county_fe),
         man_hours_requested_start_year_l1  = lag(man_hours_requested_start_year , n = 1, order_by = county_fe),
         man_hours_requested_start_year_l2  = lag(man_hours_requested_start_year , n = 2, order_by = county_fe),
         man_hours_certified_start_year_l1  = lag(man_hours_certified_start_year , n = 1, order_by = county_fe),
         man_hours_certified_start_year_l2  = lag(man_hours_certified_start_year , n = 2, order_by = county_fe),
         nbr_applications_start_year_l1 = lag(nbr_applications_start_year , n = 1, order_by = county_fe),
         nbr_applications_start_year_l2 = lag(nbr_applications_start_year , n = 2, order_by = county_fe),
         nbr_workers_requested_fiscal_year_l1  = lag(nbr_workers_requested_fiscal_year , n = 1, order_by = county_fe),
         nbr_workers_requested_fiscal_year_l2  = lag(nbr_workers_requested_fiscal_year , n = 2, order_by = county_fe),
         nbr_workers_certified_fiscal_year_l1  = lag(nbr_workers_certified_fiscal_year , n = 1, order_by = county_fe),
         nbr_workers_certified_fiscal_year_l2  = lag(nbr_workers_certified_fiscal_year , n = 2, order_by = county_fe),
         man_hours_requested_fiscal_year_l1  = lag(man_hours_requested_fiscal_year , n = 1, order_by = county_fe),
         man_hours_requested_fiscal_year_l2  = lag(man_hours_requested_fiscal_year , n = 2, order_by = county_fe),
         man_hours_certified_fiscal_year_l1  = lag(man_hours_certified_fiscal_year , n = 1, order_by = county_fe),
         man_hours_certified_fiscal_year_l2  = lag(man_hours_certified_fiscal_year , n = 2, order_by = county_fe),
         nbr_applications_fiscal_year_l1 = lag(nbr_applications_fiscal_year , n = 1, order_by = county_fe),
         nbr_applications_fiscal_year_l2 = lag(nbr_applications_fiscal_year , n = 2, order_by = county_fe))

# new variables 

names(county_df)

# cuts by 2008 h2a usage 

h2a_use_df <- county_df %>% 
  ungroup() %>% 
  filter(year == 2008)

dim(h2a_use_df)

hist(h2a_use_df$nbr_workers_requested_start_year)
summary(h2a_use_df$nbr_workers_requested_start_year)
summary(h2a_use_df$h2a_req_share_farm_workers_start_year)

# cut by count

count_cuts <- quantile(h2a_use_df$nbr_workers_requested_start_year, probs = c(.5, .66, .75))

# cut by share 

share_cuts <- quantile(h2a_use_df$h2a_req_share_farm_workers_start_year, probs = c(.5, .66, .75), na.rm = T)


h2a_use_df <- h2a_use_df %>% 
  mutate(high_h2a_count_50 = ifelse(nbr_workers_requested_start_year > count_cuts[1], 1, 0),
         high_h2a_count_66 = ifelse(nbr_workers_requested_start_year > count_cuts[2], 1, 0),
         high_h2a_count_75 = ifelse(nbr_workers_requested_start_year > count_cuts[3], 1, 0),
         high_h2a_share_50 = ifelse(h2a_req_share_farm_workers_start_year > share_cuts[1] & !is.na(h2a_req_share_farm_workers_start_year), 1, 0),
         high_h2a_share_66 = ifelse(h2a_req_share_farm_workers_start_year > share_cuts[2] & !is.na(h2a_req_share_farm_workers_start_year), 1, 0),
         high_h2a_share_75 = ifelse(h2a_req_share_farm_workers_start_year > share_cuts[3] & !is.na(h2a_req_share_farm_workers_start_year), 1, 0))

h2a_use_df %>% 
  group_by(high_h2a_count_50) %>% 
  tally()

h2a_use_df <- h2a_use_df %>% 
  select(countyfips, high_h2a_count_50, high_h2a_count_66, high_h2a_count_75, high_h2a_share_50, high_h2a_share_66, high_h2a_share_75)

head(h2a_use_df)

dim(h2a_use_df)

county_df <- merge(x = county_df, y = h2a_use_df, by = "countyfips", all.x = T, all.y = F)

names(county_df) #check
# year dummys

summary(county_df$year)

county_df <- county_df  %>% 
  mutate(yeardummy_2008 = ifelse(year == 2008, 1, 0),
         yeardummy_2009 = ifelse(year == 2009, 1, 0),
         yeardummy_2010 = ifelse(year == 2010, 1, 0),
         yeardummy_2011 = ifelse(year == 2011, 1, 0),
         yeardummy_2012 = ifelse(year == 2012, 1, 0),
         yeardummy_2013 = ifelse(year == 2013, 1, 0),
         yeardummy_2014 = ifelse(year == 2014, 1, 0),
         yeardummy_2015 = ifelse(year == 2015, 1, 0),
         yeardummy_2016 = ifelse(year == 2016, 1, 0),
         yeardummy_2017 = ifelse(year == 2017, 1, 0),
         yeardummy_2018 = ifelse(year == 2018, 1, 0),
         yeardummy_2019 = ifelse(year == 2019, 1, 0),
         yeardummy_2020 = ifelse(year == 2020, 1, 0),
         yeardummy_2021 = ifelse(year == 2021, 1, 0),
         yeardummy_2022 = ifelse(year == 2022, 1, 0))


# ID border CZs

cz_borders <- county_df %>% 
  group_by(cz_out10) %>% 
  summarise(AEWRregmin = min(aewr_region_num, na.rm = T),
            AEWRregmax = max(aewr_region_num, na.rm = T))

cz_borders <- cz_borders %>% 
  mutate(border_cz = ifelse(AEWRregmin != AEWRregmax, 1, 0))

cz_borders %>% group_by(border_cz) %>% tally()

county_df <- merge(x = county_df, y = cz_borders, by = "cz_out10", all.x = T, all.y = F)

names(county_df) #check


# pre post dummy 

county_df <- county_df %>% 
  mutate(postdummy = ifelse(year > 2012, 1, 0))

saveRDS(county_df, file = paste0(folder_data, "county_df_analysis_year.rds"))

## Remove files ## -------------------------------------------------------------

str_detect(ls(), "folder_")

objects <- data.frame(name = ls(), keep = str_detect(ls(), "folder_")) %>%
  filter(keep == F)

rm(list = objects[,1])
gc()
rm(objects)



--------------------------------------------------------------------------------

================================================================================
 FILE: H2A Clean and Load.R
================================================================================

## H2A: Load and clean datasets
## Phil Hoxie
## 1/11/24

## requires running master file first ##

## Two datasets, one by census period and one by year (calendar year)

## Fips Codes ------------------------------------------

fips_codes <- read.csv(file = paste0(folder_data, "fips_codes.csv"), stringsAsFactors = F)

## AEWR Regions ----------------------------------------

aewr_regions <- read.csv(file = paste0(folder_data, "aewr_regions.csv"), stringsAsFactors = F)

## Commuting Zones --------------------------------------

# source: https://sites.psu.edu/psucz/data/

cz_file <- read.csv(file = paste0(folder_data, "counties10-zqvz0r.csv"), stringsAsFactors = F)

cz_file <- cz_file %>% 
  rename(countyfips = FIPS,
         cz_out10 = OUT10)

saveRDS(cz_file, file = paste0(folder_data, "cz_file_2010.rds"))


cz_file_small <- cz_file %>% 
  select(countyfips, cz_out10) 
  
saveRDS(cz_file_small, file = paste0(folder_data, "cz_file_2010_small.rds"))


## PPI --------------------------------------------------
# Source: https://fred.stlouisfed.org/series/WPU01

ppi_data <- read.csv(file = paste0(folder_data, "WPU01.csv"), stringsAsFactors = F)

# average by year

ppi_data <- ppi_data %>% 
  mutate(year = as.numeric(substr(DATE, 1, 4)))

ppi_data <- ppi_data %>% 
  group_by(year) %>% 
  summarise(wpu01 = mean(WPU01))

# change base to 2012 

ppi_2012 <- ppi_data$wpu01[ppi_data$year == 2012]

ppi_data <- ppi_data %>% 
  mutate(ppi_2012 = wpu01 / ppi_2012)

ggplot(data = ppi_data, aes(y = ppi_2012, x = year))+
  geom_line()

ppi_data <- ppi_data %>% 
  select(year, ppi_2012)

saveRDS(ppi_data, file = paste0(folder_data, "ppi_2012.rds"))

## County Boundary ------------------------------------

# cleaned in the original stata file 
state_border_pairs <- read.csv(file = paste0(folder_data, "state_border_pairs.csv"), stringsAsFactors = F)
border_counties_allmatches <- read.csv(file = paste0(folder_data, "border_counties_allmatches.csv"), stringsAsFactors = F)

full_county_set <- read.csv(file = paste0(folder_data, "county_adjacency2010.csv"), stringsAsFactors = F)

## Census of Agriculture ------------------------------

census_of_agriculture <- read.csv(file = paste0(folder_data, "census_of_agriculture.csv"), stringsAsFactors = F)

# general cleaning #

census_of_agriculture <- census_of_agriculture %>% 
  select(-X) %>% 
  rename(val_str = value) %>% 
  mutate(value = as.numeric(str_replace_all(val_str, ",", "")))

head(census_of_agriculture)

ag_census_data_items <- census_of_agriculture %>% 
  group_by(commodity_desc) %>% 
  tally() 

# want: FARM OPERATIONS, AG LAND

census_of_agriculture_trim <- census_of_agriculture %>% 
  filter(commodity_desc == "FARM OPERATIONS" | commodity_desc == "AG LAND")

census_of_agriculture_trim_items <- census_of_agriculture_trim %>% 
  group_by(short_desc) %>% 
  tally() 

census_of_agriculture_trim <- census_of_agriculture_trim %>% 
  filter(short_desc == "AG LAND, CROPLAND - ACRES")

# fix fips 

census_of_agriculture_trim <- census_of_agriculture_trim %>% 
  mutate(countyfips = as.numeric(str_c(as.character(state_fips_code), 
                                       str_pad(as.character(county_code), width = 3, side = "left", pad = "0"))))

census_of_agriculture_trim <- census_of_agriculture_trim %>% 
  arrange(countyfips, year)

census_of_agriculture_trim <-census_of_agriculture_trim %>% 
  rename(census_period = year) %>% 
  mutate(label = "cropland_acr") %>% 
  select(census_period, countyfips, value, label) 

census_of_agriculture_trim <-census_of_agriculture_trim %>% 
  filter(!is.na(countyfips))

census_of_agriculture_cropland <-census_of_agriculture_trim %>% 
  pivot_wider(names_from = "label", values_from = "value")

head(census_of_agriculture_trim)

saveRDS(census_of_agriculture_cropland, file = paste0(folder_data, "census_ag_cropland.rds"))

rm(census_of_agriculture_trim)

census_of_agriculture_cropland_base <- census_of_agriculture_cropland %>% 
  filter(census_period == 2007) %>% 
  rename(cropland_acr_2007 = cropland_acr) %>% 
  select(-census_period)

saveRDS(census_of_agriculture_cropland_base, file = paste0(folder_data, "census_ag_cropland_2007.rds"))

rm(census_of_agriculture_cropland_base)

## H2A Data -------------------------------------------

# h2a_data <- read.csv(file = paste0(folder_data, "h2a.csv"), stringsAsFactors = F)
# 
# head(h2a_data)
# 
# h2a_data <- h2a_data %>% 
#   select(-X)
# 
# # census period 
# 
# h2a_data <- h2a_data %>% 
#   mutate(census_period = ifelse(year >= 2008 & year < 2012, 2012, 
#                                 ifelse(year >= 2012 & year < 2017, 2017, 
#                                        ifelse( year >= 2017 & year < 2022, 2022, NA))))
# 
# 
# # fix fips code 
# 
# h2a_data <- h2a_data %>% 
#   mutate(cnty_fips_string = str_pad(as.character(county_fips_code), width = 3, side = "left", pad = "0"),
#          st_fips_string = str_pad(as.character(state_fips_code), width = 2, side = "left", pad = "0"))
# 
# h2a_data <- h2a_data %>% 
#   mutate(countyfips = as.numeric(paste0(st_fips_string, cnty_fips_string)))
# 
# 
# # clean by dropping old codes # 
# 
# h2a_data <- h2a_data %>% 
#   filter(!is.na(census_period) & !is.na(county_fips_code)) %>% 
#   select(-cnty_fips_string, -st_fips_string, -state_fips_code, -county_fips_code)
# 
# # collapse by period, county (county and state fips)
# 
# h2a_data <- h2a_data %>% 
#   group_by(census_period, countyfips) %>% 
#   summarise(h2a_man_hours_certified = sum(h2a_man_hours_certified, na.rm = T), 
#             h2a_man_hours_requested = sum(h2a_man_hours_requested, na.rm = T), 
#             h2a_nbr_workers_certified = sum(h2a_nbr_workers_certified, na.rm = T), 
#             h2a_nbr_workers_requested = sum(h2a_nbr_workers_requested, na.rm = T), 
#             n_applications = sum(n_applications, na.rm = T))
# 
# 
# saveRDS(h2a_data, file = paste0(folder_data, "h2a_data.rds"))
# 
# # yearly, for TS 
# 
# h2a_data_ts <- read.csv(file = paste0(folder_data, "h2a.csv"), stringsAsFactors = F)
# h2a_data_ts <- h2a_data_ts %>% 
#   select(-X)
# 
# h2a_data_ts <- h2a_data_ts %>% 
#   group_by(case_year) %>% 
#   summarise(h2a_man_hours_certified = sum(h2a_man_hours_certified, na.rm = T), 
#             h2a_man_hours_requested = sum(h2a_man_hours_requested, na.rm = T), 
#             h2a_nbr_workers_certified = sum(h2a_nbr_workers_certified, na.rm = T), 
#             h2a_nbr_workers_requested = sum(h2a_nbr_workers_requested, na.rm = T), 
#             n_applications = sum(n_applications, na.rm = T))
# 
# saveRDS(h2a_data_ts, file = paste0(folder_data, "h2a_data_ts.rds"))

h2a_data <- read.csv(file = paste0(folder_data, "h2a_aggregated.csv"), stringsAsFactors = F)

head(h2a_data)

h2a_data <- h2a_data %>% 
  select(-X)

# census period 

h2a_data <- h2a_data %>% 
  mutate(census_period = ifelse(year >= 2008 & year < 2012, 2012, 
                                ifelse(year >= 2012 & year < 2017, 2017, 
                                       ifelse( year >= 2017 & year < 2022, 2022, NA))))


# fix fips code 

h2a_data <- h2a_data %>% 
  mutate(cnty_fips_string = str_pad(as.character(county_fips_code), width = 3, side = "left", pad = "0"),
         st_fips_string = str_pad(as.character(state_fips_code), width = 2, side = "left", pad = "0"))

h2a_data <- h2a_data %>% 
  mutate(countyfips = as.numeric(paste0(st_fips_string, cnty_fips_string)))


# clean by dropping old codes # 

h2a_data <- h2a_data %>% 
  filter(!is.na(census_period) & !is.na(county_fips_code)) %>% 
  select(-cnty_fips_string, -st_fips_string, -state_fips_code, -county_fips_code)

# collapse by period, county (county and state fips)

h2a_data <- h2a_data %>% 
  group_by(census_period, countyfips) %>% 
  summarise(nbr_workers_requested_all_years = sum(nbr_workers_requested_all_years, na.rm = T),
            nbr_workers_certified_all_years = sum(nbr_workers_certified_all_years, na.rm = T),
            man_hours_requested_all_years = sum(man_hours_requested_all_years, na.rm = T),
            man_hours_certified_all_years = sum(man_hours_certified_all_years, na.rm = T),
            nbr_applications_all_years = sum(nbr_applications_all_years, na.rm = T),
            nbr_workers_requested_start_year = sum(nbr_workers_requested_start_year, na.rm = T),
            nbr_workers_certified_start_year = sum(nbr_workers_certified_start_year, na.rm = T),
            man_hours_requested_start_year = sum(man_hours_requested_start_year, na.rm = T),
            man_hours_certified_start_year = sum(man_hours_certified_start_year, na.rm = T),
            nbr_applications_start_year = sum(nbr_applications_start_year, na.rm = T),
            nbr_workers_requested_fiscal_year = sum(nbr_workers_requested_fiscal_year, na.rm = T),
            nbr_workers_certified_fiscal_year = sum(nbr_workers_certified_fiscal_year, na.rm = T),
            man_hours_requested_fiscal_year = sum(man_hours_requested_fiscal_year, na.rm = T),
            man_hours_certified_fiscal_year = sum(man_hours_certified_fiscal_year, na.rm = T),
            nbr_applications_fiscal_year = sum(nbr_applications_fiscal_year, na.rm = T))


saveRDS(h2a_data, file = paste0(folder_data, "h2a_data.rds"))

# yearly, for TS 

h2a_data_ts <- read.csv(file = paste0(folder_data, "h2a_aggregated.csv"), stringsAsFactors = F)
h2a_data_ts <- h2a_data_ts %>% 
  select(-X)

h2a_data_ts <- h2a_data_ts %>% 
  group_by(year) %>% 
  summarise(h2a_man_hours_certified = sum(man_hours_certified_start_year, na.rm = T), 
            h2a_man_hours_requested = sum(man_hours_requested_start_year, na.rm = T), 
            h2a_nbr_workers_certified = sum(nbr_workers_certified_start_year, na.rm = T), 
            h2a_nbr_workers_requested = sum(nbr_workers_requested_start_year, na.rm = T), 
            n_applications = sum(nbr_applications_start_year, na.rm = T))


h2a_data_ts <- h2a_data_ts %>% 
  rename(case_year = year)

saveRDS(h2a_data_ts, file = paste0(folder_data, "h2a_data_ts.rds"))

## ACS & QCEW -------------------------------------------

acs_qcew_data <- read.csv(file = paste0(folder_data, "acs_qcew.csv"), stringsAsFactors = F)

acs_qcew_data <- acs_qcew_data %>% 
  select(-X)

names(acs_qcew_data)

# make some variables 
acs_qcew_data <- acs_qcew_data %>% 
  mutate(census_period = year, 
         acs_agemp_raw = acs_crop_emp + acs_animal_emp, 
         qcew_agemp_raw = qcew_crop_emp + qcew_animal_emp,
         acs_crop_emp_clean = ifelse(!is.na(acs_animal_emp) & !is.na(acs_crop_emp), acs_crop_emp,
                                     ifelse(!is.na(acs_animal_emp) & is.na(acs_crop_emp), 0, NA)),
         acs_animal_emp_clean = ifelse(!is.na(acs_animal_emp) & !is.na(acs_crop_emp), acs_animal_emp,
                                       ifelse(is.na(acs_animal_emp) & !is.na(acs_crop_emp), 0, NA)),
         qcew_crop_emp_clean = ifelse(!is.na(qcew_animal_emp) & !is.na(qcew_crop_emp), qcew_crop_emp,
                                      ifelse(!is.na(qcew_animal_emp) & is.na(qcew_crop_emp), 0, NA)),
         qcew_animal_emp_clean = ifelse(!is.na(qcew_animal_emp) & !is.na(qcew_crop_emp), qcew_animal_emp,
                                        ifelse(is.na(qcew_animal_emp) & !is.na(qcew_crop_emp), 0, NA)))
# make more variables, with the new variables 
acs_qcew_data <- acs_qcew_data %>% 
  mutate(empratio_crop_animal_acs = acs_crop_emp_clean / acs_animal_emp_clean, 
         empratio_crop_animal_qcew = qcew_crop_emp_clean / qcew_animal_emp_clean,
         ln_empratio_crop_animal_acs = log(acs_crop_emp_clean / acs_animal_emp_clean),
         ln_empratio_crop_animal_qcew = log(qcew_crop_emp_clean / qcew_animal_emp_clean),
         acs_agemp = acs_crop_emp_clean + acs_animal_emp_clean, 
         qcew_agemp = qcew_crop_emp_clean + qcew_animal_emp_clean)

acs_qcew_data %>% 
  group_by(year) %>% 
  tally()

acs_qcew_data <- acs_qcew_data %>% 
  mutate(countyfips = as.numeric(str_c(as.character(state_fips_code), 
                                     str_pad(as.character(county_fips_code), width = 3, side = "left", pad = "0"))))

acs_qcew_data <- acs_qcew_data %>% 
  select(-year, -state_fips_code, -county_fips_code)

saveRDS(acs_qcew_data, file = paste0(folder_data, "acs_qcew_data.rds"))

## NAWSPAD ---------------------------------------------
# state level data
nawspad_data <- read.csv(file = paste0(folder_data, "nawspad.csv"), stringsAsFactors = F)

nawspad_data %>% 
  group_by(crop_type) %>% 
  tally()


## OEWS ------------------------------------------------

oews_data <- read.csv(file = paste0(folder_data, "oews.csv"), stringsAsFactors = F)
# wages

## AEWR -------------------------------------------------

aewr_data <- read.csv(file = paste0(folder_data, "aewr.csv"), stringsAsFactors = F)

aewr_data <- aewr_data %>% 
  select(-X)

aewr_data <- merge(x = aewr_data, y = ppi_data, by = "year", all.x = T, all.y = F)

aewr_data <- aewr_data %>% 
  mutate(aewr_ppi = aewr / ppi_2012,
         census_period = ifelse(year > 2002 & year <= 2007, 2007, 
                                ifelse(year > 2007 & year <= 2012, 2012, 
                                       ifelse(year > 2012 & year <= 2017, 2017, 
                                              ifelse(year > 2017 & year <= 2022, 2022, NA)))))

aewr_data <- aewr_data %>% 
  filter(!is.na(census_period)) %>% 
  group_by(state_fips_code, census_period) %>% 
  summarise(aewr_ppi = mean(aewr_ppi, na.rm = T),
            aewr = mean(aewr, na.rm = T))

aewr_data <- merge(x = aewr_data, y = fips_codes, by.x = "state_fips_code", by.y = "fips", all.x = T, all.y = F)

aewr_data <- aewr_data %>% 
  select(aewr, aewr_ppi, census_period, state_abbrev)

saveRDS(aewr_data, file = paste0(folder_data, "aewr_data.rds"))

# Now I am deviating from the original stata file 

## BEA Data ---------------------------------------------

# job count data
bea_caemp25n_data <- read.csv(file = paste0(folder_data, "CAEMP25N/CAEMP25N__ALL_AREAS_2001_2022_trim.csv"), stringsAsFactors = F)
# save lines: 10 50 70 80 90

bea_caemp25n_data <- bea_caemp25n_data %>% 
  filter(LineCode == 10 | LineCode == 50 | LineCode == 70 | LineCode == 80 | LineCode == 90)

bea_caemp25n_data <- bea_caemp25n_data %>% 
  mutate(countyfips = as.numeric(str_trim(gsub("\"", "", GeoFIPS))), # remove qoutes
         category = ifelse(LineCode == 10, "emp_tot", 
                           ifelse(LineCode == 50, "emp_farm_propr", # farm proprietors
                                  ifelse(LineCode == 70, "emp_farm", 
                                         ifelse(LineCode == 80, "emp_nonfarm", 
                                                ifelse(LineCode == 90, "emp_privatenonfarm", 
                                                       NA))))))

bea_caemp25n_data <- bea_caemp25n_data %>% 
  select(9:32)

bea_caemp25n_data <- bea_caemp25n_data %>% # wow, that was easy
  pivot_longer(cols = starts_with("y"), names_to = "year", names_prefix = "y", values_to = "temp", values_drop_na = F)

bea_caemp25n_data <- bea_caemp25n_data %>% 
  mutate(emp = as.numeric(temp)) %>% 
  select(-temp)

# put into year - county rows, so, pivot again 

bea_caemp25n_data <- bea_caemp25n_data %>% # wow, that was easy
  pivot_wider(names_from = "category", values_from = "emp")

# collapse 

bea_caemp25n_data <- bea_caemp25n_data %>% 
  mutate(census_period = ifelse(year > 2002 & year <= 2007, 2007, 
                                ifelse(year > 2007 & year <= 2012, 2012, 
                                       ifelse(year > 2012 & year <= 2017, 2017, 
                                              ifelse(year > 2017 & year <= 2022, 2022, NA)))))

bea_caemp25n_data %>% 
  group_by(census_period) %>% 
  tally()

bea_caemp25n_data <- bea_caemp25n_data %>% 
  filter(!is.na(census_period)) %>% 
  group_by(census_period, countyfips) %>% 
  summarise(emp_tot = mean(emp_tot, na.rm = T),
            emp_farm_propr = mean(emp_farm_propr, na.rm = T),
            emp_farm = mean(emp_farm, na.rm = T),
            emp_nonfarm = mean(emp_nonfarm, na.rm = T),
            emp_privatenonfarm = mean(emp_privatenonfarm, na.rm = T))

# fix fips 
# from: https://www.economy.com/support/blog/getfile.asp?did=869A03D1-5D74-4376-A606-00A8C64DDB0B&fid=a18d6d4873834f749d42ded633850a5e.xlsx

bea_fips_xwalk <- read.csv(file = paste0(folder_data, "bea_fips_xwalk.csv"), stringsAsFactors = F)

county_list <- unique(select(full_county_set, fipscounty, countyname)) %>%  # all county fips and names
    mutate(indata = 1)

bea_fips_xwalk <- merge(x = bea_fips_xwalk, y = county_list, by.x = "realfips", by.y = "fipscounty", all.x = T, all.y = F)

# keep counties when conflict

bea_fips_xwalk <- bea_fips_xwalk %>% 
  filter(county == 1) %>% 
  select(realfips, beafips)

bea_caemp25n_data <- merge(x =  bea_caemp25n_data, y = bea_fips_xwalk, by.x = "countyfips", by.y = "beafips", all.x = T, all.y = F)

# fix fips 

bea_caemp25n_data <- bea_caemp25n_data %>% 
  rename(oldfips = countyfips) %>% 
  mutate(countyfips = ifelse(!is.na(realfips), realfips, oldfips))

bea_caemp25n_data <- bea_caemp25n_data %>% 
  select(-oldfips, -realfips)

saveRDS(bea_caemp25n_data, file = paste0(folder_data, "bea_caemp25n_data.rds"))

# farm finance
bea_cainc45_data <- read.csv(file = paste0(folder_data, "CAINC45/CAINC45__ALL_AREAS_1969_2022_trim.csv"), stringsAsFactors = F)
# save lines: 20 60 130 210 270 150

bea_cainc45_data <- bea_cainc45_data %>% 
  filter(LineCode == 20 | LineCode == 60 | LineCode == 130  | LineCode == 210 | LineCode == 270  | LineCode == 150)

bea_cainc45_data <- bea_cainc45_data %>% 
  mutate(countyfips = as.numeric(str_trim(gsub("\"", "", GeoFIPS))), # remove qoutes
         category = ifelse(LineCode == 60, "farm_cashcrops", # Cash receipts: Crops 
                           ifelse(LineCode == 20, "farm_cashanimal", #  Cash receipts: Livestock and products
                                  ifelse(LineCode == 130, "farm_govpayments", # Government payments
                                         ifelse(LineCode == 210, "farm_laborexpense", # Hired farm labor expenses
                                                ifelse(LineCode == 270, "farm_cashandinc", # cash receipts and other income
                                                       ifelse(LineCode == 150, "farm_prodexp", NA))))))) # Production expenses 

bea_cainc45_data %>% 
  group_by(category) %>% 
  tally()

names(bea_cainc45_data)

bea_cainc45_data <- bea_cainc45_data %>% 
  select(43:64) # be careful, this gets to be reall a lot of data. 

names(bea_cainc45_data)

bea_cainc45_data <- bea_cainc45_data %>% # wow, that was easy
  pivot_longer(cols = starts_with("y"), names_to = "year", 
               names_prefix = "y", values_to = "temp", 
               values_drop_na = T)

bea_cainc45_data <- bea_cainc45_data %>% 
  mutate(fin = as.numeric(temp)) %>% 
  select(-temp)

# put into year - county rows, so, pivot again 

bea_cainc45_data <- bea_cainc45_data %>% # wow, that was easy
  pivot_wider(names_from = "category", values_from = "fin")

# real 

bea_cainc45_data <- merge(bea_cainc45_data, ppi_data, by = "year", all.x = T, all.y = F)

bea_cainc45_data <- bea_cainc45_data %>% 
  mutate(farm_cashanimal_ppi = farm_cashanimal / ppi_2012,
         farm_cashcrops_ppi = farm_cashcrops / ppi_2012,
         farm_govpayments_ppi = farm_govpayments / ppi_2012,
         farm_prodexp_ppi = farm_prodexp / ppi_2012,
         farm_laborexpense_ppi = farm_laborexpense / ppi_2012,
         farm_cashandinc_ppi = farm_cashandinc / ppi_2012)

# collapse 

bea_cainc45_data <- bea_cainc45_data %>% 
  mutate(census_period = ifelse(year > 2002 & year <= 2007, 2007, 
                                ifelse(year > 2007 & year <= 2012, 2012, 
                                       ifelse(year > 2012 & year <= 2017, 2017, 
                                              ifelse(year > 2017 & year <= 2022, 2022, NA)))))

bea_cainc45_data %>% 
  group_by(census_period) %>% 
  tally()

names(bea_cainc45_data)

bea_cainc45_data <- bea_cainc45_data %>% 
  filter(!is.na(census_period)) %>% 
  group_by(census_period, countyfips) %>% 
  summarise(farm_cashanimal = mean(farm_cashanimal, na.rm = T),
            farm_cashcrops = mean(farm_cashcrops, na.rm = T),
            farm_govpayments = mean(farm_govpayments, na.rm = T),
            farm_prodexp = mean(farm_prodexp, na.rm = T),
            farm_laborexpense = mean(farm_laborexpense, na.rm = T),
            farm_cashandinc = mean(farm_cashandinc, na.rm = T),
            farm_cashanimal_ppi = mean(farm_cashanimal_ppi, na.rm = T),
            farm_cashcrops_ppi = mean(farm_cashcrops_ppi, na.rm = T),
            farm_govpayments_ppi = mean(farm_govpayments_ppi, na.rm = T),
            farm_prodexp_ppi = mean(farm_prodexp_ppi, na.rm = T),
            farm_laborexpense_ppi = mean(farm_laborexpense_ppi, na.rm = T),
            farm_cashandinc_ppi = mean(farm_cashandinc_ppi, na.rm = T))

bea_cainc45_data <- merge(x =  bea_cainc45_data, y = bea_fips_xwalk, by.x = "countyfips", by.y = "beafips", all.x = T, all.y = F)

# fix fips 

bea_cainc45_data <- bea_cainc45_data %>% 
  rename(oldfips = countyfips) %>% 
  mutate(countyfips = ifelse(!is.na(realfips), realfips, oldfips))

bea_cainc45_data <- bea_cainc45_data %>% 
  select(-oldfips, -realfips)

saveRDS(bea_cainc45_data, file = paste0(folder_data, "bea_cainc45_data.rds"))


## ACS Immigration imputation -----------------------------

acs_immigrant_imputed <- read.csv(file = paste0(folder_data, "acs_immigrant_imputed.csv"), stringsAsFactors = F)

acs_immigrant_imputed <- acs_immigrant_imputed %>% 
  select(-X)

# fix fips

acs_immigrant_imputed <- acs_immigrant_imputed %>% 
  mutate(countyfips = as.numeric(str_c(as.character(state_fips_code), 
                            str_pad(as.character(county_fips_code), width = 3, side = "left", pad = "0"))))

# make categories 

acs_immigrant_imputed <- acs_immigrant_imputed %>% 
  mutate(prime_cat = ifelse(prime_age == T, "p", "np"),
         sex_cat = ifelse(sex == "male", "m", "f"),
         im_cat = ifelse(immigrant_type == "documented_immigrant", "doc", 
                         ifelse(immigrant_type == "undocumented_immigrant", "undoc", "nat")))

acs_immigrant_imputed <- acs_immigrant_imputed %>% 
  mutate(category = str_c("pop_", sex_cat, "_", prime_cat, "_", im_cat))

# make wide

acs_immigrant_imputed <- acs_immigrant_imputed %>% 
  mutate(census_period = ifelse(year > 2002 & year <= 2007, 2007, 
                                ifelse(year > 2007 & year <= 2012, 2012, 
                                       ifelse(year > 2012 & year <= 2017, 2017, 
                                              ifelse(year > 2017 & year <= 2022, 2022, NA))))) %>% 
  select(census_period, pop, countyfips, category)

acs_immigrant_imputed <- acs_immigrant_imputed %>% 
  pivot_wider(names_from = "category", values_from = "pop")

# calc row totals
# total, prime aged, prime aged women, prime aged men, undocumented, prime aged undocumented 

acs_immigrant_imputed %>% 
  group_by(census_period) %>% 
  tally()

acs_immigrant_imputed[is.na(acs_immigrant_imputed)] <- 0

acs_immigrant_imputed <- acs_immigrant_imputed %>% 
  mutate(pop_total = pop_f_np_doc + pop_f_np_nat + pop_f_np_undoc + pop_f_p_doc + pop_f_p_nat + pop_f_p_undoc + pop_m_np_doc + pop_m_np_nat + pop_m_np_undoc + pop_m_p_doc + pop_m_p_nat + pop_m_p_undoc,
         pop_prime = pop_f_p_doc+ pop_f_p_nat + pop_f_p_undoc + pop_m_p_doc+ pop_m_p_nat + pop_m_p_undoc , 
         pop_prime_men = pop_m_p_doc + pop_m_p_nat + pop_m_p_undoc, 
         pop_prime_fem = pop_f_p_doc + pop_f_p_nat + pop_f_p_undoc , 
         pop_undoc = pop_f_np_undoc + pop_f_p_undoc + pop_m_np_undoc + pop_m_p_undoc, 
         pop_prime_undoc = pop_f_p_undoc + pop_m_p_undoc)

# calc shares 

acs_immigrant_imputed <- acs_immigrant_imputed %>% 
  mutate(share_undoc = pop_undoc / pop_total, 
         share_undoc_prime = pop_prime_undoc / pop_prime, 
         share_undoc_prime_men = pop_m_p_undoc / pop_prime_men)

saveRDS(acs_immigrant_imputed, file = paste0(folder_data, "acs_immigrant_imputed.rds"))

## County Pop estimates ---------------------------------
# documentation: https://www2.census.gov/programs-surveys/popest/technical-documentation/file-layouts/2000-2009/co-est2009-alldata.pdf

census_pop_2000 <- read.csv(paste0(folder_data, "co-est2009-alldata.csv"), stringsAsFactors = F) 
census_pop_2010 <- read.csv(paste0(folder_data, "co-est2019-alldata.csv"), stringsAsFactors = F) 
census_pop_2020 <- read.csv(paste0(folder_data, "co-est2022-alldata.csv"), stringsAsFactors = F) 

census_pop_2000 <- census_pop_2000 %>% 
  filter(SUMLEV == 50) %>% 
  select(STATE, COUNTY, 10:19)
census_pop_2010 <- census_pop_2010 %>% 
  filter(SUMLEV == 50) %>% 
  select(STATE, COUNTY, 10:19)
census_pop_2020 <- census_pop_2020 %>% 
  filter(SUMLEV == 50) %>% 
  select(STATE, COUNTY, 9:11)

head(census_pop_2000)
head(census_pop_2010)
head(census_pop_2020)

census_pop_ests <- merge(x = census_pop_2000, y = census_pop_2010, by = c("STATE", "COUNTY"), all = T)
census_pop_ests <- merge(x = census_pop_ests, y = census_pop_2020, by = c("STATE", "COUNTY"), all = T)

rm(census_pop_2000, census_pop_2010, census_pop_2020)

census_pop_ests <- census_pop_ests %>% 
  mutate(countyfips = as.numeric(str_c(as.character(STATE), 
                                       str_pad(as.character(COUNTY), width = 3, side = "left", pad = "0"))))

census_pop_ests <- census_pop_ests %>% 
  select(-STATE, -COUNTY)

census_pop_ests <- census_pop_ests %>% 
  pivot_longer(cols = starts_with("POPESTIMATE"), names_to = "year", names_prefix = "POPESTIMATE", values_to = "pop_census", values_drop_na = F)

census_pop_ests <- census_pop_ests %>% 
  mutate(census_period = ifelse(year > 2002 & year <= 2007, 2007, 
                              ifelse(year > 2007 & year <= 2012, 2012, 
                                     ifelse(year > 2012 & year <= 2017, 2017, 
                                            ifelse(year > 2017 & year <= 2022, 2022, NA))))) %>% 
  select(-year)

census_pop_ests <- census_pop_ests %>% 
  filter(!is.na(census_period)) %>% 
  group_by(census_period, countyfips) %>% 
  summarise(pop_census = mean(pop_census, na.rm = T))

head(census_pop_ests)

saveRDS(census_pop_ests, file = paste0(folder_data, "census_pop_ests.rds"))

## Border Pair Data ------------------------------------

## Add CZ to each side ## 

head(border_counties_allmatches)
head(cz_file_small)

cz_file_small <- cz_file_small %>% 
  rename(fipscounty = countyfips) # side 1

border_counties_allmatches <- merge(x = border_counties_allmatches, y = cz_file_small, by = "fipscounty", all.x = T, all.y = F)

border_counties_allmatches %>% 
  filter(is.na(cz_out10)) %>% 
  tally() # it worked


cz_file_small <- cz_file_small %>% 
  rename(fipsneighbor = fipscounty,
         cz_out10_neighbor = cz_out10) # side 2

border_counties_allmatches <- merge(x = border_counties_allmatches, y = cz_file_small, by = "fipsneighbor", all.x = T, all.y = F)

head(border_counties_allmatches)

# stack and add years 

head(border_counties_allmatches)

years <- c(2007, 2012, 2017, 2022)

border_df <- NULL

for (i in 1:length(years)) {
  temp <- border_counties_allmatches %>% 
    mutate(census_period = years[i])
  border_df <- bind_rows(border_df, temp)
  rm(temp)
}

head(border_df)

border_df %>% 
  group_by(census_period) %>% 
  tally()

saveRDS(border_df, file = paste0(folder_data, "border_df.rds"))

# remove files 

rm(census_of_agriculture, border_counties_allmatches, acs_immigrant_imputed, acs_qcew_data, aewr_data, aewr_regions, bea_caemp25n_data, bea_cainc45_data, border_df, fips_codes, h2a_data, nawspad_data, oews_data, ppi_data, state_border_pairs)
gc()

## _____________________________________________________________________________
## Year by Year version --------------------------------------------------------
## _____________________________________________________________________________


## Commuting Zones --------------------------------------

# source: https://sites.psu.edu/psucz/data/

cz_file <- read.csv(file = paste0(folder_data, "counties10-zqvz0r.csv"), stringsAsFactors = F)

cz_file <- cz_file %>% 
  rename(countyfips = FIPS,
         cz_out10 = OUT10)

saveRDS(cz_file, file = paste0(folder_data, "cz_file_2010.rds"))


cz_file_small <- cz_file %>% 
  select(countyfips, cz_out10) 

saveRDS(cz_file_small, file = paste0(folder_data, "cz_file_2010_small.rds"))

## Fips Codes ------------------------------------------

fips_codes <- read.csv(file = paste0(folder_data, "fips_codes.csv"), stringsAsFactors = F)

## AEWR Regions ----------------------------------------

aewr_regions <- read.csv(file = paste0(folder_data, "aewr_regions.csv"), stringsAsFactors = F)

## PPI --------------------------------------------------
# Source: https://fred.stlouisfed.org/series/WPU01

ppi_data <- readRDS(file = paste0(folder_data, "ppi_2012.rds"))

## County Boundary ------------------------------------

# cleaned in the original stata file 
state_border_pairs <- read.csv(file = paste0(folder_data, "state_border_pairs.csv"), stringsAsFactors = F)
border_counties_allmatches <- read.csv(file = paste0(folder_data, "border_counties_allmatches.csv"), stringsAsFactors = F)

full_county_set <- read.csv(file = paste0(folder_data, "county_adjacency2010.csv"), stringsAsFactors = F)

dim(state_border_pairs)
dim(border_counties_allmatches)
dim(full_county_set)

## Census of Agriculture ------------------------------

census_of_agriculture <- read.csv(file = paste0(folder_data, "census_of_agriculture.csv"), stringsAsFactors = F)

# general cleaning #

census_of_agriculture <- census_of_agriculture %>% 
  select(-X) %>% 
  rename(val_str = value) %>% 
  mutate(value = as.numeric(str_replace_all(val_str, ",", "")))

head(census_of_agriculture)

ag_census_data_items <- census_of_agriculture %>% 
  group_by(commodity_desc) %>% 
  tally() 

# want: FARM OPERATIONS, AG LAND

census_of_agriculture_trim <- census_of_agriculture %>% 
  filter(commodity_desc == "FARM OPERATIONS" | commodity_desc == "AG LAND")

census_of_agriculture_trim_items <- census_of_agriculture_trim %>% 
  group_by(short_desc) %>% 
  tally() 

census_of_agriculture_trim <- census_of_agriculture_trim %>% 
  filter(short_desc == "AG LAND, CROPLAND - ACRES")

# fix fips 

census_of_agriculture_trim <- census_of_agriculture_trim %>% 
  mutate(countyfips = as.numeric(str_c(as.character(state_fips_code), 
                                       str_pad(as.character(county_code), width = 3, side = "left", pad = "0"))))

census_of_agriculture_trim <- census_of_agriculture_trim %>% 
  arrange(countyfips, year)

census_of_agriculture_trim <-census_of_agriculture_trim %>% 
  mutate(label = "cropland_acr") %>% 
  select(year, countyfips, value, label) 

census_of_agriculture_trim <-census_of_agriculture_trim %>% 
  filter(!is.na(countyfips))

census_of_agriculture_cropland <-census_of_agriculture_trim %>% 
  pivot_wider(names_from = "label", values_from = "value")

head(census_of_agriculture_trim)

saveRDS(census_of_agriculture_cropland, file = paste0(folder_data, "census_ag_cropland_year.rds"))

rm(census_of_agriculture_trim)

census_of_agriculture_cropland_base <- census_of_agriculture_cropland %>% 
  filter(year == 2007) %>% 
  rename(cropland_acr_2007 = cropland_acr) %>% 
  select(-year)

saveRDS(census_of_agriculture_cropland_base, file = paste0(folder_data, "census_ag_cropland_2007_year.rds"))

rm(census_of_agriculture_cropland_base)

## H2A Data -------------------------------------------

h2a_data <- read.csv(file = paste0(folder_data, "h2a_aggregated.csv"), stringsAsFactors = F)

head(h2a_data)

h2a_data <- h2a_data %>% 
  select(-X)


# fix fips code 

h2a_data <- h2a_data %>% 
  mutate(cnty_fips_string = str_pad(as.character(county_fips_code), width = 3, side = "left", pad = "0"),
         st_fips_string = str_pad(as.character(state_fips_code), width = 2, side = "left", pad = "0"))

h2a_data <- h2a_data %>% 
  mutate(countyfips = as.numeric(paste0(st_fips_string, cnty_fips_string)))


# clean by dropping old codes # 

h2a_data <- h2a_data %>% 
  filter(year <= 2022 & year > 2007 & !is.na(county_fips_code)) %>% 
  select(-cnty_fips_string, -st_fips_string, -state_fips_code, -county_fips_code)

# collapse by period, county (county and state fips)

## Handle NAs? 

head(h2a_data)

saveRDS(h2a_data, file = paste0(folder_data, "h2a_data_year.rds"))


## AEWR -------------------------------------------------

aewr_data <- read.csv(file = paste0(folder_data, "aewr.csv"), stringsAsFactors = F)

aewr_data <- aewr_data %>% 
  select(-X)

aewr_data <- merge(x = aewr_data, y = ppi_data, by = "year", all.x = T, all.y = F)

aewr_data <- aewr_data %>% 
  mutate(aewr_ppi = aewr / ppi_2012)

aewr_data <- aewr_data %>% 
  arrange(state_fips_code, year) %>% 
  group_by(state_fips_code) %>% 
  mutate(aewr_ppi_l1 = lag(aewr_ppi, n = 1, order_by = state_fips_code),
         aewr_l1 = lag(aewr, n = 1, order_by = state_fips_code),
         aewr_ppi_l2 = lag(aewr_ppi, n = 2, order_by = state_fips_code),
         aewr_l2 = lag(aewr, n = 2, order_by = state_fips_code))

aewr_data <- aewr_data %>% 
  filter(year > 2007 & year <= 2022)

aewr_data <- merge(x = aewr_data, y = fips_codes, by.x = "state_fips_code", by.y = "fips", all.x = T, all.y = F)

aewr_data <- aewr_data %>% 
  select(aewr, aewr_ppi, aewr_l1, aewr_ppi_l1, aewr_l2, aewr_ppi_l2, year, state_abbrev)

head(aewr_data)

saveRDS(aewr_data, file = paste0(folder_data, "aewr_data_year.rds"))

# full for TS

# pre 1995 source (CRS): https://www.everycrsreport.com/files/20080326_RL32861_9a486634f79a5f9c680cc5ba021e579cc67210a5.pdf

aewr_pre_1995 <- read.csv(file = paste0(folder_data, "aewr_crs_1990_2008.csv"), stringsAsFactors = F)

aewr_pre_1995 <- aewr_pre_1995 %>% 
  pivot_longer(cols = starts_with("X"), names_to = "year", names_prefix = "X", values_to = "aewr", values_drop_na = F)

aewr_pre_1995 <- merge(x = aewr_pre_1995, y = fips_codes, by.x = "State", by.y = "state", all.x = T, all.y = F)

aewr_pre_1995 <- aewr_pre_1995 %>% 
  select(fips, year, aewr) %>% 
  rename(state_fips_code = fips) %>% 
  transform(year = as.numeric(year)) %>% 
  filter(year < 1995)

aewr_data <- read.csv(file = paste0(folder_data, "aewr.csv"), stringsAsFactors = F)

aewr_data <- aewr_data %>% 
  select(-X)

# append dataseries 

aewr_data <- bind_rows(aewr_data, aewr_pre_1995) %>% arrange(state_fips_code, year)

aewr_data %>% group_by(year) %>% tally()

aewr_data <- merge(x = aewr_data, y = ppi_data, by = "year", all.x = T, all.y = F)

aewr_data <- aewr_data %>% 
  mutate(aewr_ppi = aewr / ppi_2012)



aewr_data <- merge(x = aewr_data, y = fips_codes, by.x = "state_fips_code", by.y = "fips", all.x = T, all.y = F)


head(aewr_data)

# collapse by regions 

aewr_data <- merge(x = aewr_data, y = aewr_regions, by = "state_abbrev", all.x = T)

aewr_data <- aewr_data %>% 
  group_by(aewr_region_num, year) %>% 
  summarise(aewr = mean(aewr, na.rm = T), 
            aewr_ppi = mean(aewr_ppi, na.rm = T))

head(aewr_data)

# make TS variables #
aewr_data <- aewr_data %>% 
  arrange(aewr_region_num, year) %>% 
  group_by(aewr_region_num) %>% 
  mutate(aewr_ppi_l1 = lag(aewr_ppi, n = 1, order_by = aewr_region_num),
         aewr_l1 = lag(aewr, n = 1, order_by = aewr_region_num),
         aewr_ppi_l2 = lag(aewr_ppi, n = 2, order_by = aewr_region_num),
         aewr_l2 = lag(aewr, n = 2, order_by = aewr_region_num))

aewr_data <- aewr_data %>% 
  arrange(aewr_region_num, year) %>% 
  mutate(ch_aewr = aewr - aewr_l1, 
         ch_aewr_ppi = aewr_ppi - aewr_ppi_l1, 
         pch_aewr = (aewr - aewr_l1) / aewr_l1 , 
         pch_aewr_ppi = (aewr_ppi - aewr_ppi_l1) / aewr_ppi_l1)

head(aewr_data)

aewr_data <- aewr_data %>% 
  filter(!is.na(aewr_region_num))

saveRDS(aewr_data, file = paste0(folder_data, "aewr_data_full.rds"))

# leav one out averages 

loo_averages <- NULL

for (i in 1:17) {
  temp <- aewr_data %>% 
    filter(aewr_region_num  != i) %>%  # leave one out, so not the one we want
    group_by(year) %>% 
    summarise(loo_aewr = mean(aewr, na.rm = T), 
              loo_aewr_ppi = mean(aewr_ppi, na.rm = T), 
              aewr_region_num = i)
  loo_averages <- bind_rows(loo_averages, temp)
  rm(temp)
}

aewr_data <- merge(x = aewr_data, y = loo_averages, by = c("year", "aewr_region_num"), all.x = T)

aewr_data <- aewr_data %>% 
  arrange(year, aewr_region_num) %>% 
  mutate(aewr_diff = aewr - loo_aewr,
         aewr_ppi_diff = aewr_ppi - loo_aewr_ppi,
         ln_aewr = log(aewr),
         ln_aewr_l1 = log(aewr / aewr_l1))

head(aewr_data)

## AEWR Region TS --------------------------------------------------------------

for(i in 1:17){
  plot <- ggplot(data = subset(aewr_data, aewr_region_num == i), aes(x = year, y = ln_aewr))+
    geom_line()+
    labs(title = paste0("AEWR Region Number: ", i))+
    xlab("Log AEWR (nominal)")
  plot
  ggsave(filename = paste0(folder_output, "AEWR TS/ts_ln_aewr_nominal_", i, ".png"), plot, device = "png")
  rm(plot)
  
  plot <- ggplot(data = subset(aewr_data, aewr_region_num == i), aes(x = year, y = ln_aewr_l1))+
    geom_line()+
    labs(title = paste0("AEWR Region Number: ", i))+
    xlab("Log Change AEWR (nominal)")
  plot
  ggsave(filename = paste0(folder_output, "AEWR TS/ts_ln_aewr_l1_nominal_", i, ".png"), plot, device = "png")
  rm(plot)
}

for(i in 1:17){
  plot <- ggplot(data = subset(aewr_data, aewr_region_num == i), aes(x = year, y = aewr_diff))+
    geom_line()+
    labs(title = paste0("AEWR Region Number: ", i))+
    xlab("AEWR (nominal) difference from LOO trend")
  plot
  ggsave(filename = paste0(folder_output, "AEWR TS/ts_aewr_diffloo_nominal_", i, ".png"), plot, device = "png")
  rm(plot)
  
  plot <- ggplot(data = subset(aewr_data, aewr_region_num == i), aes(x = year, y = aewr_ppi_diff))+
    geom_line()+
    labs(title = paste0("AEWR Region Number: ", i))+
    xlab("AEWR (real) difference from LOO trend")
  plot
  ggsave(filename = paste0(folder_output, "AEWR TS/ts_aewr_diffloo_real_", i, ".png"), plot, device = "png")
  rm(plot)
}


for (i in 1:17) {
  plot <- ggplot(data = subset(aewr_data, aewr_region_num == i), aes(x = year, y = aewr))+
    geom_line()+
    labs(title = paste0("AEWR Region Number: ", i))+
    xlab("AEWR (nominal)")
  plot
  ggsave(filename = paste0(folder_output, "AEWR TS/ts_aewr_nominal_", i, ".png"), plot, device = "png")
  rm(plot)

  plot <- ggplot(data = subset(aewr_data, aewr_region_num == i), aes(x = year, y = aewr_ppi))+
    geom_line()+
    labs(title = paste0("AEWR Region Number: ", i))+
    xlab("AEWR (real)")
  plot
  ggsave(filename = paste0(folder_output, "AEWR TS/ts_aewr_real_", i, ".png"), plot, device = "png")
  rm(plot)

  plot <- ggplot(data = subset(aewr_data, aewr_region_num == i), aes(x = year, y = ch_aewr ))+
    geom_line()+
    labs(title = paste0("AEWR Region Number: ", i))+
    xlab("Change AEWR (nominal)")
  plot
  ggsave(filename = paste0(folder_output, "AEWR TS/ts_change_aewr_nominal_", i, ".png"), plot, device = "png")
  rm(plot)

  plot <- ggplot(data = subset(aewr_data, aewr_region_num == i), aes(x = year, y = ch_aewr_ppi ))+
    geom_line()+
    labs(title = paste0("AEWR Region Number: ", i))+
    xlab("Change AEWR (real)")
  plot

  ggsave(filename = paste0(folder_output, "AEWR TS/ts_change_aewr_real_", i, ".png"), plot, device = "png")
  rm(plot)

  plot <- ggplot(data = subset(aewr_data, aewr_region_num == i), aes(x = year, y = pch_aewr ))+
    geom_line()+
    labs(title = paste0("AEWR Region Number: ", i))+
    xlab("Percent Change AEWR (nominal)")
  plot
  ggsave(filename = paste0(folder_output, "AEWR TS/ts_percentchange_aewr_nominal_", i, ".png"), plot, device = "png")
  rm(plot)

  plot <- ggplot(data = subset(aewr_data, aewr_region_num == i), aes(x = year, y = pch_aewr_ppi ))+
    geom_line()+
    labs(title = paste0("AEWR Region Number: ", i))+
    xlab("Percent Change AEWR (real)")
  plot

  ggsave(filename = paste0(folder_output, "AEWR TS/ts_percentchange_aewr_real_", i, ".png"), plot, device = "png")
  rm(plot)
}

combo_plot <- ggplot(data = aewr_data, aes(x = year, y = pch_aewr, group = as.factor(aewr_region_num), color = as.factor(aewr_region_num)))+
  geom_line()+
  geom_vline(xintercept = 2007)
combo_plot



## BEA Data ---------------------------------------------

# job count data
bea_caemp25n_data <- read.csv(file = paste0(folder_data, "CAEMP25N/CAEMP25N__ALL_AREAS_2001_2022_trim.csv"), stringsAsFactors = F)
# save lines: 10 50 70 80 90

bea_caemp25n_data <- bea_caemp25n_data %>% 
  filter(LineCode == 10 | LineCode == 50 | LineCode == 70 | LineCode == 80 | LineCode == 90)

bea_caemp25n_data <- bea_caemp25n_data %>% 
  mutate(countyfips = as.numeric(str_trim(gsub("\"", "", GeoFIPS))), # remove qoutes
         category = ifelse(LineCode == 10, "emp_tot", 
                           ifelse(LineCode == 50, "emp_farm_propr", # farm proprietors
                                  ifelse(LineCode == 70, "emp_farm", 
                                         ifelse(LineCode == 80, "emp_nonfarm", 
                                                ifelse(LineCode == 90, "emp_privatenonfarm", 
                                                       NA))))))

bea_caemp25n_data <- bea_caemp25n_data %>% 
  select(9:32)

bea_caemp25n_data <- bea_caemp25n_data %>% # wow, that was easy
  pivot_longer(cols = starts_with("y"), names_to = "year", names_prefix = "y", values_to = "temp", values_drop_na = F)

bea_caemp25n_data <- bea_caemp25n_data %>% 
  mutate(emp = as.numeric(temp)) %>% 
  select(-temp)

# put into year - county rows, so, pivot again 

bea_caemp25n_data <- bea_caemp25n_data %>% # wow, that was easy
  pivot_wider(names_from = "category", values_from = "emp")

bea_caemp25n_data %>% 
  group_by(year) %>% 
  tally()

bea_caemp25n_data <- bea_caemp25n_data %>% 
  filter(year > 2007 & year <= 2022) 

# fix fips 
# from: https://www.economy.com/support/blog/getfile.asp?did=869A03D1-5D74-4376-A606-00A8C64DDB0B&fid=a18d6d4873834f749d42ded633850a5e.xlsx

bea_fips_xwalk <- read.csv(file = paste0(folder_data, "bea_fips_xwalk.csv"), stringsAsFactors = F)

county_list <- unique(select(full_county_set, fipscounty, countyname)) %>%  # all county fips and names
  mutate(indata = 1)

bea_fips_xwalk <- merge(x = bea_fips_xwalk, y = county_list, by.x = "realfips", by.y = "fipscounty", all.x = T, all.y = F)

# keep counties when conflict

bea_fips_xwalk <- bea_fips_xwalk %>% 
  filter(county == 1) %>% 
  select(realfips, beafips)

bea_caemp25n_data <- merge(x =  bea_caemp25n_data, y = bea_fips_xwalk, by.x = "countyfips", by.y = "beafips", all.x = T, all.y = F)

# fix fips 

bea_caemp25n_data <- bea_caemp25n_data %>% 
  rename(oldfips = countyfips) %>% 
  mutate(countyfips = ifelse(!is.na(realfips), realfips, oldfips))

bea_caemp25n_data <- bea_caemp25n_data %>% 
  select(-oldfips, -realfips)

head(bea_caemp25n_data)

saveRDS(bea_caemp25n_data, file = paste0(folder_data, "bea_caemp25n_data_year.rds"))

# farm finance
bea_cainc45_data <- read.csv(file = paste0(folder_data, "CAINC45/CAINC45__ALL_AREAS_1969_2022_trim.csv"), stringsAsFactors = F)
# save lines: 20 60 130 210 270 150

bea_cainc45_data <- bea_cainc45_data %>% 
  filter(LineCode == 20 | LineCode == 60 | LineCode == 130  | LineCode == 210 | LineCode == 270  | LineCode == 150)

bea_cainc45_data <- bea_cainc45_data %>% 
  mutate(countyfips = as.numeric(str_trim(gsub("\"", "", GeoFIPS))), # remove qoutes
         category = ifelse(LineCode == 60, "farm_cashcrops", # Cash receipts: Crops 
                           ifelse(LineCode == 20, "farm_cashanimal", #  Cash receipts: Livestock and products
                                  ifelse(LineCode == 130, "farm_govpayments", # Government payments
                                         ifelse(LineCode == 210, "farm_laborexpense", # Hired farm labor expenses
                                                ifelse(LineCode == 270, "farm_cashandinc", # cash receipts and other income
                                                       ifelse(LineCode == 150, "farm_prodexp", NA))))))) # Production expenses 

bea_cainc45_data %>% 
  group_by(category) %>% 
  tally()

names(bea_cainc45_data)

bea_cainc45_data <- bea_cainc45_data %>% 
  select(43:64) # be careful, this gets to be reall a lot of data. 

names(bea_cainc45_data)

bea_cainc45_data <- bea_cainc45_data %>% # wow, that was easy
  pivot_longer(cols = starts_with("y"), names_to = "year", 
               names_prefix = "y", values_to = "temp", 
               values_drop_na = T)

bea_cainc45_data <- bea_cainc45_data %>% 
  mutate(fin = as.numeric(temp)) %>% 
  select(-temp)

# put into year - county rows, so, pivot again 

bea_cainc45_data <- bea_cainc45_data %>% # wow, that was easy
  pivot_wider(names_from = "category", values_from = "fin")

# real 

bea_cainc45_data <- merge(bea_cainc45_data, ppi_data, by = "year", all.x = T, all.y = F)

bea_cainc45_data <- bea_cainc45_data %>% 
  mutate(farm_cashanimal_ppi = farm_cashanimal / ppi_2012,
         farm_cashcrops_ppi = farm_cashcrops / ppi_2012,
         farm_govpayments_ppi = farm_govpayments / ppi_2012,
         farm_prodexp_ppi = farm_prodexp / ppi_2012,
         farm_laborexpense_ppi = farm_laborexpense / ppi_2012,
         farm_cashandinc_ppi = farm_cashandinc / ppi_2012)

bea_cainc45_data %>% 
  group_by(year) %>% 
  tally()

names(bea_cainc45_data)

bea_cainc45_data <- bea_cainc45_data %>% 
  filter(year > 2007 & year <= 2022) 

bea_cainc45_data <- merge(x =  bea_cainc45_data, y = bea_fips_xwalk, by.x = "countyfips", by.y = "beafips", all.x = T, all.y = F)

# fix fips 

bea_cainc45_data <- bea_cainc45_data %>% 
  rename(oldfips = countyfips) %>% 
  mutate(countyfips = ifelse(!is.na(realfips), realfips, oldfips))

bea_cainc45_data <- bea_cainc45_data %>% 
  select(-oldfips, -realfips)

saveRDS(bea_cainc45_data, file = paste0(folder_data, "bea_cainc45_data_year.rds"))


## County Pop estimates ---------------------------------
# documentation: https://www2.census.gov/programs-surveys/popest/technical-documentation/file-layouts/2000-2009/co-est2009-alldata.pdf

census_pop_2000 <- read.csv(paste0(folder_data, "co-est2009-alldata.csv"), stringsAsFactors = F) 
census_pop_2010 <- read.csv(paste0(folder_data, "co-est2019-alldata.csv"), stringsAsFactors = F) 
census_pop_2020 <- read.csv(paste0(folder_data, "co-est2022-alldata.csv"), stringsAsFactors = F) 

ct_xwalk <- read.csv(paste0(paste0(folder_data, "ct_region_xwalk.csv")), stringsAsFactors = F)
ct_popgrth <- read.csv(paste0(paste0(folder_data, "ct_pop_grth.csv")), stringsAsFactors = F)

census_pop_2000 <- census_pop_2000 %>% 
  filter(SUMLEV == 50) %>% 
  select(STATE, COUNTY, 10:19)
census_pop_2010 <- census_pop_2010 %>% 
  filter(SUMLEV == 50) %>% 
  select(STATE, COUNTY, 10:19)
census_pop_2020 <- census_pop_2020 %>% 
  filter(SUMLEV == 50) %>% 
  select(STATE, COUNTY, 9:11)

head(census_pop_2000)
head(census_pop_2010)
head(census_pop_2020)

# fix CT county to region nonsense. 
# https://www.ctdata.org/blog/geographic-resources-for-connecticuts-new-county-equivalent-geography
# project using state growth rates

census_pop_ests <- merge(x = census_pop_2000, y = census_pop_2010, by = c("STATE", "COUNTY"), all = T)
census_pop_ests <- merge(x = census_pop_ests, y = census_pop_2020, by = c("STATE", "COUNTY"), all = T)

rm(census_pop_2000, census_pop_2010, census_pop_2020)

census_pop_ests <- census_pop_ests %>% 
  mutate(countyfips = as.numeric(str_c(as.character(STATE), 
                                       str_pad(as.character(COUNTY), width = 3, side = "left", pad = "0"))))

census_pop_ests <- census_pop_ests %>% 
  select(-STATE, -COUNTY)

census_pop_ests <- census_pop_ests %>% 
  pivot_longer(cols = starts_with("POPESTIMATE"), names_to = "year", names_prefix = "POPESTIMATE", values_to = "pop_census", values_drop_na = F)

census_pop_ests %>% 
  group_by(year) %>% 
  tally()

census_pop_ests <- census_pop_ests %>% 
  filter(year > 2007 & year <= 2022) 

head(census_pop_ests)

# fix CT

census_pop_ests <- census_pop_ests %>% 
  mutate(ct_region = ifelse(countyfips  >= 9000 & countyfips <= 9999 & year >= 2020, 1, 0)) # remove CT in 2020 on

ct_base <- census_pop_ests %>% 
  filter(countyfips  >= 9000 & countyfips <= 9999 & year==2019)

census_pop_ests <- census_pop_ests %>% 
  filter(ct_region == 0) %>% 
  select(-ct_region)

census_pop_ests <- census_pop_ests %>% 
  filter(countyfips < 9100 | countyfips > 9199) # get rid of the regions

ct_base <- ct_base %>% 
  filter(countyfips < 9100) %>% 
  select(countyfips, pop_census) %>% 
  mutate(pop_census2020 = pop_census * ct_popgrth[2,3],
         pop_census2021 = pop_census2020 * ct_popgrth[3,3],
         pop_census2022 = pop_census2021 * ct_popgrth[4,3])

ct_base <- ct_base %>% 
  select(-pop_census)

ct_fill <- ct_base %>% 
  pivot_longer(cols = starts_with("pop_census"), names_to = "year", names_prefix = "pop_census", values_to = "pop_census", values_drop_na = F)


census_pop_ests <- rbind(census_pop_ests, ct_fill)

# fix SD county change 

census_pop_ests$countyfips <-replace(census_pop_ests$countyfips, census_pop_ests$countyfips == 46102, 46113) 

census_pop_ests %>% filter(countyfips == 46111) %>% tally() # double

census_pop_ests <- census_pop_ests %>% 
  filter( !is.na(pop_census))

census_pop_ests %>% filter(countyfips == 46111) %>% tally() # fixed


saveRDS(census_pop_ests, file = paste0(folder_data, "census_pop_ests_year.rds"))

## Border Pair Data ------------------------------------

## Add CZ to each side ## 

head(border_counties_allmatches)
head(cz_file_small)

cz_file_small <- cz_file_small %>% 
  rename(fipscounty = countyfips) # side 1

border_counties_allmatches <- merge(x = border_counties_allmatches, y = cz_file_small, by = "fipscounty", all.x = T, all.y = F)

border_counties_allmatches %>% 
  filter(is.na(cz_out10)) %>% 
  tally() # it worked


cz_file_small <- cz_file_small %>% 
  rename(fipsneighbor = fipscounty,
         cz_out10_neighbor = cz_out10) # side 2

border_counties_allmatches <- merge(x = border_counties_allmatches, y = cz_file_small, by = "fipsneighbor", all.x = T, all.y = F)

head(border_counties_allmatches)

# stack and add years 

head(border_counties_allmatches)

years <- seq(2008, 2022)

border_df <- NULL

for (i in 1:length(years)) {
  temp <- border_counties_allmatches %>% 
    mutate(year = years[i])
  border_df <- bind_rows(border_df, temp)
  rm(temp)
}

head(border_df)

border_df %>% 
  group_by(year) %>% 
  tally()

saveRDS(border_df, file = paste0(folder_data, "border_df_year.rds"))

## all county sample ----------------------------------------------------------

head(full_county_set)

county_list_unique <- unique(select(full_county_set, fipscounty, countyname)) 

dim(county_list_unique)

years <- seq(2008, 2022)
county_df <- NULL

for (i in 1:length(years)) {
  temp <- county_list_unique %>% 
    mutate(year = years[i])
  county_df <- bind_rows(county_df, temp)
  rm(temp)
}

head(county_df)

county_df %>% 
  group_by(year) %>% 
  tally()

saveRDS(county_df, file = paste0(folder_data, "county_df_year.rds"))

# remove files -------------------

str_detect(ls(), "folder_")

objects <- data.frame(name = ls(), keep = str_detect(ls(), "folder_")) %>% 
  filter(keep == F)

rm(list = objects[,1])
gc()

--------------------------------------------------------------------------------

================================================================================
 FILE: H2A Clean and Load.do
================================================================================

** H2a: Load and Clean Datasets
** Hoxie
** 11/25/23

/*
Clean: 
Censu of Ag
H2A
OEWS
USDA_Surveys

*/

** AEWR Regions **

cd "$Data"
import delimited "aewr_regions.csv", clear

save aewr_regions, replace // state_abbrev

** PPI *************************************************************************
*Source: https://fred.stlouisfed.org/series/WPU01

cd "$Data"
import delimited "WPU01.csv", clear

split date, p(-)
gen year = real(date1)

collapse (mean) wpu01, by(year)

twoway line wpu01 year

gen wpu01_12 = wpu01 if year == 2012
egen b12_wpu01 = max(wpu01_12)

gen ppi_ag_b2012 = wpu01 / b12_wpu01

twoway line ppi_ag_b2012 year if year > 2002 & year <= 2022, ytitle("Producer Price Index, Farm Products (Base = 2012)") xtitle("Year") graphregion(fcolor(white)) xscale(range(2003 2022)) xlabel(2004 2008 2012 2016 2020)

cd "$Output"
graph export "fig_line_ppi_farmproducts_2012.png", replace as(png)

keep year ppi_ag_b2012

cd "$Data"
save ppi_ag, replace

** Raw H2A Data *****************************************************************
/*
cd "$Data"
import delimited "H2A Final Worksite County Data.csv", clear

* should be numbers: nbr_workers_requested nbr_workers_certified basic_number_of_hours basic_rate_of_pay
* postal codes: worksite_postal_code employer_postal_code
* dates are messed up


*duplicates tag , gen(dupobs)

* we want the
*/

** County Boundary *************************************************************

cd "$Data"
import delimited "county_adjacency2010.csv" , clear

split countyname, parse(,)

rename countyname2 state
drop countyname1

split neighborname, parse(,)

rename neighborname2 neighbor_state
drop neighborname1

gen xstate = 0 
replace xstate = 1 if neighbor_state != state

gen statefips = substr(string(fipscounty, "%05.0f"), 1, 2)
gen neighborstatefips = substr(string(fipsneighbor, "%05.0f"), 1, 2)

gen orderpair = ""
replace orderpair = "state first" if real(statefips) <= real(neighborstatefips)
replace orderpair = "neighbor first" if real(statefips) > real(neighborstatefips)

gen border_pair = ""
replace border_pair = strtrim(state) + "_" + strtrim(neighbor_state) if orderpair == "state first" & xstate == 1
replace border_pair = strtrim(neighbor_state) + "_" + strtrim(state) if orderpair == "neighbor first" & xstate == 1

keep if border_pair != "" // 1308 counties per year 

save border_counties_allmatches, replace
export delimited "border_counties_allmatches.csv", replace

drop if orderpair == "neighbor first"

gen samp_count = 1

sort border_pair

duplicates tag border_pair fipscounty, gen(dup_fipscounty)
duplicates tag border_pair fipsneighbor, gen(dup_fipsneighbor)

gen dup_county_sum = 0
replace dup_county_sum = dup_fipscounty / (1 + dup_fipscounty)

gen dup_neighbor_sum = 0
replace dup_neighbor_sum = dup_fipsneighbor / (1 + dup_fipsneighbor)

collapse (sum) samp_count dup_county_sum dup_neighbor_sum, by(border_pair)


gen unique_counties = samp_count - dup_county_sum
gen unique_neighbors = samp_count - dup_neighbor_sum

kdensity samp_count
kdensity unique_neighbors
kdensity unique_counties

gen unique_counts_tot = unique_counties + unique_neighbors

twoway kdensity samp_count, color(dknavy) legend(label(1 "Pairs")) || ///
	kdensity unique_counts_tot, color(maroon) lpattern("longdash") legend(label(2 "Counties")) ytitle("Density") xtitle("Observations within State Border Pair") graphregion(fcolor(white))

cd "$Output"
graph export "fig_dense_stateborder_samplecounts.png", replace as(png)

split border_pair, p(_)

rename border_pair1 stateabbrev_1
rename border_pair2 stateabbrev_2

keep border_pair samp_count stateabbrev_1 stateabbrev_2 unique_counts_tot

count 


cd "$Data"	
save state_border_pairs, replace
export delimited "state_border_pairs.csv", replace


** Cnesus of Ag ****************************************************************

cd "$Data"
use census_of_agriculture, clear
* COMMODITY TOTALS-ALL CLASSES, sales

* three years so far: 2007, 2012, 2017
* want a county-year level dataset

merge m:1 year using ppi_ag

keep if _merge == 3
drop _merge

rename year census_period

** h2a *************************************************************************

cd "$Data"
use h2a, clear

* FY 2006 to 2022 *

* create year bins *
count 

gen census_period = . 
replace census_period = 2007 if year == 2007
replace census_period = 2012 if year > 2007 & year <= 2012
replace census_period = 2017 if year > 2012 & year <= 2017

keep if census_period != .

sum h2a_man_hours_certified h2a_man_hours_requested h2a_nbr_workers_certified h2a_nbr_workers_requested n_applications

count 

collapse (sum) h2a_man_hours_certified h2a_man_hours_requested h2a_nbr_workers_certified h2a_nbr_workers_requested n_applications, by(census_period state_fips_code county_fips_code)

tab census_period

keep if county_fips_code != "" & state_fips_code != "72"

gen fipscounty = real(state_fips_code + county_fips_code)

drop state_fips_code county_fips_code

save h2a_censusperiod, replace // fipscounty (#)

** make a line graph ** 

cd "$Data"
use h2a, clear

collapse (sum) h2a_man_hours_certified h2a_man_hours_requested h2a_nbr_workers_certified h2a_nbr_workers_requested n_applications, by(year)

keep if year >= 2007 & year <= 2022

gen certgap_manhrs = h2a_man_hours_certified - h2a_man_hours_requested
gen certgap_workers = h2a_nbr_workers_certified - h2a_nbr_workers_requested

gen denial_rate_manhrs = ( h2a_man_hours_requested - h2a_man_hours_certified) / h2a_man_hours_requested 
gen denial_rate_workers = ( h2a_nbr_workers_requested - h2a_nbr_workers_certified) / h2a_nbr_workers_requested 

** idex ** 

global indexvars "h2a_man_hours_certified h2a_man_hours_requested h2a_nbr_workers_certified h2a_nbr_workers_requested n_applications"

sort year

foreach v in $indexvars {
	gen v07_`v' = `v' if year == 2007
	egen b07_`v' = max(v07_`v')
	gen indx07_`v' = `v' / b07_`v'
}

foreach v in $indexvars {
	gen v12_`v' = `v' if year == 2012
	egen b12_`v' = max(v12_`v')
	gen indx12_`v' = `v' / b12_`v'
}

foreach v in $indexvars {
	gen v14_`v' = `v' if year == 2014
	egen b14_`v' = max(v14_`v')
	gen indx14_`v' = `v' / b14_`v'
}

twoway line h2a_man_hours_certified year, xline(2007 2012 2017)
twoway line h2a_man_hours_requested year, xline(2007 2012 2017)
twoway line h2a_nbr_workers_certified year, xline(2007 2012 2017)
twoway line h2a_nbr_workers_requested year, xline(2007 2012 2017)
twoway line n_applications year, xline(2007 2012 2017)

twoway line certgap_manhrs year, xline(2007 2012 2017 2022)
twoway line certgap_workers year, xline(2007 2012 2017 2022)

twoway line denial_rate_manhrs year, xline(2007 2012 2017 2022)
twoway line denial_rate_workers year, xline(2007 2012 2017 2022)

* indexed graphs *

twoway line indx14_h2a_man_hours_certified year, color(dknavy) legend(label(1 "Certified")) || ///
	line indx14_h2a_man_hours_requested year, color(maroon) legend(label(2 "Requested"))

twoway line indx14_h2a_nbr_workers_certified year, color(dknavy) legend(label(1 "Certified")) || ///
	line indx14_h2a_nbr_workers_requested year, color(maroon) legend(label(2 "Requested"))

twoway line indx12_h2a_man_hours_certified year, color(dknavy) legend(label(1 "Man-Hours Certified")) || ///
	line indx12_h2a_nbr_workers_certified year, color(maroon) legend(label(2 "Workers Certified")) lpattern("longdash") ytitle("Indexed Values (2012 = 1)") xtitle("Year") xscale(range(2007 2022)) xlabel(2008 (2) 2022) ylabel(0 1 2 3 4 5 6) graphregion(fcolor(white))
	
twoway line indx12_h2a_man_hours_certified year if year > 2007 & year <= 2017, color(dknavy) legend(label(1 "Man-Hours Certified")) || ///
	line indx12_h2a_nbr_workers_certified year if year > 2007 & year <= 2017, color(maroon) legend(label(2 "Workers Certified")) lpattern("longdash") || /// 
	line indx12_n_applications year if year > 2007 & year <= 2017, color(teal) legend(label(3 "Number of Applications")) lpattern("shortdash") ytitle("Indexed Values (2012 = 1)") xtitle("Year") xscale(range(2008 2017)) xlabel(2008 (2) 2016) graphregion(fcolor(white)) xline(2012)

cd "$Output"
graph export "fig_line_h2a_certified_manhrs_workers_year.png", replace as(png)
	
** ACS & QCEW **************************************************************************

cd "$Data"
use acs_qcew, clear
* counts of workers 

gen census_period = year

gen acs_agemp = acs_crop_emp + acs_animal_emp

gen empratio_crop_animal_acs = acs_crop_emp / acs_animal_emp
gen empratio_crop_animal_qcew = qcew_crop_emp / qcew_animal_emp

corr empratio_crop_animal_acs empratio_crop_animal_qcew

gen ln_empratio_crop_animal_acs = log(empratio_crop_animal_acs)
gen ln_empratio_crop_animal_qcew = log(empratio_crop_animal_qcew)

binscatter ln_empratio_crop_animal_acs ln_empratio_crop_animal_qcew [aw = acs_agemp]

count if acs_crop_emp != . & acs_animal_emp == .
count if acs_animal_emp != . & acs_crop_emp == .

count if qcew_crop_emp != . & qcew_animal_emp == .
count if qcew_animal_emp != . & qcew_crop_emp == .

gen qcew_crop_emp_clean = qcew_crop_emp 
replace qcew_crop_emp_clean = 0 if qcew_animal_emp != . & qcew_crop_emp == . 

gen acs_crop_emp_clean = acs_crop_emp 
replace acs_crop_emp_clean = 0 if acs_animal_emp != . & acs_crop_emp == . 

gen qcew_animal_emp_clean = qcew_animal_emp 
replace qcew_animal_emp_clean = 0 if qcew_crop_emp != . & qcew_animal_emp == . 

gen acs_animal_emp_clean = acs_crop_emp 
replace acs_animal_emp_clean = 0 if acs_crop_emp != . & acs_animal_emp == . 

gen acs_agemp_clean = acs_crop_emp_clean + acs_animal_emp_clean

drop year

cd "$Data"
save acs_qcew_cleaned, replace // census period, state fips (01) county fips (001)
 
** nawspad **********************************************************************

cd "$Data"
use nawspad, clear

** OEWS *************************************************************************

cd "$Data"
use oews, clear



** AEWR ************************************************************************

cd "$Data"
use aewr, clear

global fixvars "year aewr"

foreach v in $fixvars {
	
	rename `v' `v'old
	gen `v' = real(`v'old)
	drop `v'old 

}

gen census_period = . 
replace census_period = 2007 if year > 2002 & year <= 2007 
replace census_period = 2012 if year > 2007 & year <= 2012 
replace census_period = 2017 if year > 2012 & year <= 2017 

keep if census_period != .

* real AEWR 

merge m:1 year using ppi_ag

keep if _merge == 3

drop _merge

gen aewr_ppi = aewr / ppi_ag

collapse (mean) aewr aewr_ppi, by(census_period state_fips_code)

gen fips = real(state_fips_code)

merge m:1 fips using fips_codes

keep if _merge == 3

drop _merge

save aewr_cleaned, replace // census_period state (state_abbrev)

keep  aewr aewr_ppi census_period state_abbrev

save aewr_merge, replace // census_period state (state_abbrev) , only the basincs


**********************************************************************************

** merge to make border county pair dataset (state level) **

cd "$Data"
use state_border_pairs, clear

gen census_period = 2007 

append using state_border_pairs

replace census_period = 2012 if census_period == . 

append using state_border_pairs

replace census_period = 2017 if census_period == . 

**

rename stateabbrev_1 state_abbrev

count 

merge m:1 census_period state_abbrev using aewr_cleaned

tab border_pair if _merge == 1 // only DC

tab state_abbrev if _merge == 2 // will match in other pair 

keep if _merge == 3
drop _merge

* aewr regions

merge m:1 state_abbrev using aewr_regions

keep if _merge == 3
drop _merge

rename aewr_region_num aewr_region_num_1
rename state_abbrev state_abbrev_1
rename state_fips_code state_fips_code_1
rename aewr aewr_1
rename aewr_ppi aewr_ppi_1
rename fips fips_1
rename state state_1

rename stateabbrev_2 state_abbrev

merge m:1 census_period state_abbrev using aewr_cleaned

tab border_pair if _merge == 1 // only DC

tab state_abbrev if _merge == 2 // will match in other pair 

keep if _merge == 3
drop _merge

merge m:1 state_abbrev using aewr_regions

keep if _merge == 3
drop _merge

rename aewr_region_num aewr_region_num_2

rename state_abbrev state_abbrev_2
rename state_fips_code state_fips_code_2
rename aewr aewr_2
rename fips fips_2
rename state state_2
rename aewr_ppi aewr_ppi_2

sort border_pair census_period
bysort border_pair: gen lag_aewr_1 = aewr_1[_n - 1]
bysort border_pair: gen lag_aewr_2 = aewr_2[_n - 1]
bysort border_pair: gen lag_aewr_ppi_1 = aewr_ppi_1[_n - 1]
bysort border_pair: gen lag_aewr_ppi_2 = aewr_ppi_2[_n - 1]

gen daewr = aewr_2 - aewr_1
gen daewr_ppi = aewr_ppi_2 - aewr_ppi_1

gen lag_daewr = lag_aewr_2 - lag_aewr_1
gen lag_daewr_ppi = lag_aewr_ppi_2 - lag_aewr_ppi_1

gen adaewr = abs(aewr_2 - aewr_1)
gen adaewr_ppi = abs(aewr_ppi_2 - aewr_ppi_1)



gen lag_adaewr = abs(lag_aewr_2 - lag_aewr_1)
gen lag_adaewr_ppi = abs(lag_aewr_ppi_2 - lag_aewr_ppi_1)

gen chang_daewr = daewr - lag_daewr
gen chang_daewr_ppi = daewr_ppi - lag_daewr_ppi

bysort border_pair: gen lag_chang_daewr = chang_daewr[_n - 1]
bysort border_pair: gen lag_chang_daewr_ppi = chang_daewr_ppi[_n - 1]

sort census_period daewr border_pair

gen aewr_region_diff = 0 
replace aewr_region_diff = 1 if aewr_region_num_1 != aewr_region_num_2

gen aewr_region_1_larger = . 
replace aewr_region_1_larger = 1 if aewr_region_num_1 > aewr_region_num_2
replace aewr_region_1_larger = 0 if aewr_region_num_1 < aewr_region_num_2

gen reg1 = string(aewr_region_num_1)
gen reg2 = string(aewr_region_num_2)

gen aewr_region_pair = ""
replace aewr_region_pair = reg1 + "_" + reg2 if aewr_region_1_larger == 0
replace aewr_region_pair = reg2 + "_" + reg1 if aewr_region_1_larger == 1

drop reg1 reg2 aewr_region_num_1 aewr_region_num_2 aewr_region_1_larger 

twoway kdensity adaewr if census_period == 2007 & aewr_region_diff == 1, color(dknavy) legend(label(1 "2007")) || ///
 kdensity adaewr if census_period == 2012 & aewr_region_diff == 1, color(maroon) legend(label(2 "2012")) lpattern("longdash") || /// 
 kdensity adaewr if census_period == 2017 & aewr_region_diff == 1, color(teal) legend(label(3 "2017")) lpattern("shortdash") ytitle("Density") xtitle("Absolute Difference in AEWR (Nominal USD)") graphregion(fcolor(white)) legend(rows(1))


cd "$Output"
graph export "fig_density_borderstatepairs_absdaewr.png", replace as(png)


twoway kdensity daewr if census_period == 2007 & aewr_region_diff == 1, color(dknavy) legend(label(1 "2007")) || ///
 kdensity daewr if census_period == 2012 & aewr_region_diff == 1, color(maroon) legend(label(2 "2012")) lpattern("longdash") || /// 
 kdensity daewr if census_period == 2017 & aewr_region_diff == 1, color(teal) legend(label(3 "2017")) lpattern("shortdash") ytitle("Density") xtitle("Absolute Difference in AEWR (Nominal USD)") graphregion(fcolor(white)) legend(rows(1)) xline(0)

cd "$Output"
graph export "fig_density_borderstatepairs_daewr.png", replace as(png)

	
twoway kdensity adaewr_ppi if census_period == 2007 & aewr_region_diff == 1, color(dknavy) legend(label(1 "2007")) || ///
 kdensity adaewr_ppi if census_period == 2012 & aewr_region_diff == 1, color(maroon) legend(label(2 "2012")) lpattern("longdash") || /// 
 kdensity adaewr_ppi if census_period == 2017 & aewr_region_diff == 1, color(teal) legend(label(3 "2017")) lpattern("shortdash") ytitle("Density") xtitle("Absolute Difference in AEWR (2012 USD)") graphregion(fcolor(white)) legend(rows(1))
 
cd "$Output"
graph export "fig_density_borderstatepairs_absdaewr_ppi2012.png", replace as(png)

twoway scatter daewr_ppi lag_daewr_ppi if census_period == 2012 & aewr_region_diff == 1, msymbol(Dh) color(navy%50) legend(label(1 "2012")) || ///
	scatter daewr_ppi lag_daewr_ppi if census_period == 2017 & aewr_region_diff == 1, msymbol(O) color(maroon%50) legend(label(2 "2017")) ytitle("Diff. in AEWR, Current Census Period (2012 USD)") xtitle("Diff. in AEWR, Previous Census Period (2012 USD)") graphregion(fcolor(white)) 
	cd "$Output"
graph export "fig_scat_daewr_ppi_lag_daewr_ppi.png", replace as(png)


twoway scatter adaewr_ppi lag_adaewr_ppi if census_period == 2012 & aewr_region_diff == 1, msymbol(Dh) color(navy%50) legend(label(1 "2012")) || ///
	scatter adaewr_ppi lag_adaewr_ppi if census_period == 2017 & aewr_region_diff == 1, msymbol(O) color(maroon%50) legend(label(2 "2017")) ytitle("Abs. Diff. in AEWR, Current Census Period (2012 USD)") xtitle("Abs. Diff. in  AEWR, Previous Census Period (2012 USD)") graphregion(fcolor(white)) 
	cd "$Output"
graph export "fig_scat_adaewr_ppi_lag_adaewr_ppi.png", replace as(png)

twoway scatter adaewr lag_adaewr if census_period == 2012 & aewr_region_diff == 1, msymbol(Dh) color(navy%50) legend(label(1 "2012")) || ///
	scatter adaewr lag_adaewr if census_period == 2017 & aewr_region_diff == 1, msymbol(O) color(maroon%50) legend(label(2 "2017")) ytitle("Abs. Diff. in AEWR, Current Census Period (Nominal USD)") xtitle("Abs. Diff. in  AEWR, Previous Census Period (Nominal USD)") graphregion(fcolor(white)) 
	cd "$Output"
graph export "fig_scat_adaewr_lag_adaewr.png", replace as(png)

twoway scatter daewr lag_daewr if census_period == 2012 & aewr_region_diff == 1, msymbol(Dh) color(navy%50) legend(label(1 "2012")) || ///
	scatter daewr lag_daewr if census_period == 2017 & aewr_region_diff == 1, msymbol(O) color(maroon%50) legend(label(2 "2017")) ytitle("Diff. in AEWR, Current Census Period (Nominal USD)") xtitle("Diff. in  AEWR, Previous Census Period (Nominal USD)") graphregion(fcolor(white)) xline(0) yline(0)
	cd "$Output"
graph export "fig_scat_daewr_lag_daewr.png", replace as(png)

reg adaewr_ppi lag_adaewr_ppi if census_period == 2012, robust
reg adaewr_ppi lag_adaewr_ppi if census_period == 2017, robust

reg daewr_ppi lag_daewr_ppi if census_period == 2012, robust 
reg daewr_ppi lag_daewr_ppi if census_period == 2017, robust

reg daewr lag_daewr if census_period == 2012 & lag_daewr_ppi != 0, robust 
reg daewr lag_daewr if census_period == 2017 & lag_daewr_ppi != 0, robust

reg daewr_ppi lag_daewr_ppi if census_period == 2012 & lag_daewr_ppi != 0, robust 
reg daewr_ppi lag_daewr_ppi if census_period == 2017 & lag_daewr_ppi != 0, robust

twoway kdensity chang_daewr_ppi if census_period == 2012 & aewr_region_diff == 1, color(dknavy) legend(label(1 "2007-2012")) || ///
 kdensity chang_daewr_ppi if census_period == 2017 & aewr_region_diff == 1, color(maroon) legend(label(2 "2012-2017")) lpattern("longdash") ytitle("Density") xtitle("Change in Diff. in AEWR (2012 USD)") graphregion(fcolor(white)) legend(rows(1))
 
cd "$Output"
graph export "fig_density_borderstatepairs_change_daewr_ppi2012.png", replace as(png)

twoway kdensity chang_daewr if census_period == 2012 & aewr_region_diff == 1, color(dknavy) legend(label(1 "2007-2012")) || ///
 kdensity chang_daewr if census_period == 2017 & aewr_region_diff == 1, color(maroon) legend(label(2 "2012-2017")) lpattern("longdash") ytitle("Density") xtitle("Change in Diff. in AEWR (Nominal USD)") graphregion(fcolor(white)) legend(rows(1))
 
cd "$Output"
graph export "fig_density_borderstatepairs_change_daewr.png", replace as(png)

scatter chang_daewr lag_chang_daewr if census_period == 2017 & aewr_region_diff == 1
reg chang_daewr lag_chang_daewr if census_period == 2017 & aewr_region_diff == 1, robust

keep aewr_region_pair aewr_region_diff census_period border_pair state_abbrev_1 aewr_1 aewr_ppi_1  lag_aewr_1 lag_aewr_ppi_1 state_abbrev_2  aewr_2 aewr_ppi_2  lag_aewr_2 lag_aewr_ppi_2 daewr daewr_ppi

** identify treatment and control states ** 

sort border_pair census_period

global treatvars "daewr"

foreach var in $treatvars { // Diffs are state2 - state1
	gen c07`var' = `var' if census_period == 2007
	gen c12`var' = `var' if census_period == 2012
	egen b07`var' = max(c07`var'), by(border_pair)
	egen b12`var' = max(c12`var'), by(border_pair)
	gen avg_b_`var' = (b07`var' + b12`var') / 2
	gen treat_`var'_b2007 = . // identifies high AEWR state in pair
	replace treat_`var'_b2007 = 2 if b07`var' > 0 
	replace treat_`var'_b2007 = 1 if b07`var' < 0 
	gen treat_`var'_b2012 = . // identifies high AEWR state in pair
	replace treat_`var'_b2012 = 2 if b12`var' > 0 
	replace treat_`var'_b2012 = 1 if b12`var' < 0 
	gen treat_`var'_avg = . // identifies high AEWR state in pair
	replace treat_`var'_avg = 2 if avg_b_`var' > 0 
	replace treat_`var'_avg = 1 if avg_b_`var' < 0 
}

sort border_pair census_period

* check dists: https://www.fb.org/market-intel/examining-the-2023-aewr

sum treat_*

tab treat_daewr_b2007 treat_daewr_b2012
tab treat_daewr_avg treat_daewr_b2012
tab treat_daewr_b2007 treat_daewr_avg

drop c07* c12*

** stable assignment ** 

gen treat_daewr_stable = . 
replace treat_daewr_stable = 1 if treat_daewr_b2007 == 1 & treat_daewr_b2012 == 1 & treat_daewr_avg == 1
replace treat_daewr_stable = 2 if treat_daewr_b2007 == 2 & treat_daewr_b2012 == 2 & treat_daewr_avg == 2

bysort census_period: tab treat_daewr_stable // 55 stable groups

keep aewr_region_pair aewr_region_diff census_period border_pair state_abbrev_1 state_abbrev_2 treat_*

cd "$Data"
save border_pair_treatmentassignment, replace // state_abbrev_1 census_period

** border pair / region diff **

keep if census_period == 2017 // doesn't matter the year

gen pair_count = 1

collapse (sum) pair_count, by(border_pair aewr_region_pair aewr_region_diff)

sort aewr_region_pair border_pair

keep aewr_region_pair border_pair

save border_pair_aewr_borders, replace

** US County Data from BEA *****************************************************

cd "$Data/CAEMP25N" // Employmebt
import delimited "CAEMP25N__ALL_AREAS_2001_2022_trim.csv", clear
* save farm employment, private non-farm, and total emp lines for each, make into long form dataset

* clean fips 

gen countyfips = real(subinstr(geofips, `"""', "",.))

drop geofips 
* 10 50 70 80 90

keep if linecode == 10 | linecode == 50 | linecode == 70 | linecode == 80 | linecode == 90

gen varname = ""
replace varname = "emp_tot" if linecode == 10
replace varname = "emp_farm_propr" if linecode == 50
replace varname = "emp_farm" if linecode == 70
replace varname = "emp_nonfarm" if linecode == 80
replace varname = "emp_privnonfarm" if linecode == 90

keep y* countyfips varname geoname

global fixvars "y2001 y2002 y2003 y2004 y2005 y2006 y2007 y2008 y2009 y2010 y2011 y2012 y2013 y2014 y2015 y2016 y2017 y2018 y2019 y2020 y2021 y2022"

foreach v in $fixvars {
	rename `v' old 
	gen `v' = real(old)
	drop old
}

** reshape ** 

reshape long y, i(countyfips geoname varname) j(year) s

rename y value

reshape wide value, i(countyfips geoname year) j(varname) s

rename year old
gen year = real(old)
drop old

global fixvars "emp_farm emp_farm_propr emp_nonfarm emp_privnonfarm emp_tot"

foreach v in $fixvars {
	rename value`v' `v'
}

rename countyfips fipscounty

gen census_period = . 
replace census_period = 2007 if year > 2002 & year <= 2007
replace census_period = 2012 if year > 2007 & year <= 2012
replace census_period = 2017 if year > 2012 & year <= 2017

keep if census_period != .

collapse (mean) emp_farm emp_farm_propr emp_nonfarm emp_privnonfarm emp_tot, by(fipscounty geoname census_period)


cd "$Data"
save bea_caemp25n_employment, replace

**** 

cd "$Data/CAINC45" // Farm Data
import delimited "CAINC45__ALL_AREAS_1969_2022_trim.csv", clear


* clean fips 

gen countyfips = real(subinstr(geofips, `"""', "",.))

drop geofips 
/*

line descr
60 Cash receipts: Crops
20 Cash receipts: Livestock and products
130 Government payments
210 Hired farm labor expenses
270 Cash receipts and other income
150 Production expenses
*/

keep if linecode == 60 | linecode == 20 | linecode == 130 | linecode == 210 | linecode == 270 | linecode == 150
tab description 

gen varname = ""
replace varname = "farm_cashcrops" if linecode == 60
replace varname = "farm_cashanimal" if linecode == 20
replace varname = "farm_govpayments" if linecode == 130
replace varname = "farm_laborexpense" if linecode == 210
replace varname = "farm_cashandinc" if linecode == 270
replace varname = "farm_prodexp" if linecode == 150

keep y* countyfips varname geoname region

global fixvars "y1969	y1970	y1971	y1972	y1973	y1974	y1975	y1976	y1977	y1978	y1979	y1980	y1981	y1982	y1983	y1984	y1985	y1986	y1987	y1988	y1989	y1990	y1991	y1992	y1993	y1994	y1995	y1996	y1997	y1998	y1999	y2000	y2001	y2002	y2003	y2004	y2005	y2006	y2007	y2008	y2009	y2010	y2011	y2012	y2013	y2014	y2015	y2016	y2017	y2018	y2019	y2020	y2021	y2022"

foreach v in $fixvars {
	rename `v' old 
	gen `v' = real(old)
	drop old
}

** reshape ** 

reshape long y, i(countyfips geoname region varname) j(year) s

rename y value

reshape wide value, i(countyfips geoname region year) j(varname) s

rename year old
gen year = real(old)
drop old

global fixvars "farm_cashandinc farm_cashanimal farm_cashcrops farm_govpayments farm_laborexpense farm_prodexp"

foreach v in $fixvars {
	rename value`v' `v'
}

rename countyfips fipscounty

gen census_period = . 
replace census_period = 2007 if year > 2002 & year <= 2007
replace census_period = 2012 if year > 2007 & year <= 2012
replace census_period = 2017 if year > 2012 & year <= 2017

keep if census_period != .

* real 

cd "$Data"
merge m:1 year using ppi_ag

keep if _merge == 3
drop _merge

foreach v in $fixvars {
	gen `v'ppi = `v' / ppi_ag_b2012
}

collapse (mean) farm_cashandinc farm_cashanimal farm_cashcrops farm_govpayments farm_laborexpense farm_prodexp farm_cashandincppi farm_cashanimalppi farm_cashcropsppi farm_govpaymentsppi farm_laborexpenseppi farm_prodexpppi, by(fipscounty geoname region census_period)

cd "$Data" // CAINC45
save bea_cainc45_farmexpenses, replace

** ACS Immigration Imputation ***************************************************

cd "$Data"
use acs_immigrant_imputed, clear

** reshape to wide ** 

gen prime_cat = "np"
replace prime_cat = "p" if prime_age == 1

gen imm_cat = "nat"
replace imm_cat = "doc" if immigrant_type == "documented_immigrant"
replace imm_cat = "undoc" if immigrant_type == "undocumented_immigrant"

gen obcat = "_" + sex + "_" + prime_cat + "_" + imm_cat

keep year obcat pop state_fips_code county_fips_code

reshape wide pop, i(year state_fips_code county_fips_code) j(obcat) s

keep if state_fips_code != ""

** Totals ** 

egen pop_tot = rowtotal(pop_female_np_doc pop_female_np_nat pop_female_np_undoc pop_female_p_doc pop_female_p_nat pop_female_p_undoc pop_male_np_doc pop_male_np_nat pop_male_np_undoc pop_male_p_doc pop_male_p_nat pop_male_p_undoc)

* prime aged

egen pop_prime = rowtotal(pop_female_p_doc pop_female_p_nat pop_female_p_undoc pop_male_p_doc pop_male_p_nat pop_male_p_undoc)

* prime aged men

egen pop_prime_m = rowtotal(pop_male_p_doc pop_male_p_nat pop_male_p_undoc)

* prime aged women 

egen pop_prime_f = rowtotal(pop_female_p_doc pop_female_p_nat pop_female_p_undoc)

* undocumented (all)

egen pop_undoc = rowtotal(pop_female_np_undoc pop_female_p_undoc pop_male_np_undoc pop_male_p_undoc)

* undocumented (prime aged)

egen pop_primeundoc = rowtotal( pop_female_p_undoc  pop_male_p_undoc)

gen share_pop_undoc_prime = pop_primeundoc / pop_prime

label variable share_pop_undoc_prime "ACS Share of prime age workers that are undocumented"

label variable pop_tot "ACS total pop"
label variable pop_prime "ACS prime age pop (25-64)"
label variable pop_undoc "ACS undocumented immigrant pop"
label variable pop_primeundoc "ACS prime age undocumented immigrant pop"

twoway kdensity share_pop_undoc_prime  if year == 2007 , color(dknavy) legend(label(1 "2007")) || ///
	kdensity share_pop_undoc_prime  if year == 2012, color(maroon) legend(label(2 "2012")) lpattern("longdash") || /// 
	kdensity share_pop_undoc_prime  if year == 2017, color(teal) legend(label(3 "2017")) lpattern("shortdash")   graphregion(fcolor(white)) ytitle("Density") xtitle("Share of prime age workers that are undocumented") legend(rows(1))
	
	cd "$Output"
graph export "fig_desnity_share_pop_undoc_prime_year.png", replace as(png)	

* Clean county fips *

gen fipscounty = real(state_fips_code + county_fips_code)

duplicates list fipscounty year

drop state_fips_code county_fips_code

rename year census_period

cd "$Data"
save acs_immigrant_cleaned, replace

--------------------------------------------------------------------------------

================================================================================
 FILE: H2A Master.R
================================================================================

## H2A Master Files ##
## Phil Hoxie ##
## January 11, 2024 ##

gc()
rm(list = ls())

## Master Paths ## -------------------------------------------------------------

# folder_dir <- "R:/Hoxie/H-2A Paper/"
# folder_do <- "R:/Hoxie/H-2A Paper/Do/"
# folder_data <- "R:/Hoxie/H-2A Paper/Data Int/"
# folder_output <- "R:/Hoxie/H-2A Paper/Output/"

folder_dir <- "C:/Users/churn_5stexhd/Dropbox/H-2A Paper/"
folder_do <- "C:/Users/churn_5stexhd/Dropbox/H-2A Paper/Do/"
folder_data <- "C:/Users/churn_5stexhd/Dropbox/H-2A Paper/Data Int/"
folder_output <- "C:/Users/churn_5stexhd/Dropbox/H-2A Paper/Output/"

## Packages ## -----------------------------------------------------------------

library(tidyverse)

## Run Sub Scripts -------------------------------------------------------------

## Load files from Ken 

source(paste0(folder_do, "Read Parquet.R"), echo = TRUE)

## Clean 

source(paste0(folder_do, "H2A Clean and Load.R"), echo = TRUE)

## Build Dataset 

source(paste0(folder_do, "H2A Build Dataset.R"), echo = TRUE)

## Analysis Figs and Tables 

## Census Year Level Dataset ##

source(paste0(folder_do, "H2A Analysis Figs and Tables.R"), echo = TRUE)

## Calendar Year Level Dataset ##




--------------------------------------------------------------------------------

================================================================================
 FILE: H2A Master.do
================================================================================

** H2A Project: Master File
** Philip Hoxie
** 11/21/23

/*

This file organizes the sub-master do files so the project can be easily re-run. 

*/

clear 
matrix drop _all
scalar drop _all
estimates drop _all

** Macros **

global Do "R:/Hoxie/H-2A Paper/Do"
global Data "R:/Hoxie/H-2A Paper/Data Int"
global Output "R:/Hoxie/H-2A Paper/Output"

** Load and Clean Data **

cd "$Do"
do "H2A Clean and Load.do" // Cleans and Loads data sets from unpacked binaries folder

** Merge **

cd "$Do"
do "H2A Merge.do" // Merges datasets together, makes major variables

** Pre-analysis cleaning **

** Analysis Files (no cleaning or new variables here) **

--------------------------------------------------------------------------------

================================================================================
 FILE: H2A Merge.do
================================================================================

** H2a: Merge
** Hoxie
** 11/25/23

** merge main dataset ** 

/*

Each county pair should show up twice. Once for each county in the pair

*/

cd "$Data"
use border_counties_allmatches, clear // this is the base layer

gen census_period = 2007

count 

append using border_counties_allmatches

replace census_period = 2012 if census_period == .

count 

append using border_counties_allmatches

replace census_period = 2017 if census_period == .

count 

** merge in border pair data ** 

gen state_abbrev = strtrim(state)
gen neighbor_abbrev = strtrim(neighbor_state)  

merge m:1 border_pair census_period using border_pair_treatmentassignment

tab border_pair if _merge != 3 // Just DC

keep if _merge == 3
drop _merge

** line up 1 and 2 w/ state, neighbor 

global treatvar "treat_daewr_b2007 treat_daewr_b2012 treat_daewr_avg treat_daewr_stable"

gen state_1_match = 0
replace state_1_match = 1 if state_abbrev == state_abbrev_1

foreach v in $treatvar {
	rename `v' old_`v' 
	gen `v' = . 
	replace `v' = 1 if state_1_match == 1 & old_`v' == 1
	replace `v' = 0 if state_1_match == 1 & old_`v' == 2
	replace `v' = 1 if state_1_match == 0 & old_`v' == 2
	replace `v' = 0 if state_1_match == 0 & old_`v' == 1
}

** merge in AEWRs ** 

drop state neighbor_state orderpair state_abbrev_1 state_abbrev_2 old_treat_daewr_b2007 old_treat_daewr_b2012 old_treat_daewr_avg old_treat_daewr_stable state_1_match xstate

merge m:1 state_abbrev census_period using aewr_merge

keep if _merge == 3 // HI missing
drop _merge

rename aewr state_aewr 
rename aewr_ppi state_aewr_ppi

rename state_abbrev temp // just for now

rename neighbor_abbrev state_abbrev

merge m:1 state_abbrev census_period using aewr_merge // this one is the neighbor aewr

keep if _merge == 3 // HI missing
drop _merge

rename state_abbrev neighbor_abbrev
rename temp state_abbrev
rename aewr aewr_neighbor 
rename aewr_ppi aewr_ppi_neighbor
rename state_aewr aewr
rename state_aewr_ppi aewr_ppi

sort border_pair census_period fipscounty fipsneighbor

** AEWR region for the original state ** 

merge m:1 state_abbrev using aewr_regions

keep if _merge == 3
drop _merge 

** H2A ** 

cd "$Data"
merge m:1 census_period fipscounty using h2a_censusperiod

keep if _merge != 2 // can't use these, interior counties
drop _merge

global h2afixvars "h2a_man_hours_certified h2a_man_hours_requested h2a_nbr_workers_certified h2a_nbr_workers_requested n_applications"

sum $h2afixvars

foreach v in $h2afixvars {
	replace `v' = 0 if `v' == . // replace NAs with 0s 
}

sum $h2afixvars

** ACS Controls ** 

cd "$Data"
merge m:1 census_period fipscounty using acs_immigrant_cleaned

tab fipscounty if _merge == 1 // 22087 46113 missing census years.. 

tab census_period if _merge == 2 // non-borders

gen panel_issue = 0 
replace panel_issue = 1 if _merge != 3

drop if _merge == 2

drop _merge

** regression vars ** 

* AEWR 

gen absdaewr = abs(aewr - aewr_neighbor)
gen absdaewr_ppi = abs(aewr_ppi - aewr_ppi_neighbor)

* 2007-2012 AER

sort fipscounty border_pair census_period

gen c07aewr = aewr if census_period == 2007
gen c12aewr = aewr if census_period == 2012

egen b07aewr = max(c07aewr), by(fipscounty)
egen b12aewr = max(c12aewr), by(fipscounty)

gen c07aewr_ppi = aewr_ppi if census_period == 2007
gen c12aewr_ppi = aewr_ppi if census_period == 2012

egen b07aewr_ppi = max(c07aewr_ppi), by(fipscounty)
egen b12aewr_ppi = max(c12aewr_ppi), by(fipscounty)

* diff 

gen c07absdaewr = absdaewr if census_period == 2007
gen c12absdaewr = absdaewr if census_period == 2012

egen b07absdaewr = max(c07absdaewr), by(fipscounty)
egen b12absdaewr = max(c12absdaewr), by(fipscounty)

gen c07absdaewr_ppi = absdaewr_ppi if census_period == 2007
gen c12absdaewr_ppi = absdaewr_ppi if census_period == 2012

egen b07absdaewr_ppi = max(c07aewr_ppi), by(fipscounty)
egen b12absdaewr_ppi = max(c12aewr_ppi), by(fipscounty)


drop c07* c12*

gen aewr_avg0712 = (b12aewr + b07aewr) / 2
gen aewr_ppi_avg0712 = (b12aewr_ppi + b07aewr_ppi) / 2

gen absdaewr_avg0712 = (b12absdaewr + b07absdaewr) / 2
gen absdaewr_ppi_avg0712 = (b12absdaewr_ppi + b07absdaewr_ppi) / 2

bysort census_period: sum aewr_avg0712 aewr_ppi_avg0712 // treatment

kdensity aewr_avg0712 if census_period == 2012
kdensity aewr_ppi_avg0712 if census_period == 2012

* post dummy
gen postdummy = 0 
replace postdummy = 1 if census_period > 2012
* interaction with treatment 
foreach v in $treatvar aewr_avg0712 aewr_ppi_avg0712 {
	gen `v'_aewr_ppi = `v' * absdaewr_ppi
	gen `v'_aewr = `v' * absdaewr
	
	gen p_`v' = postdummy * `v'
	gen p_`v'_aewrppi = postdummy * `v'_aewr_ppi
	gen p_`v'_aewr = postdummy * `v'_aewr
}


sum post* p_*

** county fe **

egen county_fe = group(fipscounty)

* state FE 

egen state_fe = group(state_abbrev)

* aewr FE: aewr_region_num

* time FEs 

egen time_fe = group(census_period)

* pair fe 

gen neighborfips_greater = 0 
replace neighborfips_greater = 1 if fipsneighbor > fipscounty

gen f1 = string(fipscounty)
gen f2 = string(fipsneighbor)

gen county_pair_id = ""
replace county_pair_id = f1 + "_" + f2 if neighborfips_greater == 0
replace county_pair_id = f2 + "_" + f1 if neighborfips_greater == 1

drop f1 f2 neighborfips_greater

egen pair_fe = group(county_pair_id)

** pair x year FE **

egen pair_year_fe = group(county_pair_id census_period)

** nice log vars **

global logvars "absdaewr_avg0712 absdaewr_ppi_avg0712 aewr_avg0712 aewr_ppi_avg0712 aewr aewr_ppi aewr_neighbor aewr_ppi_neighbor aewr_region_num h2a_man_hours_certified h2a_man_hours_requested h2a_nbr_workers_certified h2a_nbr_workers_requested n_applications  p_treat_daewr_b2007_aewrppi p_treat_daewr_b2007_aewr  p_treat_daewr_b2012_aewrppi p_treat_daewr_b2012_aewr  p_treat_daewr_avg_aewrppi p_treat_daewr_avg_aewr  p_treat_daewr_stable_aewrppi p_treat_daewr_stable_aewr p_aewr_avg0712 p_aewr_avg0712_aewrppi p_aewr_avg0712_aewr p_aewr_ppi_avg0712 p_aewr_ppi_avg0712_aewrppi p_aewr_ppi_avg0712_aewr pop_female_np_doc pop_female_np_nat pop_female_np_undoc pop_female_p_doc pop_female_p_nat pop_female_p_undoc pop_male_np_doc pop_male_np_nat pop_male_np_undoc pop_male_p_doc pop_male_p_nat pop_male_p_undoc pop_tot pop_prime pop_prime_m pop_prime_f pop_undoc pop_primeundoc share_pop_undoc_prime"

count 
foreach lv in $logvars {
	gen ln_`lv' = log(`lv')
	gen ln1_`lv' = log(`lv' + 1) // handle 0s 
}

sum ln_* ln1_*

gen postln_aewr_ppi_avg0712 = postdummy * ln_aewr_ppi_avg0712
gen postln_aewr_avg0712 = postdummy * ln_aewr_avg0712

gen posttreatln_aewr_ppi_avg0712 = postdummy * ln_aewr_ppi_avg0712 * treat_daewr_avg // NAs from internal Region Counties
gen posttreatln_aewr_avg0712 = postdummy * ln_aewr_avg0712 * treat_daewr_avg // NAs from internal Region Counties

gen posttreatln_absdaewr_ppi_avg0712 = postdummy * ln_absdaewr_ppi_avg0712 * treat_daewr_avg // NAs from internal Region Counties
gen posttreatln_absdaewr_avg0712 = postdummy * ln_absdaewr_avg0712 * treat_daewr_avg // NAs from internal Region Counties

tab aewr_region_diff // full sample : 4506

kdensity ln_aewr_avg0712
reg aewr aewr_avg0712 if census_period == 2017

** extensive margein 

gen any_h2a = 0 
replace any_h2a = 1 if n_applications > 0 

** Normal CI ** p_treat_daewr_avg

global controlvars "ln_pop_tot ln_share_pop_undoc_prime ln_pop_primeundoc"

* dummy * 

reghdfe n_applications p_treat_daewr_avg $controlvars if aewr_region_diff == 1 & census_period > 2007, absorb(i.county_fe i.pair_fe#postdummy) vce(robust)

reghdfe h2a_man_hours_requested p_treat_daewr_avg $controlvars if aewr_region_diff == 1 & census_period > 2007, absorb(i.county_fe i.pair_fe#postdummy) vce(robust)

reghdfe h2a_nbr_workers_requested p_treat_daewr_avg $controlvars if aewr_region_diff == 1 & census_period > 2007, absorb(i.county_fe i.pair_fe#postdummy) vce(robust)

reghdfe any_h2a p_treat_daewr_avg $controlvars if aewr_region_diff == 1 & census_period > 2007, absorb(i.county_fe i.pair_fe#postdummy) vce(robust)

reghdfe h2a_nbr_workers_requested aewr_ppi $controlvars if aewr_region_diff == 1 & census_period > 2007, absorb(i.county_fe i.pair_fe#postdummy) vce(robust)

reghdfe h2a_nbr_workers_requested aewr_ppi $controlvars if aewr_region_diff == 1 & census_period == 2012, absorb(i.pair_fe) vce(cluster aewr_region_pair)

reghdfe h2a_nbr_workers_requested aewr_ppi $controlvars if aewr_region_diff == 1 & census_period == 2017, absorb(i.pair_fe) vce(cluster aewr_region_pair)

reghdfe h2a_nbr_workers_requested aewr_ppi $controlvars if aewr_region_diff == 1 & census_period > 2007, absorb(i.county_fe i.pair_fe#postdummy) vce(cluster aewr_region_pair) // vce(robust)

/* 2 x 2
** do the 2 x 2 DiD by hand ** 

* target: 

reg ln_h2a_nbr_workers_requested p_treat_daewr_avg $controlvars i.time_fe i.pair_fe if aewr_region_diff == 1 & census_period > 2007, robust // -.43 = beta

reg ln_h2a_nbr_workers_requested p_treat_daewr_avg  i.time_fe i.pair_fe if aewr_region_diff == 1 & census_period > 2007, robust // -.43 = beta

** 

collapse (mean) ln_h2a_nbr_workers_requested if aewr_region_diff == 1 & census_period > 2007, by(census_period treat_daewr_avg)

twoway line ln_h2a_nbr_workers_requested census_period if treat_daewr_avg == 1,  legend(label( 1 "T")) || ///
line ln_h2a_nbr_workers_requested census_period if treat_daewr_avg == 0, legend(label( 2 "C")) yline(3.803389 3.359362)

di 3.803389 - 3.359362 // pre diff

di 4.207344 - 3.654376 // post diff

di (4.207344 - 3.654376) - (3.803389 - 3.359362) // DiD

*/
/* ** OLD 20240109 **
* Dummy 

reghdfe ln1_h2a_man_hours_requested p_treat_daewr_avg if aewr_region_diff == 1, absorb(i.time_fe i.county_fe) vce(cluster aewr_region_pair)

reghdfe ln1_h2a_nbr_workers_requested p_treat_daewr_avg if aewr_region_diff == 1, absorb(i.time_fe i.county_fe) vce(cluster aewr_region_pair)

reghdfe ln1_n_applications p_treat_daewr_avg if aewr_region_diff == 1, absorb(i.time_fe i.county_fe) vce(cluster aewr_region_pair)

* cts 

reghdfe ln1_h2a_man_hours_requested postln_aewr_ppi_avg0712 if aewr_region_diff == 1, absorb(i.time_fe i.county_fe) vce(cluster aewr_region_pair)

reghdfe ln1_h2a_nbr_workers_requested postln_aewr_ppi_avg0712 if aewr_region_diff == 1, absorb(i.time_fe i.county_fe) vce(cluster aewr_region_pair)

reghdfe ln1_n_applications postln_aewr_ppi_avg0712 if aewr_region_diff == 1, absorb(i.time_fe i.county_fe) vce(cluster aewr_region_pair)
/*

--------------------------------------------------------------------------------

================================================================================
 FILE: Read Parquet.R
================================================================================

## H2A: Read Parquet Files from Binaries 
## Phil Hoxie
## 11/21/2023
# library(tidyverse) # in master file 
library(arrow)
library(haven)
#library(sparklyr)

## requires running master file first ##

folder_binary <- paste0(folder_dir, "files_for_phil/")  
folder_dataint <-  paste0(folder_dir, "Data Int/")  

files <- list.files(path = folder_binary, all.files = T)

keep <- str_detect(files, ".parquet")

files <- as.data.frame(files)

files$keep <- keep

files <- files %>% 
  filter(keep == TRUE)

## Loop over files to read parquet files ##

for (i in 1:length(files$files)){
  df <- read_parquet(file = paste0(folder_binary, files$files[i]))
 # write_dta(df, path = paste0(folder_dataint, gsub(".parquet", "",files$files[i]),".dta" ))
  write.csv(df, file = paste0(folder_dataint, gsub(".parquet", "",files$files[i]),".csv" ))
  print(i/length(files$files))
  rm(df)
}

# gsub(".parquet", "",files$files[1]) 
# 
# length(files$files) ## this many iterations to handle 
# 
# # 1
# 
# df <- read_parquet(file = paste0(folder_binary, files$files[1]))
# names(df)[39] <- "CV_pct"
# 
# write_dta(df, path = paste0(folder_dataint, gsub(".parquet", "",files$files[1]),".dta" ))
# print(1/length(files$files))
# rm(df)
# 
# # 2
# 
# df <- read_parquet(file = paste0(folder_binary, files$files[2]))
# write_dta(df, path = paste0(folder_dataint, gsub(".parquet", "",files$files[2]),".dta" ))
# print(2/length(files$files))
# rm(df)
# 
# # 3
# 
# df <- read_parquet(file = paste0(folder_binary, files$files[3]))
# write_dta(df, path = paste0(folder_dataint, gsub(".parquet", "",files$files[3]),".dta" ))
# print(3/length(files$files))
# 
# # 4
# 
# df <- read_parquet(file = paste0(folder_binary, files$files[4]))
# write_dta(df, path = paste0(folder_dataint, gsub(".parquet", "",files$files[4]),".dta" ))
# print(4/length(files$files))
# 
# # 5
# 
# df <- read_parquet(file = paste0(folder_binary, files$files[5]))
# write_dta(df, path = paste0(folder_dataint, gsub(".parquet", "",files$files[5]),".dta" ))
# print(5/length(files$files))
# 
# # 6
# 
# df <- read_parquet(file = paste0(folder_binary, files$files[6]))
# write_dta(df, path = paste0(folder_dataint, gsub(".parquet", "",files$files[6]),".dta" ))
# print(6/length(files$files))
# 
# # 7
# 
# df <- read_parquet(file = paste0(folder_binary, files$files[7]))
# write_dta(df, path = paste0(folder_dataint, gsub(".parquet", "",files$files[7]),".dta" ))
# print(7/length(files$files))
# 
# # 8
# 
# df <- read_parquet(file = paste0(folder_binary, files$files[8]))
# names(df)
# names(df)[37] <- "CV_pct"
# write_dta(df, path = paste0(folder_dataint, gsub(".parquet", "",files$files[8]),".dta" ))
# print(8/length(files$files))

--------------------------------------------------------------------------------

================================================================================
 FILE: TSCB.R
================================================================================

## TSCB
## S/ource: https://academic.oup.com/qje/article/138/1/1/6750017
## 1/18/2024

folder <- "//acsnfs4.ucsd.edu/CifsHomes/147/phoxie/"

date <- gsub( "-", "", Sys.Date())

## packaged ------

library(fixest)

## Parameters -------

popsize <- 1502
samplesize <- 1502 # must be less than pop size, multiple of 2

clusterpop <- 32 # must be less than pop size 
clustersamp <- 32 # must be less than cluster pop 

pairs <- samplesize / 2

bootreps <- 999

years <- 3

true_beta <- 2 # beta

alpha <- 0 # intercept

sim_reps <- 1000 

simresults <- NULL # store data here

for (s in 1:sim_reps) {

## make dataframe of paired sample -------

pair_id <- seq(1, pairs)

border_side <- rep(seq(1,2), pairs)

allpairs <- c(pair_id, pair_id)

allpairs <- sort(allpairs)

clust_list <- seq(1, clustersamp)

clust_seq <- sort(sample(clust_list, size = pairs, replace = T))
hist(clust_seq)

clust <- sort(c(clust_seq, clust_seq))

clustdf <- data.frame(allpairs, border_side, clust)
dim(clustdf)

# add in years 

if(years > 1){ # only run if we have multiple years
  
  clustdfyear <- rbind(clustdf, clustdf) # add year 2
  
  # years var
  
  yearsvec <- sort(rep(seq(1, years), samplesize))
  
  if(years > 2){ # only run if we need to add more than 2 years
    
    for (t in 3:years){ # add additional years, one at a
      clustdfyear <- rbind(clustdfyear, clustdf)
      #print(t)
    }
    
  }
  
  # bind
  clustdfyear$year <- yearsvec
  
}
hist(clustdfyear$year)

# treatment 

clustdfyear$treat[clustdfyear$border_side == 1] <- 1
clustdfyear$treat[clustdfyear$border_side == 2] <- 0

# fixed effecs 

# unit 

units <- rep(seq(1, samplesize), years)
hist(units)

clustdfyear$unit <- units

# time -- already in 

# pair-time 

# dataframe to merge on pair-year

pairs_vec <- rep(allpairs, years)
# yearsvec already exists

pairfecount <- (years - 1) * pairs

pv <- seq(1, pairfecount)

pvc <- sort(c(pv, pv))

pairyearvec <- c(rep(0, samplesize), pvc)

pairfe_df <- data.frame(pairs_vec, yearsvec, pairyearvec)

names(pairfe_df) <- c("allpairs", "years", "pairtime_fe")

clustdfyear$pairyear_fe <- pairyearvec

## DGP -----------

# let's make some (fake) data 

# unit FE

unit_fe_vals <- rnorm(n = samplesize, mean = 0, sd = 1)
hist(unit_fe_vals)

unit_fe_vals_vec <- rep(unit_fe_vals, years)

clustdfyear$unitfeval <- unit_fe_vals_vec

# pair-time fe

pairtime_fe_val <- rep(rnorm(n = pairs*(years-1), mean = 0, 1), 2)

pairtime_fe_val_order <- rep(seq(1, (years-1)*pairs), 2)

pairtime_val_df <- data.frame(pairtime_fe_val, pairtime_fe_val_order)

zeros_vec <- rep(0, samplesize)

zeros_df <- data.frame(pairtime_fe_val = zeros_vec, pairtime_fe_val_order = zeros_vec)

pairtime_val_df <- pairtime_val_df[order(pairtime_val_df$pairtime_fe_val_order),]

pairtime_val_df <- rbind(zeros_df, pairtime_val_df)

clustdfyear$pairyear_fe_val <- pairtime_val_df$pairtime_fe_val

pairtime_fe_val <- c(zeros_vec, pairtime_fe_val)

# cluster treatment assignment 

cluster_list <- unique(clustdfyear$clust)
length(cluster_list)

clust_treat_df <- NULL

for (i in 1:years) {

  treat_temp <- rnorm(length(cluster_list), mean = 4, sd = 4) 
  temp_time <- rep(i, length(cluster_list))
  
  temp_treat <- data.frame(year = temp_time, clust = cluster_list, clust_treat = treat_temp)
  
  clust_treat_df <- rbind(clust_treat_df, temp_treat)
  
  rm(temp_treat)  
  
}

hist(clust_treat_df$clust_treat)

clustdfyear <- merge(x = clustdfyear, y = clust_treat_df, by = c("clust", "year"))

# Error 

error <- rnorm(dim(clustdfyear)[1], 0, 1) 

clustdfyear$error <- error

# Calculate Y using True Beta

# Y = a + b(treat) + C + PT + E

clustdfyear$outcome <- alpha + (clustdfyear$clust_treat * clustdfyear$treat * true_beta) + clustdfyear$unitfeval + clustdfyear$pairyear_fe_val + clustdfyear$error 

clustdfyear$treatcnts <- clustdfyear$clust_treat * clustdfyear$treat

## Basic Model ----------------------------------------------------------------------------------

# basic_model <- lm(outcome ~ treatcnts + factor(unit) + factor(pairyear_fe), data = clustdfyear)
# #summary(basic_model)
# basic_model$coefficients[2] # est of beta

# try with fixest 
fixest_model  <- feols(outcome ~ treatcnts | factor(unit) + factor(pairyear_fe), cluster = clustdfyear$clust, data = clustdfyear)
fixest_model$coeftable

fe_estimate_clustfe_est <- fixest_model$coeftable[1,1]
fe_estimate_clustfe_se <- fixest_model$coeftable[1,2]

# way faster

## Two-Staged Cluster Boot -------------------

# TSCB from Abadie, Athey, Imbens, Woodlridge, 2023, QJE. 

## stage 1 (paired sample makes this trivial)

# stage 1a, sample clusters with replacement 1/qk times, here, we have qk = 1. 

# stage 1b, calculate the assignment prob, W = 1/2 b/c sample is paired

# stage 1c, sample clusters (w/repl) from cluster pop w prob qk. This is trivially satisfied b/c qk = 1

# stage 1d, draw assignment prob from 1b, trivially satisfied since w = 1/2 always. 

## Stage 2

# 2a, sample with replacement Nkm*Akm treated units from cluster m 

# 2b, sample with replacement Nkm*(1-Akm) control units from cluster m 

# 2mod, sample with replacement Nkm*Akm pairs from cluster m

## clean up a bit --------------------------------------------------

# dfs
rm(clust_treat_df, clustdf, pairfe_df, pairtime_val_df, zeros_df)

## Bootstrap -------------------------------------------------------

# clustdfyear, this is our base datafram 
# bootreps, this is our number of reps 

input_data <- clustdfyear

# rename 
names(input_data)
names(input_data)[1] <- "cluster"
names(input_data)[2] <- "time"
names(input_data)[3] <- "pair"
names(input_data)[4] <- "side"
names(input_data)

periods <- unique(input_data$time) # grab the period variable

boot_treat_ests <- NULL # this is our storage vector 

# from main DF, get clusters and number of pairs per cluster 

cluster_list <- unique(input_data$cluster)

for (b in 1:bootreps) { # main boot loop starts
  

# for each cluster, sample pairs with replacement 

boot_clust_samp <- NULL # store the clustered sample here

cnt <- 1 # counter for boot sample id

for (i in 1:length(cluster_list)) {

  # get the unique list of pairs 
  
  temp_clust_df <- subset(input_data, cluster == cluster_list[i]) # iterate
  temp_pair_vec <- unique(temp_clust_df$pair)
  temp_clustpairsamp <- sample(temp_pair_vec, size = length(temp_pair_vec), replace = TRUE)
  temp_bootclustid <- seq(cnt, cnt + (length(temp_pair_vec)-1))
  
  temp_clust_df <- data.frame(pair = temp_clustpairsamp, cluster = cluster_list[i], boot_id = temp_bootclustid) # iterate
  
  boot_clust_samp <- rbind(boot_clust_samp, temp_clust_df)
  
  rm(temp_clust_df, temp_pair_vec, temp_clustpairsamp)

  cnt <- max(temp_bootclustid) + 1
  
  rm(temp_bootclustid)
  
 # print(i/length(cluster_list))
}

# use to make dataset for this bootstrap iteration

# match years 

temp <- boot_clust_samp

boot_clust_samp <- NULL 

for (i in 1:length(periods)) {
  temp$time <- periods[i]
  boot_clust_samp <- rbind(boot_clust_samp, temp)  
  temp <- subset(temp, select = -c(time)) # remove the column we added
 # print(i)
}

dim(boot_clust_samp)

# double and add treat / control indicator (or border side indicator, both would work)

# match w/ 1 and 2 designating the side

order_vec <- sort(rep(seq(1,2), dim(boot_clust_samp)[1]))

boot_samp_int <- rbind(boot_clust_samp, boot_clust_samp)

boot_samp_int$side <- order_vec

rm(boot_clust_samp)

# merge with data 

dim(boot_samp_int)
dim(input_data)

# make bootpair id (handles replacements) #

boot_samp_final <- merge(x = boot_samp_int, y = input_data, by = c("pair", "cluster", "time", "side"), all.x = T, all.y = F)
dim(boot_samp_final)

rm(boot_samp_int)

# fix the FEs # 

# units will be given by boot id and side

boot_samp_final$boot_unit_fe <- with(boot_samp_final, interaction(as.factor(boot_id),  side))

# then pairs are marked by boot id, and we will use time for the year dimension

boot_samp_final$boot_pairtime_fe <- with(boot_samp_final, interaction(as.factor(boot_id),  time))

levels(boot_samp_final$boot_pairtime_fe) <- c(levels(boot_samp_final$boot_pairtime_fe),"0.0") 

boot_samp_final$boot_pairtime_fe[boot_samp_final$time == 1] <- "0.0" # first period is 0

# run the model 

fixest_model  <- feols(outcome ~ treatcnts | factor(boot_unit_fe) + factor(boot_pairtime_fe), data = boot_samp_final)

boot_est <- fixest_model$coeftable[1,1]

boot_treat_ests <- c(boot_treat_ests, boot_est)

rm(boot_samp_final)

# print("### Boot Percent Complete ###")
# print(b / bootreps)

} # end boot loop

temp_mean <- mean(boot_treat_ests)
temp_med <- median(boot_treat_ests)
temp_sd <- sd(boot_treat_ests)
temp_p95 <- quantile(boot_treat_ests, 0.975)
temp_p05 <- quantile(boot_treat_ests, 0.025)

boot_data <- data.frame(rep = s, boot_mean = temp_mean, boot_median = temp_med, boot_sd = temp_sd, boot_p05 = temp_p05, boot_p95 = temp_p95, fe_est = fe_estimate_clustfe_est, fe_se = fe_estimate_clustfe_se)

simresults <- rbind(simresults, boot_data)

print("### Sim Percent Complete ###")
print(s / sim_reps)

rm(boot_data, clustdfyear, fixest_model, input_data)

} # end sim loop

write.csv(simresults, file = paste0(folder, "tscb_sim_results_", date, ".csv"))

## Graph Results ## 

library(tidyverse)

# simresults <- read.csv(file = paste0(folder, "tscb_sim_results_20240129.csv"))
simresults <- read.csv(file = paste0(folder_do, "tscb_sim_results_20240129.csv"))

simresults <- simresults %>% 
  mutate(confint = boot_p95 - boot_p05) # 90% interval

bootcomp <- ggplot(data = simresults)+
  geom_density(aes(x = boot_mean, color = "Boot mean"))+
  geom_density(aes(x = boot_median, color = "Boot median"))+
  geom_density(aes(x = fe_est, color = "Fixed Effects Estimator"))+
  scale_colour_manual(values=c("#003049", "#6e97b1", "#c1121f"), name = "")+
  xlab("Estimate")+
  theme_classic()
bootcomp

bootcomp_error <- ggplot(data = simresults)+
  geom_density(aes(x = boot_sd, color = "Boot sd"))+
  geom_density(aes(x = fe_se, color = "Fixed Effects Estimator SE"))+
  scale_colour_manual(values=c("#003049", "#c1121f"), name = "")+
  xlab("Error")+
  theme_classic()
bootcomp_error


## Boot Function -----------------------


# # clustdfyear, this is our base datafram 
# # bootreps, this is our number of reps 
# 
# input_data <- clustdfyear
# 
# head(input_data)
# 
# tscboot <- function(input_data, loc_cluster, loc_time, loc_pair, loc_borderside, outcome, treatcnts){
#   # inputs: a dataset, cluster variable location (a number), time variable location (a number), pair variable location (a number), and border side (1, 2)
# }
# 
# # rename 
# names(input_data)
# names(input_data)[1] <- "cluster"
# names(input_data)[2] <- "time"
# names(input_data)[3] <- "pair"
# names(input_data)[4] <- "side"
# names(input_data)
# 
# periods <- unique(input_data$time) # grab the period variable
# 
# boot_treat_ests <- NULL # this is our storage vector 
# 
# # from main DF, get clusters and number of pairs per cluster 
# 
# cluster_list <- unique(input_data$cluster)
# 
# for (b in 1:bootreps) { # main boot loop starts
#   
#   
#   # for each cluster, sample pairs with replacement 
#   
#   boot_clust_samp <- NULL # store the clustered sample here
#   
#   cnt <- 1 # counter for boot sample id
#   
#   for (i in 1:length(cluster_list)) {
#     
#     # get the unique list of pairs 
#     
#     temp_clust_df <- subset(input_data, cluster == cluster_list[i]) # iterate
#     temp_pair_vec <- unique(temp_clust_df$pair)
#     temp_clustpairsamp <- sample(temp_pair_vec, size = length(temp_pair_vec), replace = TRUE)
#     temp_bootclustid <- seq(cnt, cnt + (length(temp_pair_vec)-1))
#     
#     temp_clust_df <- data.frame(pair = temp_clustpairsamp, cluster = cluster_list[i], boot_id = temp_bootclustid) # iterate
#     
#     boot_clust_samp <- rbind(boot_clust_samp, temp_clust_df)
#     
#     rm(temp_clust_df, temp_pair_vec, temp_clustpairsamp)
#     
#     cnt <- max(temp_bootclustid) + 1
#     
#     rm(temp_bootclustid)
#     
#     # print(i/length(cluster_list))
#   }
#   
#   # use to make dataset for this bootstrap iteration
#   
#   # match years 
#   
#   temp <- boot_clust_samp
#   
#   boot_clust_samp <- NULL 
#   
#   for (i in 1:length(periods)) {
#     temp$time <- periods[i]
#     boot_clust_samp <- rbind(boot_clust_samp, temp)  
#     temp <- subset(temp, select = -c(time)) # remove the column we added
#     # print(i)
#   }
#   
#   dim(boot_clust_samp)
#   
#   # double and add treat / control indicator (or border side indicator, both would work)
#   
#   # match w/ 1 and 2 designating the side
#   
#   order_vec <- sort(rep(seq(1,2), dim(boot_clust_samp)[1]))
#   
#   boot_samp_int <- rbind(boot_clust_samp, boot_clust_samp)
#   
#   boot_samp_int$side <- order_vec
#   
#   rm(boot_clust_samp)
#   
#   # merge with data 
#   
#   dim(boot_samp_int)
#   dim(input_data)
#   
#   # make bootpair id (handles replacements) #
#   
#   boot_samp_final <- merge(x = boot_samp_int, y = input_data, by = c("pair", "cluster", "time", "side"), all.x = T, all.y = F)
#   dim(boot_samp_final)
#   
#   rm(boot_samp_int)
#   
#   # fix the FEs # 
#   
#   # units will be given by boot id and side
#   
#   boot_samp_final$boot_unit_fe <- with(boot_samp_final, interaction(as.factor(boot_id),  side))
#   
#   # then pairs are marked by boot id, and we will use time for the year dimension
#   
#   boot_samp_final$boot_pairtime_fe <- with(boot_samp_final, interaction(as.factor(boot_id),  time))
#   
#   levels(boot_samp_final$boot_pairtime_fe) <- c(levels(boot_samp_final$boot_pairtime_fe),"0.0") 
#   
#   boot_samp_final$boot_pairtime_fe[boot_samp_final$time == periods[1]] <- "0.0" # first period is 0
#   
#   # run the model 
#   
#   fixest_model  <- feols(outcome ~ treatcnts | factor(boot_unit_fe) + factor(boot_pairtime_fe), data = boot_samp_final)
#   
#   boot_est <- fixest_model$coeftable[1,1]
#   
#   boot_treat_ests <- c(boot_treat_ests, boot_est)
#   
#   rm(boot_samp_final)
#   
#   # print("### Boot Percent Complete ###")
#   # print(b / bootreps)
#   
# } # end boot loop



--------------------------------------------------------------------------------

